{% load humanize %}
{% load popvox_utils %}
{% block content %}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
    <head>
        <title>Bill Opinion Map - POPVOX</title> 

        <style>
            body {
                margin: 0;
                padding: 0;
                background-color: #E8E5DF;
            }
        </style> 
        <link rel="stylesheet" href="/media/master/reset.css" type="text/css" media="screen" />
        <link rel="stylesheet" href="/media/master/stylesheet.css" type="text/css" media="screen" /> 
        <link rel="stylesheet" href="/media/master/fonts.css" type="text/css" media="screen" /> 
        <script type="text/javascript" src="/media/js/jquery.js"></script>
        <script type="text/javascript" src="/media/js/highcharts.js"></script>
		<script type="text/javascript" src="/media/js/charts.js"></script>

</head>
    <script>
    var default_state;
    var default_district;
    var report_state = "";
    var report_district = "";
    var start = 0;
    var count = 50;

    function showdata(is_first_load, is_more) {
        
        isloading = true;

        $.ajax({
            type:"GET",
            url: "/ajax{{bill.url}}/report/getinfo",
            data: {
                state: report_state,
                district: report_district,
                start: (!is_more ? 0 : start),
                count: count
            },
            complete: function(res, status) {
                isloading = false;
                
                $('#loadingstatus').text("");
                $('#options_state, #options_district').prop('disabled', false);
                
                if (status != "success") {
                    $('#shortmessages').text("Error loading report.");
                    return;
                }
                
                if (report_state == default_state && report_district == default_district) {
                    $('#options_jump_nation').show();
                } else {
                    $('#options_jump_local').show();
                }
                
                res = eval('(' + res.responseText + ')');
                
                if (res.debug_info)
                    $('#debug_info').text(res.debug_info);
                
                $('#reporttitle').text(res.reporttitle);
                if (res.reportsubtitle == "") {
                    $('#reportsubtitle').fadeOut();
                } else {
                    $('#reportsubtitle').fadeIn();
                    $('#reportsubtitle').text(res.reportsubtitle);
                }

                function buildchart(stats, islast) {
                    $('#chart').show(); // must come before chart load so dimensions get set right
                
                    if (!islast) $('#chart').addClass("chart_notlast");
                    else $('#chart').removeClass("chart_notlast");

                    if (stats.total == 0) {
                        $('#chart').addClass("no_pie");
                        $('#chart' + " .past_stats").hide();
                        $('#chart' + ' .pro_reintro').show();
                        $('#chart' + ' .pro_reintro').text(stats.pro_reintro + " individuals in " + stats.longdescription + " support reintroduction of the bill.");
                        return;
                    } else {
                        $('#chart').removeClass("no_pie");
                        $('#chart' + " .past_stats").show();
                    }
                    
                    $('#chart' + " .chart_title").text(stats.longdescription);
                    $('#chart' + " .users").text("(" + stats.total + " people)");
                    $('#chart' + " .bg_support").text(stats.pro_pct + "% Support");
                    $('#chart' + " .bg_oppose").text(stats.con_pct + "% Oppose");
                   
                    if (stats.pro_reintro == 0) {
                        $('#chart' + ' .pro_reintro').hide();
                    } else {
                        $('#chart' + ' .pro_reintro').show();
                        $('#chart' + ' .pro_reintro').text(stats.pro_reintro + " people support reintroduction of the bill."); 
                    }
                    
                    {% if request.GET.client == 'anaap' or request.GET.client == 'anaap2' %}
                    bill_chart('chart_pie', stats.pro_pct, stats.con_pct, { "small": true, "bg": "#fff", colors:["#4a9410", "#edd501"] });
                    {% else %}
                        {% if request.GET.client == 'lilly' or request.GET.client == 'lilly2' %}
                            bill_chart('chart_pie', stats.pro_pct, stats.con_pct, { "small": true, "bg": "#fff", colors:["#0077d8", "#eb5c32"] });
                        {% else %}
                            bill_chart('chart_pie', stats.pro_pct, stats.con_pct, { "small": true, "bg": "#fff" });
                        {% endif %}
                    {% endif %}
                    {% if request.GET.client == 'anaap2' %}
                        bill_timeseries('chart_time', stats.timeseries, {"bg":"#fff","width": 230, colors:["#4a9410", "#edd501"] });
                    {% else %}
                        {% if request.GET.client == 'lilly2' %}
                        bill_timeseries('chart_time', stats.timeseries, {"bg":"#fff","width": 230, colors:["#0077d8", "#eb5c32"] });
                        {% else %}
                            bill_timeseries('chart_time', stats.timeseries, {"bg":"#fff","width": 270 });
                        {% endif %}
                    {% endif %}
                };

                $('#stats_overall_info').text("");
                if (!res.stats) {
                } else if (res.stats.overall) {
                    buildchart(res.stats.overall, 0, true);
                    $('#chart1').hide();
                    $('#chart2').hide();
                } else {
                    $('#stats_overall_info').text("Not enough individuals have commented on this {{bill.proposition_type}} to display a chart.");
                }

                if ((is_first_load || !report_state || res.comments.length == 0) && res.stats.overall) {
                    $('#map').show();
                    $('#showmap').hide();
                } else {
                    $('#map').hide();
                    if (res.stats.overall) $('#showmap').show();
                }
			}
		});
	}
                

    $(function() {
        $(window).bind("hashchange", function() {
            //$(window).scrollTop(320);
            var hashargs = $.deparam.fragment();
            if (hashargs.state) report_state = hashargs.state;
            if (hashargs.district) report_district = hashargs.district;
            showdata();
        });
    
        /*master_state(function(res) {
            // get default context from logged in state
            default_state = res.page.default_state;
            default_district = res.page.default_district
            if (default_state) {
                report_state = default_state;
                if (default_district) report_district = default_district;
                $('#jump_to_default').show();
                $('#options_jump_local').text("Show " + default_state + (default_district ? ("-" + default_district) : ""));
            }
    
            // override default context with fragment args
            if (window.location.hash == "#nation") {
                report_state = "";
                report_district = "";
            } else {
                var hashargs = $.deparam.fragment();
                if (hashargs.state) report_state = hashargs.state;
                if (hashargs.district) report_district = hashargs.district;
            }
            
            // pull data: must be in the ready state function
            showdata(true);
        }); */
    });

$(document).ready(showdata(true));

</script>
 {% if request.GET.client == 'anaap' or request.GET.client == 'anaap2' %}
<body id="anaap" style="background: none !important;">
{% endif %}
 {% if request.GET.client == 'lilly' or request.GET.client == 'lilly2' %}
<body id="lilly" style="background: none !important;">
{% endif %}

<div class="content">

        {% if request.GET.client == 'anaap' %}
        <div class="mini-map" style="width: 600px !important; height: 528px !important; background: none !important">
        {% else %}
            {% if request.GET.client == 'lilly' %}
                <div class="mini-map" style="width: 600px !important; height: 528px !important; background: none !important">
            {% else %}
                <div class="mini-map">
            {% endif %}
        {% endif %}

            {% if request.GET.client != 'anaap' and request.GET.client != 'lilly'%}

                {% if bill.street_name %}

                    <h3
                    	{% if request.GET.client == 'anaap2' %} style="padding: 10px 0 10px 5px; font-family: helvetica, san-serif; height: 50px; border-bottom:0; background-color: #777; background-image: none; background-position: -9px -9px;">Americans Support a National Airline Policy{%else%}{% if request.GET.client == 'lilly2' %} style="padding: 10px 0 10px 5px; font-family: helvetica, san-serif; font-size: 21px; line-height: 26px; height: 50px; border-bottom:0; background-color: #0077d8; background-image: none; background-position: -9px -9px;">Americans Support the MODDERN Cures Act{% else %}>{% endif %}{% endif %} <a {% if request.GET.client == 'anaap2' %} style="height: 50px; text-indent: -9999em; display: none;" {% endif %}{% if request.GET.client == 'lilly2' %} style="height: 50px; text-indent: -9999em; display: none;" {% endif %} href="https://www.popvox.com/bills/us/{{bill.congressnumber}}/{{bill.billtypeslug}}{{bill.billnumber}}" target="_blank">{{bill.billtypeslug}}{{bill.billnumber}}: {{bill.street_name|truncatewords:6}}</a></h3>
                {% else %}
                    <h3{% if request.GET.client == 'anaap2' %} style="height: 50px; border-bottom:0; background: #777 url(../widget/widget_logo.png) left top no-repeat;" {% endif %}><a {% if request.GET.client == 'anaap2' %} style="height: 50px; text-indent: -9999em; display: none;" {% endif %} href="https://www.popvox.com/bills/us/{{bill.congressnumber}}/{{bill.billtypeslug}}{{bill.billnumber}}" target="_blank">{{bill.title|truncatewords:6}}</a></h3>
                {% endif %}

            {% endif %}
            {% if request.GET.client == 'anaap' or request.GET.client == 'anaap2' or request.GET.client == 'lilly' or request.GET.client == 'lilly2'%}
                {% if request.GET.client == 'anaap' %}
                    <iframe src="/widgets/bill-comment-map?bill={{bill.id}}&width=600&hover=0&client=anaap" width="600" height="458" border="0" marginheight="0" marginwidth="0" frameborder="0" scrolling="no" style="overflow:hidden"></iframe>
                {% endif %}
                {% if request.GET.client == 'anaap2' %}
                    <iframe src="/widgets/bill-comment-map?bill={{bill.id}}&width=238&hover=0&client=anaap2" height="200" border="0" marginheight="0" marginwidth="0" frameborder="0" scrolling="no" style="overflow:hidden"></iframe>
                {% endif %}
                {% if request.GET.client == 'lilly' %}
					<iframe src="/widgets/bill-comment-map?bill={{bill.id}}&width=600&hover=0&client=lilly" width="600" height="458" border="0" marginheight="0" marginwidth="0" frameborder="0" scrolling="no" style="overflow:hidden"></iframe>
                {% endif %}
                {% if request.GET.client == 'lilly2' %}
                    <iframe src="/widgets/bill-comment-map?bill={{bill.id}}&width=238&hover=0&client=lilly2" height="201" border="0" marginheight="0" marginwidth="0" frameborder="0" scrolling="no" style="overflow:hidden"></iframe>
                {% endif %}
            {% else %}
                <iframe src="/widgets/bill-comment-map?bill={{bill.id}}&width=274&hover=0" width="274" height="250" border="0" marginheight="0" marginwidth="0" frameborder="0" scrolling="no" style="overflow:hidden"></iframe>
            {% endif %}



<!-- <h3 id="reporttitle" class="no_rule" style="padding: 0">Loading Legislative Report...</h3>
<h3 id="reportsubtitle" class="no_rule" style="padding: 0"></h3>
<h3 class="no_rule">Constituents Say</h3> -->
                 {% if request.GET.client != 'anaap2' %}
				<p id="stats_overall_info" class="" ></p>
                {% endif %}
                {% if request.GET.client != 'lilly2' %}
                <p id="stats_overall_info" class="" ></p>
                {% endif %}

                {% if request.GET.client == 'anaap' or request.GET.client == 'lilly' %}
                <div id="chart" class="clear" style="display: none; position: absolute; top: 400px; right: 40px;">
                {% else %}
                <div id="chart" class="clear" style="display: none;">
                {% endif %}
                    <div class="col_1 past_stats">
                        <div id="chart_pie" style="height: 110px; width: 110px"></div><!--  -->
					</div> <!-- /col_1 past_stats -->

                     <div class="col_2 past_stats"{% if request.GET.client == 'anaap2' or request.GET.client == 'lilly2' %} style="margin-left: -30px;" {% endif %}> <!-- style="padding-right: 1em; width: 280px" -->
                        <p class="chart_stats">
                            <span class="chart_title">XXX:</span> <br />
                            <span class="bg_support">YYY% Support</span><br />
                            <span class="bg_oppose">ZZZ% Oppose </span><br />
                            <span class="users">(WWW users)</span>
                        </p>
					</div> <!-- /col_2 past_stats -->
                    {% if request.GET.client != 'anaap' and request.GET.client != 'lilly'%}
                    <div class="col_3 col_last past_stats"{% if request.GET.client == 'anaap2' %} style="width: 230px;" {% endif %}>
                        <div id="chart_time"style="width: 280px; height: 150px; margin-bottom: 10px; {% if request.GET.client == 'anaap2' %} width: 238px; {% endif %}" ></div>
                        <!--<div style="font-size: 8pt; color: #999">Cumulative Number of Individuals Over Time</div>-->
					</div> <!-- /col_3 col_last past_stats -->
                    {% endif %}
				</div> <!-- /chart -->
        
			{% if request.GET.client == 'anaap' or request.GET.client == 'lilly' %}
				<div id="footer"> </div><!-- /footer -->
    	    {% else %}
    			<div id="footer">
					<p class="foot_text">Real-time sentiment registered on <br/><a href="http://www.popvox.com" target="_blank">www.popvox.com</a> - <a href="https://www.popvox.com/legal#privacypolicy" target="_blank">Privacy Policy</a></p>	
					<p id="shortmessages"></p>
				</div><!-- /footer -->
	        {% endif %}

			</div> <!-- /mini-map -->
</div> <!-- /content -->

 {% if request.GET.client == 'anaap' or request.GET.client == 'lilly' or request.GET.client == 'lilly2' %}
</body>
{% endif %}
{% endblock %}
