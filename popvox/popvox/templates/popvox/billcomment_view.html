{% extends "master.html" %}
{% load popvox_utils %}
{% load registration_providers %}
{% load humanize %}
{% block title %}{{comment.user.username}}&rsquo;s Comment on {{ bill.title|truncatewords:10 }}{% endblock%}
{%block nav_legstaff_class_bills%}active{%endblock%}
{%block nav_orgadmin_class_bills%}active{%endblock%}
{%block nav_citzen_class_bills%}active{%endblock%}
{%block subnav%}{% include "popvox/subnav_bills.html" %}{%endblock%}
{% block description %}{{comment.message|truncatewords:40}}{% endblock %}
{% block finalscript %}
{% if comment.user == request.user %}
	{% comment %}not really appropriate because a user can come back to this page later{% endcomment %}
	<script type="text/javascript">mpmetrics.track('comment finished', { 'bill': '{{bill.displaynumber|escapejs}}', mode: "{{follow_up|escapejs}}", 'personalized': {% if comment.message %}'yes'{% else %}'no'{% endif %} });</script>
{% endif %}
{% endblock %}
{% block head %}
<script type="text/javascript" src="/media/js/highcharts.js"></script>
<script type="text/javascript" src="/media/js/charts.js"></script>
<style>
ul.social_share_btns {
    float: right;
    margin: -10px 0 20px 25px;
    padding: 20px 0 0 20px;
    border-left: 1px solid #EEE;
    }

    ul.social_share_btns li {
        }

        ul.social_share_btns li a {
            text-indent: -9999em;
            display: block;
            width: 31px;
            height: 31px;
            border: none;
            margin-bottom: 20px;
            }
            
.message_preview p.signature {
	padding-left: 240px;
}
.private {
	font-size: 13px;
	line-height: 110%;
	color: #666;
}
#screenname {
	color: #404045;
	border: none;
	padding-right: 15px;
	background: url(/media/master/b_pencil_sm.png) right top no-repeat;
	border-image: initial;
}
	#screenname:hover {
		color: #CC6A11;
	}
</style>

{%if bill%}{% bill_statistics bill as stats %}{%endif%}
{% include "popvox/billcomment_share_social_js.html" %}
{% endblock %}

{% block content %}

{%if bill%}{% bill_statistics bill as stats %}{%endif%}
<div style="display: none">
	<div id="share_email_box" class="colorbox" style="width: 400px">
		<h1>Share by Email</h1>
		{% if user.is_authenticated %}
		<div class="form">
			<p style="margin: 1em 0 0 0"><strong>Recipients&rsquo; Email Addresses</strong></p>
			<textarea id="share_email_field" class="c5" onfocus="$('#share_email_status').hide();"></textarea>
			
			<p style="margin-bottom: 0"><strong>Personalized Message to Recipients</strong></p>
			<textarea id="share_message" class="c5" style="margin-bottom: 2px">{% if message %}{{message}}{% endif %}</textarea>
			
			{% if comment.user == user and comment.message %}
			<div>
				<input id="share_includecomment" type="checkbox" {% if includecomment %}checked="1"{% endif %} onchange="set_message()"/>
				<label class="checkbox" for="share_includecomment" style="width: auto;">Include Your Comment in Your Message</label>
				<div class="clear"> </div>
			</div>
			{% endif %}
			
			<div style="margin-top: 20px;">
				<input id="share_email_button" type="button" class="submit btn" value="Share Via Email" onclick="share('email')"/>
				<span id="share_email_status" class="error"></span>
			</div>
			<p class="tip_inline">The email will be sent from your email address <tt>{{user.email}}</tt>.</p>
			<script type="text/javascript">$(function(){ $('#share_email_field').input_default("(enter email addresses separated by commas or new lines)"); $('#share_email_field').input_autosize(); });</script>
		</div>
		{% else %}
			<p>You&rsquo;ll have to <a href="/accounts/login?next={{comment.url|urlencode}}">log in</a> first to share this comment by email.</p>
		{% endif %}
	</div>
	
	<div id="share_link_box" class="colorbox" style="width: 400px">
		<h1>Share A Link</h1>
		<p>Paste this link in email or IM:</p>
		<input id="share_link_result" type="text" readonly="1" value="" style="font: bold 13px Courier New; width: 350px;"/>
		<script type="text/javascript">
			$("#share_link_result").click(function(){
				// Select input field contents
				this.select();
			});
		</script>
	</div>
	
</div>
<div class="content">
	<div class="col_12 clear">
		{% if comment.user != request.user %}
            {%if bill%}
                {% if not bill.street_name and bill.is_officially_numbered %}
                    <h1>Letters to Congress on {{bill.displaynumber}}</h1>
                {% else %}
                    <h1 class="streetname">Letters to Congress</h1>
                {% endif %}
            {% else %}
                <h1>Public comments on {{regulation.regnumber}}</h1>
            {% endif %}
		{% else %}
			{% comment %}gotta be appropriate for when a user is finishing their comment and when they stumble on it again later{% endcomment %}
			<h1>Here&rsquo;s Your {%if bill%}Letter{% else %}Comment{% endif %}!</h1>
		{% endif %}
	</div>

	<div class="col_8 col_top" style="margin-left: -10px">
		<div class="message_preview" style="margin-top: -6px">
			<div class="inner">
			
				<ul class="social_share_btns no_hover_state">
					<li><a class="btn social_facebook" href="#" onclick="return start_share('facebook')" title="Facebook">facebook</a></li>
					<li><a class="btn social_twitter" href="#" target="_blank" onclick="return start_share('twitter')" title="Twitter">twitter</a></li>
					<li><a class="btn social_email" href="#" onclick="return start_share('email')" title="Email">email</a></li>
					<li><a class="btn social_link" href="#" onclick="return start_share('link')" title="Get a Short URL">get a link</a></li>
				</ul>
				
				<p style="text-align: right;">{{comment.updated|date2}}</p>

				{% if comment.message %}
				<p style="padding-top: 20px"><span style="border-bottom: 1px solid black"><strong>{%if bill%}{{comment.verb_imp|capfirst}}</strong>{{bill.title}}{% else %}Comment on {{regulation.title}}{% endif %}</span></p>
				{% endif %}
				
				<p style="padding-top: 15px">{%if bill%}Dear {{comment.get_recipients_display}}{% else %}{{regulation.agency}}{% endif %}:</p>
				
				{% if comment.message %}
					{% if not comment_rejected %}
						{{comment.message|wraplines:"p"}}
					{% else %}
						<p>This comment has been hidden by POPVOX staff because it violates our policies for acceptable language.</p>
					{% endif %}
				{% else %}
					<p>{%if bill%}I {{comment.verb_imp}} {{bill.title}}{% endif %}.</p>
				{% endif %}
	
				<p class="signature">
                    {%if bill%}
                        {% if user == comment.user %}
                            <span class="private">Signature seen by Members of Congress:</span> <br>
                            <span class="name">{{comment.address.name_string}}</span> <br>
                            <span class="citystatezip">{{comment.address.address1}}</span> <br>
                            {% if comment.address.address2 %}<span class='citystatezip'>{{comment.address.address2}}</span> <br>{% endif %}
                            <span class="citystatezip">{{comment.address.city}}, {{comment.address.state}} {{comment.address.zipcode|slice:"0:5"}}</span> <br><br>
                            <span class="private">Signature seen by other POPVOX users:</span> <br>
                            
                            <span class="name"><a href="/accounts/profile" id="screenname">{{comment.user.username}}</a></span> <br>
                        {% else %}
                            <span class="name">{{comment.user.username}}</span> <br>
                        {% endif %}
                    {% else %}
                        <span class="name">{{comment.address.name_string}}</span> <br>
                    {% endif %}
					<span class="citystatezip">{{comment.address.statename}}{% if comment.address.congressionaldistrict != 0 %}&rsquo;s {{comment.address.congressionaldistrict|ordinal}} district{% endif %}</span>
				</p>
				
				<p style="padding-top: 20px; text-align: center; font: italic 12px sans-serif; color: #555">
					{% comment %}{{comment.delivery_status_public}} removed 1/2/13 until we get msg delivery through the transition.{% endcomment %}
					
					{% with comment.shares.count as comment_shares_count %}
						{% if comment_shares_count %}
						 Shared by {{comment_shares_count}} POPVOX user{{comment_shares_count|pluralize}}.
						{% endif %}
					{% endwith %}
				</p>
						
				<p style="padding-top: 20px; text-align: center; font: bold 16px sans-serif;"><a class="orange" href="{%if bill%}{{bill.url}}{% else %}{{regulation.url}}{% endif %}/report" {% if comment.user == request.user %}style="color: #666"{% endif %}>View More Letters on This Issue &gt;</a></p>
			
			</div>
		</div>
		<div class="letterBottom">
		</div>
	</div>
	
	<div class="col_4 col_top col_last">
	<div style="padding-left: 30px">
		{% if follow_up == "widget-screenname-password" %}
			<p>Thank you for {%if bill%}sharing your opinion using the Write Congress{% else %}sharing your public comment using the regulation comment{% endif %} tool from POPVOX.</p>
			<p>Your comment on {%if bill%}{{bill.displaynumber}}{% else %}{{regulation.regnumber}}{% endif %} has been saved.</p>
			{% include "popvox/widgets/writecongress_followup.html" %}
		{% endif %}
		
        {%if bill%}
		{% if comment.user == request.user %}
			{% if stats %}
				<h1>You Changed the Pie Chart!</h1>
			{% else %}
				{% if comment.message %}
					<h1>Share Your Comment</h1>
				{% else %}
					<h1>Tell Others To Weigh In</h1>
				{% endif %}
			{% endif %}
		
			{% if not stats %}
				<p>Build support or opposition for this {{bill.proposition_type}} by sharing your {% if comment.message %}comment{% else %}position{% endif %} with others.</p>
			{% endif %}
			{% if stats and stats.total <= 50 %}
				<p>You gave a big push to the pie chart because you are one of the first 50 people in {{stats.longdescription}} to comment on {{bill.shortname}}.</p>
			{% endif %}
			{% if stats and stats.total > 50 and stats.total <= 200 %}
				<p>This {{bill.proposition_type}} is starting to get attention in {{stats.longdescription}} but it will take more people than that to get traction in Congress.</p>
			{% endif %}
			{% if stats and stats.total > 200 %}
				<p>Keep up the pressure in your Congressional district by spreading the word about {{bill.shortname}}.</p>
			{% endif %}
			
			<div class="btn b_finished" value="Finished >" onclick="document.location = '{{finished_url|escapejs}}'" style="float: right;"> </div>
			<div class="clear"> </div>
			<div class="hr" style="margin: 20px 0 20px 0;"> </div>
		{% endif %}
        {% endif %}
	
		<!--
		<p class="commenter"><span style="font-size: 16px;">{{comment.user.username}}</span> {% comment %}from {{comment.address.statename}}{% if comment.address.congressionaldistrict != 0 %}&rsquo;s {{comment.address.congressionaldistrict|ordinal}} Congressional district{% endif %}{% endcomment %} is using POPVOX to {{comment.verb_imp}}:</p>
		-->
	
		<div class="block">
			<div class="bill">
				<h3 class="no_rule"><a href="{%if bill%}{{bill.url}}{% else %}{{regulation.url}}{% endif %}" style="color: #404045">{%if bill%}{{ bill.title|truncatewords:10 }}{% else %}{{ regulation.title|truncatewords:10 }}{% endif %}</a></h3>
				<p style="margin-bottom: 0;">
                    {%if bill%}
                        {% if bill.description %}
                        {{ bill.description|truncatewords:10 }}
                        {% endif %}
                    {% else %}
                        {% if regulation.description %}
                        {{ regulation.description|truncatewords:10 }}
                        {% endif %}
                    {% endif %}

					(<a href="{%if bill%}{{bill.url}}{% else %}{{regulation.url}}{% endif %}">more about this {%if bill%}{{bill.proposition_type}}{% else %}regulation{% endif %}</a>)
				</p>
			</div>
		</div>
		{%if bill%}
            <div style="padding-left: 10px">
            {% with 1 as chart_no_links %}
                {% include "popvox/bill_statistics_pie_simple.html" %}
            {% endwith %}
            </div>
        {% endif %}
		
		{% if user.is_staff or user.is_superuser %}
		<script type="text/javascript">
		function moderate(url) {
			if (!$('#moderation_comment').hasClass('default'))
				url += "?log=" + encodeURIComponent($('#moderation_comment').val());
			document.location = url;
			return false;
		}
		</script>
		<div class="review" style="margin-bottom: 1em; border: 1px solid #999; padding: 5px; color: #999">
			<div>Administrative commands:</div>
			<div>
				{% if comment.message %}
					{% if comment.status == 0 %}
						<a href="#" style="color: #B77" onclick="$('#reject_comment, #moderation_comment').fadeIn(); return false;">Reject Comment?</a>
						<span id="reject_comment" style="display: none">
							<a href="#" onclick="return moderate('{% url popvox.views.bills.billcomment_moderate comment.id "reject" %}')">Standard Reject</a> |
							<a href="{% url popvox.views.bills.billcomment_moderate comment.id "reject-stop-delivery" %}">Reject and Halt Delivery</a>
						</span>
					{% endif %}
					{% if comment.status == 1 %}
						The comment was approved after initially being rejected.
					{% endif %}
					{% if comment.status == 2 %}
						This comment has been rejected.
					{% endif %}
					{% if comment.status == 3 %}
						This comment has been rejected w/ halted message delivery.
					{% endif %}
					{% if comment.status == 4 %}
						<div>The user has revised the comment. <a href="#" style="color: #B77" onclick="$('#accept_comment, #moderation_comment').fadeIn(); return false;">Accept Comment?</a></div>
						<span id="accept_comment" style="display: none">
							<a href="#" onclick="return moderate('{% url popvox.views.bills.billcomment_moderate comment.id "accept" %}')">Accept</a>
						</span>
					{% endif %}
					{% if comment.status == 5 %}
						This comment is being held.
					{% endif %}
					
					<textarea id="moderation_comment" rows="2" style="width: 100%; display: none" wrap="virtual"></textarea>
					<script type="text/javascript">$('#moderation_comment').input_default('Enter a reason for the moderation.')</script>
					
					{% if comment.moderation_log %}
						<div style="margin-top: 1em; height: 6em; overflow: auto">
						{{comment.moderation_log|linebreaks}}
						</div>
					{% endif %}
				{% endif %}
			</div>
		</div>
		{% endif %}

        {%if bill%}
		{% if not user.userprofile.is_leg_staff and not user.userprofile.is_org_admin and user != comment.user %}
		<h3 class="no_rule" style="margin-top: 20px">What Do You Think?</h3>
		{% include "popvox/bill_howshouldtheyvote.html" %}
		<div style="margin: auto; {% if not user_position %}width: 185px;{% endif %}">
			{% include "popvox/bill_uservote.html" %}
			
			{% if not user_position %}
			<p class="clear" style="padding-top: 15px; font-size: 12px; color: #666">(If you agree with {{comment.user.username}} you <strong>{{comment.verb_imp}}</strong> the {{bill.proposition_type}}.)</p>
			{% endif %}
		</div>
		{% if not user_position %}
			<p>Not sure? Read <a href="{{bill.url}}">more about {{bill.shortname}}</a>.</p>
		{% endif %}
		{% endif %}
        {% endif %}
		

	</div>
	</div><!-- e: col_4 -->

</div>
{% endblock %}

