{% load popvox_utils %}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<title>POPVOX Bill Text Widget</title>
		<link rel="stylesheet" type="text/css" media="screen,projection" href="/media/master/reset.css" />

		<script src="/media/js/jquery-1.6.2.min.js" type="text/javascript"></script>
		<script src="/media/js/jquery.scrollview.js" type="text/javascript"></script>
		<script src="/media/js/ajaxforms.js" type="text/javascript"></script>

		<link rel="stylesheet" href="/media/css/colorbox/colorbox.css" type="text/css" />
		<script src="/media/js/jquery.colorbox-min.js"></script>
		
	<style>
	.meta_view { display: none; }
	#center, #page_paper { overflow: auto; }
	#table_of_contents, #version_select { padding: 15px; }
	#table_of_contents h2, #version_select h2 { font-family: Verdana, Tahoma, Arial; font-size: 14px; text-transform: uppercase; text-decoration: none; font-weight: bold; margin-bottom: 6px; }
	#table_of_contents .entry { clear: both; font-family: Tahoma, Arial; font-size: 12px; text-decoration: none; margin-bottom: 4px; }
	#table_of_contents .entry .number { float: right; }
	#table_of_contents a { cursor: pointer; }
	 { padding: 15px; }
	#version_select h3 { font-family: Verdana, Tahoma, Arial; font-size: 12px; text-transform: uppercase; text-decoration: none; font-weight: bold; margin-top: 18px; margin-bottom: 6px; }
	#version_select .entry { font-family: Tahoma, Arial; font-size: 12px; text-decoration: none; margin-bottom: 4px; }
	#version_select .entry span { display: block; margin-left: 25px; color: #666; }
	#version_select a { cursor: pointer; }
	.search_nav { display: none; }
	.search_match {
		background-color: white;
		color: black;
		font-weight: bold;
	}
	.page_view { display: none; background-color: white; }
	#page_paper .container { padding: 15px; cursor: move; }
	#page_paper img { display: block; } /* prevent side by side alignment for the scrolling */
	#page_text { padding: 15px; }
	#page_text pre { font-family: mono; }
	.loading { position: absolute; background-color: white; padding: 1em; font-size: 14px; font-weight: bold; font-family: Verdana, Tahoma, Arial, sans-serif; } 
	
	body {
		background: #fff;
		font-family: Tahoma, Arial;
		font-size: 12px;
		margin: 0;
		overflow: hidden;
		}
	
	/**The bar itself giving it a height, width, background, ignore margin  ***/
	#header, #footer { height: 30px; background: #e2d8d0; overflow: hidden; }
	
	#header li.title { margin: 0 0 0 10px; }
	#header li.title, #header li.title a { font: bold 14px/28px Verdana, Arial, sans-serif; color: black; }
	
	/**styling the UL list for the icons**/
	ul.barNav { list-style-type: none; }
	#footer ul.barNav li { float: left; border-right: 2px solid #cabfb6; }
	
	/**The Up and Down arrows**/
	.first { margin-left: 10px; border-left: 2px solid #cabfb6;  }
	a#arrowUp { background: url(/media/billtext/arrowUp.png) no-repeat center center; width: 25px; height: 30px; display: block; margin: 0; }
	a#arrowDown { background: url(/media/billtext/arrowDown.png) no-repeat center center; width: 25px; height: 30px; display: block; margin: 0; }
	a#arrowUp:hover { background: #c7bab0 url(/media/billtext/arrowUpH.png) no-repeat center center; }
	a#arrowDown:hover { background: #c7bab0 url(/media/billtext/arrowDownH.png) no-repeat center center; }
	
	/**The page number input**/
	#footer li#pageN { border: none; }
	li#pageN input { width: 35px; background: #d5cbc3; border: 1px solid #aea298; padding: 0 2px 0 2px; vertical-align: top; text-align: center }
	li#pageN { height: 24px; width: 100px; padding-top: 4px; text-align: center; border-right: none; }
	li#pageN span { display: inline-block; padding-top: 2px; }
	
	/**The Search input**/
	li#searchBill input { width: 110px; background: #d5cbc3; border: 1px solid #aea298; padding: 2px 2px 2px 6px; vertical-align: center; }
	ul.barNav li#searchBill { height: 26px; padding-top: 2px; text-align: center; border-right: none; }
	
	/**Full screen icon**/
	a#fullScreen { background: url(/media/billtext/fullScreen.png) no-repeat center center; height: 30px; display: block; }
	a#fullScreen:hover { background: #c7bab0 url(/media/billtext/fullScreenH.png) center center no-repeat; }
	ul.barNav li.full { border-right: none; width: 30px; margin-left: 20px; }
	a#fullScreen:hover { background: #c7bab0 url(/media/billtext/fullScreen.png) center center no-repeat; }
	
	/**Embed icon**/
	ul/barNav li.embed { border-right: none; width: 40px; margin-left: 5px; }
	a#embedPage { background: url(/media/billtext/embed.png) no-repeat center center; width: 40px; height: 30px; display: block; margin: 0; }
	a#embedPage:hover { background: #c7bab0 url(/media/billtext/embedH.png) center center no-repeat; }
	
	/**Help icon**/
	ul.barNav li.help { border-right: none; width: 30px; margin-left: 5px; }
	a#helpNotify { background: url(/media/billtext/notify.png) no-repeat center center; height: 30px; display: block; }
	a#helpNotify:hover { background: #c7bab0 url(/media/billtext/notifyH.png) center center no-repeat; }
	
	/**Download icon**/
	ul/barNav li.download { border-right: none; width: 30px; margin-left: 5px; }
	a#downloadPDF { background: url(/media/billtext/downloadpdf.png) no-repeat center center; width: 30px; height: 30px; display: block; margin: 0; }
	a#downloadPDF:hover { background: #c7bab0 url(/media/billtext/downloadpdfH.png) center center no-repeat; }
	
	/**Table of Contents styling**/
	ul.barNavFooter a { display: block; font-family: Tahoma, Arial; font-size: 11px; text-transform: uppercase; text-decoration: none; font-weight: bold; color: #6a6767; margin-top: 8px; }
	ul.barNav a:visited { color: #6a6767; }
	ul.barNav a:hover { color: #514f4f; }
	ul.barNav li.toc, ul.barNav li.pagemode, ul.barNav li.zoom, ul.barNav li.versions { padding: 0 10px 0 10px; }
	ul.barNav li.pagemode a { width: 30px; text-align: center; }
	ul.barNav li.search_nav { padding: 0 10px 0 10px; }
	ul.barNav li.logo a { display: block; background: url(/media/billtext/logo.png); width: 29px; height: 24px;  text-indent: -999em; margin: 0; }
	#footer ul.barNav li.logo { float: right; border: none; margin: 3px 4px 2px 4px; }
	#search_results { padding: 7px 10px 0 10px; height: 30px; }
	
	#embed_info { width: 450px; height: 220px;}
	#embed_info p { font-weight: bold; margin: 10px 0 5px 0; }

	</style>
	<script>
var _docid = null;
var _pagecount = null;
var _formats = null;
var _curpage = null;
var _curview = 'meta';
var _lastview = "paper";
var _searchterms = null;
var _searchresultpages = null;
var _searchnavindex = null;
var _zoomed = {% if not request.GET.zoomed == '1' %}false{% else %}true{% endif %};
var _startpage = {% if not request.GET.page %}1{% else %}parseInt("{{request.GET.page|escapejs}}"){% endif %};
var _startformat = {% if not request.GET.format %}"paper"{% else %}"{{request.GET.format|escapejs}}"{% endif %};
var _pagetextcontent = { };

if (_startformat != "paper" && _startformat != "text") _startformat = "paper";

function load_bill(billid) {
	// Load all bill text versions for this bill and display the most recent.
	$.ajax({
	type:"GET",
	url: "/api/v1/bill/" + billid + "/documents",
	data: {
		type: 100,
		api_key: "DQZUTLYRW4K1FK1O" // popvox public api key
	},
	dataType: "json",
	success: function(data, status) {
		var has_document = false;
		for (var i = 0; i < data.length; i++) {
			// load up the first bill text document that appears
			if (!has_document) load_document(data[i].id);
			has_document = true;
			
			var entry = $('<div class="entry"/>');
			$('#version_select').append(entry);
			entry.append($('<a/>').text(data[i].title).attr('onclick', 'load_document(' + data[i].id + '); return false;'));
			var d = new Date(data[i].created);
			entry.append($('<span/>').text("published on " + (d.getMonth()+1) + "/" + d.getDate() + "/" + d.getFullYear()));
			
			if (i > 0) $('#footer .versions').show();
		}
		
		if (!has_document) {
			// No text is available. In order to display why, we have to load
			// bill metadata.
			$.ajax({
			type:"GET",
			url: "/api/v1/bill/" + billid,
			data: {
				api_key: "DQZUTLYRW4K1FK1O" // popvox public api key
			},
			dataType: "json",
			success: function(bill_data, status) {
				$('li.title').text(bill_data.title);
				if (bill_data.congressnumber < 112) {
					$('#center').html("<div style='margin: 20px'>The text of this bill is not available. Archival bill text is not available.</div>");
				} else {
					$('#center').html("<div style='margin: 20px'>The text of this bill is not available. It may not yet have been printed by the Government Printing Office.</div>");
				}
				$('#downloadPDF').hide();
			}
			});
		}
	
		// Load all bill text comparison versions.
		$.ajax({
		type:"GET",
		url: "/api/v1/bill/" + billid + "/documents",
		data: {
			type: 101,
			api_key: "DQZUTLYRW4K1FK1O" // popvox public api key
		},
		dataType: "json",
		success: function(data, status) {
			if (data.length > 0) {
				$('#version_select').append($('<h3>Compare Two Versions</h3>'));
			}
			for (var i = 0; i < data.length; i++) {
				var entry = $('<div class="entry"/>');
				$('#version_select').append(entry);
				entry.append($('<a/>').text(data[i].title).attr('onclick', 'load_document(' + data[i].id + '); return false;'));
			}
		}
		});
	}
	});
}

function load_document(docid) {
	// reset state
	clear_search();
	_pagetextcontent = { };

	// begin document load
	_docid = docid;

	$.ajax({
	type:"GET",
	url: "/api/v1/document/" + docid,
	data: {
		api_key: "DQZUTLYRW4K1FK1O" // popvox public api key
	},
	dataType: "json",
	success: function(data, status) {
		// Document metadata.
		$('li.title a').text(data.bill.title);
		$('li.title a').attr("href", data.bill.link);
		$('#footer li.logo a').attr("href", data.bill.link);
		$('#downloadPDF').attr('href', data.pdf_url);
		
		// Build the Table of Contents.
		var toc = $('#table_of_contents');
		for (var i in data.toc) {
			var entry = $('<div class="entry"><a class="number"/> <a class="label"/></div>');
			entry.attr('style', 'margin-left: ' + (data.toc[i].indentation*1.5) + 'em');
			entry.find('.number').text(data.toc[i].page);
			entry.find('.label').text(data.toc[i].label);
			entry.attr('page_number', data.toc[i].page);
			entry.click(function() { load_page(parseInt(this.getAttribute('page_number'))); return false; });
			toc.append(entry);
		}
		
		// State.
		_pagecount = data.pages;
		_formats = data.formats;
		_curpage = null;
		
		// Display.
		$('#footer .pagemode').show();
		$('#footer .zoom').show();
		if (!_formats.png) {
			_startformat = "text";
			$('#footer .pagemode').hide();
			$('#footer .zoom').hide();
		}
		if (!_formats.text) {
			_startformat = "paper";
			$('#footer .pagemode').hide();
		}
		if (!_formats.png && !_formats.text) {
			$('#center').text("This document is not currently available.");
			return;
		}
		$('#pageN span').text("/ " + _pagecount);
		show_page(_startformat);
	}});
}

function show_meta(view) {
	$('.meta_view, .page_view').hide()
	if (view == 'toc') $('#table_of_contents').show();
	if (view == 'search') $('#search').show();
	if (view == 'versions') $('#version_select').show();
	_curview = 'meta';
	$('.barNav .pagemode a').text(_lastview == "paper" ? "paper" : "text");
	return false;
}

function show_page(format) {
	$('.meta_view, .page_view').hide()
	$('#page_' + format).show();
	
	_curview = format;
	_lastview = format;
	
	load_page(_curpage ? _curpage : _startpage);

	$('.barNav .pagemode a').text(_lastview == "paper" ? "text" : "paper");
	
	return false;
}

function load_page(pagenum, direction) {
	prevpage = _curpage;
	
	if (pagenum == _curpage) return;
	if (pagenum) _curpage = pagenum;
	
	if (_pagetextcontent[_curpage]) {
		// Load the text from cache.
		load_page_text(_pagetextcontent[_curpage], direction);
	} else if (_formats.text)  {
		// Load the text via AJAX.
		$('#page_text .loading').show();
		$.ajax({
		type:"GET",
		url: "/api/v1/document/" + _docid + "/page/" + _curpage + ".txt",
		dataType: "text",
		success: function(data, status) {
			$('#page_text .loading').hide();
			load_page_text(data, direction);
		}});
	} else {
		$('#pageN input').val(_curpage);
	}
	
	// Load the PNG by referening the URL of the image directly.
	
	if (_formats.png) load_page_image(pagenum, prevpage, direction);
}

function load_page_text(text, direction) {
	$('#page_text pre').text(text);
	_pagetextcontent[_curpage] = text;
	
	$('#pageN input').val(_curpage);
	if (_curview == "meta") { // make sure page view is visible and not meta view
		if (!_searchterms)
			show_page(_lastview);
		else
			show_page("text");
	}
	
	if (_searchterms) {
		for (var i in _searchterms) {
			// create HTML-escaped and span-wrapped representation of the match
			function wrap(text) {
				var st_html = $('<div><span class="search_match"/></div>');
				st_html.find('span').text(text);
				return st_html.html();
			}
			
			// replace instances of the term with that
			st_text = _searchterms[i].replace(/[-[\]{}()*+?.,\\^$|#\s]/g, "\\$&"); // make a regex out of it so we can do case-insensitive matching
			$('#page_text pre').html( $('#page_text pre').html().replace(new RegExp(st_text, "gi"), wrap) );
		}
	}
	
	// normally reset scroll bar to top, unless we are paging backwards
	// in which case scroll to the bottom
	if (direction != -1)
		$('#center').scrollTop(0);
	else
		$('#center').scrollTop($("#center").innerHeight());
	
	update_embed_links();
}

function load_page_image(pagenum, prevpage, direction) {
	var imgold = $('#page_paper img');
	imgold.addClass("old");
	var img = $("<img/>").hide().css({cursor: "move"});
	var anim_target;
	var anim_value;
	if (direction == 1 || pagenum > prevpage || !imgold.length) {
		$('#page_paper .container').append(img);
		anim_target = $('#page_paper img.old');
		anim_value = -$('#page_paper .container').height();
	} else {
		img.insertBefore(imgold);
		img.css({"margin-top": -imgold.height()});
		anim_target = img;
		anim_value = 0;
	}
	img.load(function() {
		$('.loading').hide();
		img.show();
		anim_target.animate(
			{ "margin-top": anim_value },
			function() {
				imgold.remove();
				
				/*if (direction != -1) // messes with the animation
					$('#page_paper').scrollTop(0);
				else
					$('#page_paper').scrollTop($("#page_paper").innerHeight());
				*/
			});
	});
	$(window).resize(); // reset image size
	$('.loading').fadeIn();
	img.attr('src', "/api/v1/document/" + _docid + "/page/" + _curpage + ".png");
	
	//$('#arrowUp').toggle(_curpage > 1);
	//$('#arrowDown').toggle(_curpage < _pagecount);
}

function page_advance(direction) {
	if (_curpage + direction < 1 || _curpage + direction > _pagecount) return false;
	load_page(_curpage + direction, direction);
	return false;
}

function page_go_to(pagenum) {
	pagenum = parseInt(pagenum);
	if (pagenum < 1 || pagenum > _pagecount) return false;
	load_page(pagenum);
	return false;
}

function clear_search() {
	$('.barNav .search_nav').hide();
	_searchterms = null;
	_searchresultpages = null;
	_searchnavindex = null;
}
function search() {
	var q = $('#searchBill input').val();
	if (!q) {
		// similar code bellow
		$('#search_results').text("");
		clear_search();
		return false;
	}
	
	$.ajax({
	type:"GET",
	url: "/api/v1/document/" + _docid + "/search",
	data: { q: q, api_key: "XCVF0PEWJ4MG5YUA" },
	dataType: "json",
	success: function(data, status) {
		if (data.results.length == 0) {
			$('#search_results').text("Text not found in document.");
			clear_search();
			return;
		}
		
		_searchterms = data.keywords;
		_searchresultpages = data.results;
		_searchnavindex = 0;
		
		_curpage = null; // reset current page view
		show_page("text");
		load_page(_searchresultpages[0].page);
		
		$('#search_results').text('');
		$('.barNav .search_nav').show();
	}});
	return false;
}

function search_advance(direction) {
	_searchnavindex += direction;
	if (_searchnavindex == -1) _searchnavindex = _searchresultpages.length - 1;
	if (_searchnavindex == _searchresultpages.length) _searchnavindex = 0;
	load_page(_searchresultpages[_searchnavindex].page);
	return false;
}

function update_embed_links() {
	$('#embed_link').val("{{request.GET.baseurl|escapejs}}#page=" + _curpage + (_zoomed ? ",zoomed=1" : "") + (_curview != "paper" ? ",format=text" : ""));
	$('#embed_widget').val("<script src=\"https://{{request.get_host|escapejs}}/widgets/bill-text.js?docid=" + _docid + (_curpage > 1 ? "&page=" + _curpage : "") + (_zoomed ? "&zoomed=1" : "") + (_curview != "paper" ? "&format=text" : "") + "&account=anonymous\"> <" + "/script>");
}

function update_embed_links_2() {
	// Update the links with lazy information.
	
	if ($('#embed_widget').val().indexOf("&account=anonymous") == -1) return;
	
	// Trace who owns this widget by getting an API key for the logged in user
	// (note: not the owner of the public API key we use to make this widget
	// go, which is the POPVOX api key).
	$.ajax({
	type:"GET",
	url: "/api/v1/users/me",
	dataType: "json",
	success: function(data, status) {
		$('#embed_widget').val( $('#embed_widget').val().replace("&account=anonymous", "&api_key=" +  data.public_api_key) );
	}});
}

$(function() {
	$(window).resize(function() {
		// set container sizes to window size so that any overflow brings up inner scroll bars
		// and doesn't push the footer below the fold. we do this for page_paper even though
		// #center takes care of it so that we can use jquery.scrollview on the paper mode
		// but not the text view.
		$('#center, #page_paper').height($(window).height() - $('#header').height() - $('#footer').height());
		//$('#footer .zoom').toggle($(window).height() > 500);
		if ($(window).height() <= 600 && !_zoomed)
			$('#page_paper img').attr('height', 600).removeAttr('width');
		else if ($(window).height() > 600 && !_zoomed)
			$('#page_paper img').attr('height', $('#page_paper').height() - 35).removeAttr('width');
		else if ($(window).width() > 768 && !_zoomed)
			$('#page_paper img').attr('width', 768-60).removeAttr('height');
		else
			$('#page_paper img').attr('width', $(window).width()-60).removeAttr('height');
		
		//$('#embed_info').width($(window).width() - 120);
		
		$('#footer').show(); // don't show until the sizes have been set to avoid flicker
	});
	$(window).resize();
	
	$('#searchBill input').keydown_enter(search);
	
	$("#page_paper").scrollview({});
	
	// load a document
	{% if request.GET.docid %}
	load_document(parseInt("{{request.GET.docid|escapejs}}"));
	{% endif %}
	
	{% if request.GET.billid %}
	load_bill(parseInt("{{request.GET.billid|escapejs}}"));
	{% endif %}
	
});
	</script>
	</head>
	<body>
	<div class="content">
		<div id="header">
			<ul class="barNav">
				<li class="title"><a href="http://www.popvox.com" title="Embeddable bill text powered by POPVOX: Click here to weigh in." target="_top"> </a></li>
			</ul>
		</div>
		
		<div id="center">
			<div id="version_select" class="meta_view">
				<h2>Show Different Version</h2>
			</div>
		
			<div id="table_of_contents" class="meta_view">
				<h2>Table of Contents</h2>
			</div>
			
			<div id="page_paper" class="page_view">
				<div class="container">
					<div class="loading">Loading...</div>
				</div>
			</div>
		
			<div id="page_text" class="page_view">
				<div class="loading">Loading...</div>
				<pre/>
			</div>
		
		</div>
		
		<div id="footer" style="display: none;">
			<ul class="barNav barNavFooter">
				<li class="first"><a href="#" id="arrowUp" onclick="return page_advance(-1)"></a></li>
				<li><a href="#" id="arrowDown" onclick="return page_advance(1)"></a></li>
				<li id="pageN"><input value="__" onchange="return page_go_to(this.value);"></input> <span>__</span></li>
				
				<li id="searchBill"><input placeholder="Search Text"></input></li>
				<li class="search_nav search_prev"><a href="#" onclick="return search_advance(-1)">&lt; Prev</a></li>
				<li class="search_nav search_next"><a href="#" onclick="return search_advance(+1)">Next&gt;</a></li>
				<li id="search_results"></li>
			
				<!--<li class="full"><a id="fullScreen" href="#"></a></li>-->
				<li class="pagemode"><a href="#" onclick="_curview != 'meta' ? show_page(_lastview == 'paper' ? 'text' : 'paper') : show_page(_lastview); update_embed_links(); return false;">Text</a></li>
				<!--<li class="help"><a id="helpNotify" href="#"></a></li>-->
				<li class="toc"><a href="#" onclick="return _curview != 'meta' ? show_meta('toc') : show_page(_lastview);">Sections</a></li>
				
				<li class="zoom"><a href="#" onclick="_zoomed = !_zoomed; $(window).resize(); update_embed_links(); return false;">Zoom</a></li>
				
				<li class="embed"><a id="embedPage" href="#" onclick="update_embed_links_2(); $.colorbox({transition: 'none', inline: true, href:'#embed_info', opacity: .5}); return false;" title="Embed"></a></li>
				<li class="download"><a id="downloadPDF" href="#" target="_blank" title="Download PDF"></a></li>
				
				<li class="versions" style="display: none"><a href="#" onclick="return _curview != 'meta' ? show_meta('versions') : show_page(_lastview);">Versions</a></li>
				
				<li class="logo">
					<a href="http://www.popvox.com" title="Embeddable bill text powered by POPVOX: Click here to weigh in." target="_top">
						POPVOX.com
					</a>
				</li>
			</ul>
		</div>
		
	</div>
	
	<div style="display: none">
		<div id="embed_info">
			{% if request.GET.baseurl %}
			<p>Link to this page:</p>
			<textarea id="embed_link" style="width: 90%;" rows="3"></textarea>
			{% endif %}
			
			<p>Embed widget:</p>
			<textarea id="embed_widget" style="width: 90%;" rows="3"></textarea>
		</div>
	</div>
	</body>
</html>

