{% load popvox_utils %}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<title>POPVOX Bill Report</title>
		<meta name="viewport" content="width=700, initial-scale=1">
		<link rel="stylesheet" type="text/css" media="screen,projection" href="/media/mobile/css/style.css" />
		<link rel="stylesheet" type="text/css" media="print" href="/media/mobile/css/print.css" />
		<!--[if lte IE 9]>
			<link rel="stylesheet" type="text/css" media="screen,projection" href="/media/mobile/css/ie.css" />
		<![endif]-->
		<script type="text/javascript">
		<!--
		if(navigator.userAgent.indexOf('Mac') > 0 ){
			document.documentElement.className += "mac";
		}
		//-->
		</script>

		<script src="/media/js/jquery-1.6.2.min.js" type="text/javascript"></script>
		<script src="/media/js/jquery.scrollview.js" type="text/javascript"></script>
		<script src="/media/js/ajaxforms.js" type="text/javascript"></script>
		
	<style>
	.meta_view { display: none; }
	#center, #page_paper { overflow: auto; }
	#table_of_contents { padding: 15px; }
	#table_of_contents h2 { font-family: Verdana, Tahoma, Arial; font-size: 14px; text-transform: uppercase; text-decoration: none; font-weight: bold; margin-bottom: 6px; }
	#table_of_contents .entry { clear: both; font-family: Tahoma, Arial; font-size: 12px; text-decoration: none; margin-bottom: 4px; }
	#table_of_contents .entry .number { float: right; }
	#table_of_contents a { cursor: pointer; }
	.search_nav { display: none; }
	.search_match {
		background-color: white;
		color: black;
		font-weight: bold;
	}
	.page_view { display: none; background-color: white; }
	#page_paper .container { padding: 15px; }
	#page_paper img { display: block; } /* prevent side by side alignment for the scrolling */
	#page_text { padding: 15px; }
	.loading { position: absolute; background-color: white; padding: 1em; font-size: 14px; font-weight: bold; font-family: Verdana, Tahoma, Arial, sans-serif; } 
	
	body {
		background: #fff;
		font-family: Tahoma, Arial;
		font-size: 12px;
		margin: 0;
		overflow: hidden;
		}
	
	/**The bar itself giving it a height, width, background, ignore margin  ***/
	#header, #footer { height: 30px; background: #e2d8d0; overflow: hidden; }
	
	#header li.title { margin: 0 0 0 10px; font: bold 14px/28px Verdana, Arial, sans-serif;  }
	
	/**styling the UL list for the icons**/
	ul.barNav { list-style-type: none; }
	#footer ul.barNav li { float: left; border-right: 2px solid #cabfb6; }
	
	/**The Up and Down arrows**/
	.first { margin-left: 10px; border-left: 2px solid #cabfb6;  }
	a#arrowUp { background: url(/media/billtext/arrowUp.png) no-repeat center center; width: 25px; height: 30px; display: block; margin: 0; }
	a#arrowDown { background: url(/media/billtext/arrowDown.png) no-repeat center center; width: 25px; height: 30px; display: block; margin: 0; }
	a#arrowUp:hover { background: #c7bab0 url(/media/billtext/arrowUpH.png) no-repeat center center; }
	a#arrowDown:hover { background: #c7bab0 url(/media/billtext/arrowDownH.png) no-repeat center center; }
	
	/**The page number input**/
	li#pageN input { width: 35px; background: #d5cbc3; border: 1px solid #aea298; padding: 2px; vertical-align: top; text-align: center }
	li#pageN { height: 24px; width: 100px; padding-top: 4px; text-align: center; border-right: none; }
	li#pageN span { display: inline-block; padding-top: 2px; }
	
	/**The Search input**/
	li#searchBill input { width: 110px; background: #d5cbc3; border: 1px solid #aea298; padding: 2px 2px 2px 6px; vertical-align: center; }
	ul.barNav li#searchBill { height: 26px; padding-top: 4px; text-align: center; border-right: none; }
	
	/**Full screen icon**/
	a#fullScreen { background: url(/media/billtext/fullScreen.png) no-repeat center center; height: 30px; display: block; }
	a#fullScreen:hover { background: #c7bab0 url(/media/billtext/fullScreenH.png) center center no-repeat; }
	ul.barNav li.full { border-right: none; width: 30px; margin-left: 20px; }
	a#fullScreen:hover { background: #c7bab0 url(/media/billtext/fullScreen.png) center center no-repeat; }
	
	/**Embed icon**/
	ul/barNav li.embed { border-right: none; width: 40px; margin-left: 5px; }
	a#embedPage { background: url(/media/billtext/embed.png) no-repeat center center; width: 40px; height: 30px; display: block; margin: 0; }
	a#embedPage:hover { background: #c7bab0 url(/media/billtext/embedH.png) center center no-repeat; }
	
	/**Help icon**/
	ul.barNav li.help { border-right: none; width: 30px; margin-left: 5px; }
	a#helpNotify { background: url(/media/billtext/notify.png) no-repeat center center; height: 30px; display: block; }
	a#helpNotify:hover { background: #c7bab0 url(/media/billtext/notifyH.png) center center no-repeat; }
	
	/**Table of Contents styling**/
	ul.barNav a { display: block; font-family: Tahoma, Arial; font-size: 11px; text-transform: uppercase; text-decoration: none; font-weight: bold; color: #6a6767; margin-top: 8px; }
	ul.barNav a:visited { color: #6a6767; }
	ul.barNav a:hover { color: #514f4f; }
	ul.barNav li.toc, ul.barNav li.pagemode, ul.barNav li.zoom { padding: 0 10px 0 10px; }
	ul.barNav li.pagemode a { width: 30px; text-align: center; }
	ul.barNav li.search_nav { padding: 0 10px 0 10px; }
	#search_results { padding: 7px 10px 0 10px; height: 30px; }
	
	#embed_info { display: none; position: absolute; left: 50px; top: 150px; background: white; border: 1px solid black; padding: 10px; }
	
	</style>
	<script>
var _docid = null;
var _pagecount = null;
var _curpage = null;
var _curview = 'meta';
var _lastview = "paper";
var _searchterms = null;
var _searchresultpages = null;
var _searchnavindex = null;
var _zoomed = {% if not request.GET.zoomed == '1' %}false{% else %}true{% endif %};
var _startpage = {% if not request.GET.page %}1{% else %}parseInt("{{request.GET.page|escapejs}}"){% endif %};
var _startformat = {% if not request.GET.format %}"paper"{% else %}"{{request.GET.format|escapejs}}"{% endif %};

if (_startformat != "paper" && _startformat != "text") _startformat = "paper";

function load_document(docid) {
	_docid = docid;

	$.ajax({
	type:"GET",
	url: "/api/v1/document/" + docid,
	data: {
		api_key: "DQZUTLYRW4K1FK1O", // popvox public api key
	},
	dataType: "json",
	success: function(data, status) {
		// Document metadata.
		$('li.title').text(data.title);
		
		// Build the Table of Contents.
		var toc = $('#table_of_contents');
		for (var i in data.toc) {
			var entry = $('<div class="entry"><a class="number"/> <a class="label"/></div>');
			entry.attr('style', 'margin-left: ' + (data.toc[i].indentation*1.5) + 'em');
			entry.find('.number').text(data.toc[i].page);
			entry.find('.label').text(data.toc[i].label);
			entry.attr('page_number', data.toc[i].page);
			entry.click(function() { load_page(parseInt(this.getAttribute('page_number'))); return false; });
			toc.append(entry);
		}
		
		// State.
		_pagecount = data.pages;
		
		// Display.
		$('#pageN span').text("/ " + _pagecount);
		show_page(_startformat);
	}});
}

function show_meta(view) {
	$('.meta_view, .page_view').hide()
	if (view == 'toc') $('#table_of_contents').show();
	if (view == 'search') $('#search').show();
	_curview = 'meta';
	$('.barNav .pagemode a').text(_lastview == "paper" ? "paper" : "text");
	return false;
}

function show_page(format) {
	$('.meta_view, .page_view').hide()
	$('#page_' + format).show();
	
	_curview = format;
	_lastview = format;
	
	load_page(_curpage ? _curpage : _startpage);

	$('.barNav .pagemode a').text(_lastview == "paper" ? "text" : "paper");
	
	return false;
}

function load_page(pagenum, direction) {
	prevpage = _curpage;
	
	if (pagenum == _curpage) return;
	if (pagenum) _curpage = pagenum;
	
	$('#page_text pre').text("Loading...");
	$.ajax({
	type:"GET",
	url: "/api/v1/document/" + _docid + "/page/" + _curpage + ".txt",
	dataType: "text",
	success: function(data, status) {
		$('#page_text pre').text(data);
		$('#pageN input').val(_curpage);
		if (_curview == "meta") { // make sure page view is visible and not meta view
			if (!_searchterms)
				show_page(_lastview);
			else
				show_page("text");
		}
		
		if (_searchterms) {
			for (var i in _searchterms) {
				// create HTML-escaped and span-wrapped representation of the match
				function wrap(text) {
					var st_html = $('<div><span class="search_match"/></div>');
					st_html.find('span').text(text);
					return st_html.html();
				}
				
				// replace instances of the term with that
				st_text = _searchterms[i].replace(/[-[\]{}()*+?.,\\^$|#\s]/g, "\\$&"); // make a regex out of it so we can do case-insensitive matching
				$('#page_text pre').html( $('#page_text pre').html().replace(new RegExp(st_text, "gi"), wrap) );
			}
		}
		
		// normally reset scroll bar to top, unless we are paging backwards
		// in which case scroll to the bottom
		if (direction != -1)
			$('#center').scrollTop(0);
		else
			$('#center').scrollTop($("#center").innerHeight());
		
		update_embed_links();
	}});
	
	var imgold = $('#page_paper img');
	imgold.addClass("old");
	var img = $("<img/>").hide().css({cursor: "move"});
	var anim_target;
	var anim_value;
	if (direction == 1 || pagenum > prevpage || !imgold.length) {
		$('#page_paper .container').append(img);
		anim_target = $('#page_paper img.old');
		anim_value = -$('#page_paper .container').height();
	} else {
		img.insertBefore(imgold);
		img.css({"margin-top": -imgold.height()});
		anim_target = img;
		anim_value = 0;
	}
	img.load(function() {
		$('.loading').hide();
		img.show();
		anim_target.animate(
			{ "margin-top": anim_value },
			function() {
				imgold.remove();
				
				/*if (direction != -1) // messes with the animation
					$('#page_paper').scrollTop(0);
				else
					$('#page_paper').scrollTop($("#page_paper").innerHeight());
				*/
			});
	});
	$(window).resize(); // reset image size
	img.attr('src', "/api/v1/document/" + _docid + "/page/" + _curpage + ".png");
	$('.loading').fadeIn();
	
	//$('#arrowUp').toggle(_curpage > 1);
	//$('#arrowDown').toggle(_curpage < _pagecount);
}

function page_advance(direction) {
	if (_curpage + direction < 1 || _curpage + direction > _pagecount) return false;
	load_page(_curpage + direction, direction);
	return false;
}

function page_go_to(pagenum) {
	pagenum = parseInt(pagenum);
	if (pagenum < 1 || pagenum > _pagecount) return false;
	load_page(pagenum);
	return false;
}

function search() {
	function clear_search() {
		$('.barNav .search_nav').hide();
		_searchterms = null;
		_searchresultpages = null;
		_searchnavindex = null;
	}
	
	var q = $('#searchBill input').val();
	if (!q) {
		// similar code bellow
		$('#search_results').text("");
		clear_search();
		return false;
	}
	
	$.ajax({
	type:"GET",
	url: "/api/v1/document/" + _docid + "/search",
	data: { q: q, api_key: "XCVF0PEWJ4MG5YUA" },
	dataType: "json",
	success: function(data, status) {
		if (data.results.length == 0) {
			$('#search_results').text("Text not found in document.");
			clear_search();
			return;
		}
		
		_searchterms = data.keywords;
		_searchresultpages = data.results;
		_searchnavindex = 0;
		
		_curpage = null; // reset current page view
		show_page("text");
		load_page(_searchresultpages[0].page);
		
		$('#search_results').text('');
		$('.barNav .search_nav').show();
	}});
	return false;
}

function search_advance(direction) {
	_searchnavindex += direction;
	if (_searchnavindex == -1) _searchnavindex = _searchresultpages.length - 1;
	if (_searchnavindex == _searchresultpages.length) _searchnavindex = 0;
	load_page(_searchresultpages[_searchnavindex].page);
	return false;
}

function update_embed_links() {
	$('#embed_link').val("{{request.GET.baseurl|escapejs}}#page=" + _curpage + (_zoomed ? ",zoomed=1" : "") + (_curview != "paper" ? ",format=text" : ""));
	$('#embed_widget').val("<script src=\"https://{{request.get_host|escapejs}}/widgets/bill-text.js?docid={{request.GET.docid|escapejs}}" + (_curpage > 1 ? "&page=" + _curpage : "") + (_zoomed ? "&zoomed=1" : "") + (_curview != "paper" ? "&format=text" : "") + "\"> <" + "/script>");
}

$(function() {
	$(window).resize(function() {
		// set container sizes to window size so that any overflow brings up inner scroll bars
		// and doesn't push the footer below the fold. we do this for page_paper even though
		// #center takes care of it so that we can use jquery.scrollview on the paper mode
		// but not the text view.
		$('#center, #page_paper').height($(window).height() - $('#header').height() - $('#footer').height());
		//$('#footer .zoom').toggle($(window).height() > 500);
		if ($(window).height() <= 600 && !_zoomed)
			$('#page_paper img').attr('height', 600).attr('width', '');
		else if ($(window).height() > 600 && !_zoomed)
			$('#page_paper img').attr('height', $('#page_paper').height() - 35).attr('width', '');
		else if ($(window).width() > 768 && !_zoomed)
			$('#page_paper img').attr('width', 768-60).attr('height', '');
		else
			$('#page_paper img').attr('width', $(window).width()-60).attr('height', '');
		
		$('#embed_info').width($(window).width() - 120);
		
		$('#footer').show(); // don't show until the sizes have been set to avoid flicker
	});
	$(window).resize();
	
	load_document(parseInt("{{request.GET.docid|escapejs}}"));
	
	$('#searchBill input').keydown_enter(search);
	
	$("#page_paper").scrollview({});
	
	$('#center').click(function() { $('#embed_info').hide(); });
});
	</script>
	</head>
	<body>
	<div class="content">
		<div id="header">
			<ul class="barNav">
				<li class="title"></li>
			</ul>
		</div>
		
		<div id="center">
		
			<div id="table_of_contents" class="meta_view">
				<h2>Table of Contents</h2>
			</div>
			
			<div id="page_paper" class="page_view">
				<div class="container">
					<div class="loading">Loading...</div>
				</div>
			</div>
		
			<div id="page_text" class="page_view">
				<pre/>
			</div>
		
		</div>
		
		<div id="footer" style="display: none;">
			<ul class="barNav">
				<li class="first"><a href="#" id="arrowUp" onclick="return page_advance(-1)"></a></li>
				<li><a href="#" id="arrowDown" onclick="return page_advance(1)"></a></li>
				<li id="pageN"><input value="__" onchange="return page_go_to(this.value);"></input> <span>__</span></li>
				
				<li id="searchBill"><input placeholder="Search"></input></li>
				<li class="search_nav search_prev"><a href="#" onclick="return search_advance(-1)">&lt; Prev</a></li>
				<li class="search_nav search_next"><a href="#" onclick="return search_advance(+1)">Next&gt;</a></li>
				<li id="search_results"></li>
			
				<!--<li class="full"><a id="fullScreen" href="#"></a></li>-->
				<li class="pagemode"><a href="#" onclick="_curview != 'meta' ? show_page(_lastview == 'paper' ? 'text' : 'paper') : show_page(_lastview); update_embed_links(); return false;">Text</a></li>
				<!--<li class="help"><a id="helpNotify" href="#"></a></li>-->
				<li class="toc"><a href="#" onclick="return _curview != 'meta' ? show_meta('toc') : show_page(_lastview);">Table Of Contents</a></li>
				
				<li class="zoom"><a href="#" onclick="_zoomed = !_zoomed; $(window).resize(); update_embed_links(); return false;">Zoom</a></li>
				
				<li class="embed"><a id="embedPage" href="#" onclick="$('#embed_info').toggle(); return false;"></a></li>
			</ul>
		</div>
		
		<div id="embed_info">
			{% if request.GET.baseurl %}
			<p>Link to this page:</p>
			<textarea id="embed_link" style="width: 100%;" rows="2"></textarea>
			{% endif %}
			
			<p>Embed widget:</p>
			<textarea id="embed_widget" style="width: 100%;" rows="2"></textarea>
		</div>
	</div>
	</body>
</html>

