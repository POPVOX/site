{% load humanize %}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
	<head>
		<title>Comments Map - United States - {{bill}}</title>
		<link rel="stylesheet" href="/media/master/map_style.css" type="text/css" media="screen" /> 

		<style>
			body {
				margin: 0;
				padding: 0;
				{% if request.GET.background == "white" %}background: white;{% endif %}
			}
			
			#mapdots .dots { display: none; }
		</style>
		<script type="text/javascript" src="/media/js/jquery-1.4.3.min.js"></script>
		<script>
			var visible = false;
			var dot_x, dot_y;
			var shown = 0;

			/*var last_mouse_pos;
			function mousemove(event) {
				if (last_mouse_pos && visible && !showing) {
					if (event.pageX > last_mouse_pos.pageX && dot_x > 252) {
						if (!$('#infobox').hasClass("lefty")) {
							$('#infobox').addClass("lefty");
							$('#infobox').css({left: dot_x - 252});
						}
					} else {
						if ($('#infobox').hasClass("lefty") && dot_x < 940-252-50-5) {
							$('#infobox').removeClass("lefty");
							$('#infobox').css({left: dot_x + 50+5});
						}
					}
				}
				last_mouse_pos = event;
			}
			$(document).mousemove(mousemove);*/

			function show(){
				var district = this.getAttribute("pv_district");
				var label = this.getAttribute("pv_label");
				var x = parseInt(this.getAttribute("pv_left"));
				var y = parseInt(this.getAttribute("pv_top"));
				
				$('#infobox').show();
				showing = true;

				/*if (district.substr(2) == "0"){
					$('#infobox img').hide();
				} else {
					$('#infobox img').show();
					district2 = district.substr(0, 2) + (district.length == 3 ? "0" : "") + district.substr(2);
					$('#infobox img').attr('src', 'https://s3.amazonaws.com/govtrackus/printabledistrictmaps/' + district2 + '_1200_context.png');
				}*/
				
				$('#infobox div').text(label);
				
				{% if bill or request.GET.point == "allcount" %}
				var support = parseFloat(this.getAttribute("pv_support"));
				var count = parseInt(this.getAttribute("pv_count"));
				$('#support').text(Math.round(support*100) + "%")
				$('#oppose').text(Math.round((1.0-support)*100) + "%")
				$('#activity').text("(" + count + " user" + (count > 1 ? "s" : "") + ")")
				{% endif %}
				
				$('#infobox').removeClass("lefty");
				dot_x = x;
				x += 50 + 5;
				if (x + 252 > {{width}}) {
					$('#infobox').addClass("lefty");
					x = x - 252 - 50 - 5;
				}

				y = y - 50;

				if (!visible) {
					$('#infobox').css({left: x, top: y, opacity: 100});
				} else {
					$('#infobox').stop();
					$('#infobox').animate({left: x, top: y, opacity: 100});
				}

				shown++;
				visible = true;

				setTimeout("showing = false;", 500);
			}

			function hide() {
				setTimeout("if (shown==" + shown + ") $('#infobox').fadeOut(function() { visible = false; })", 500);
			}

			var curcolmode = "1";
			function togglecolors() {
				if (curcolmode == "1") {
					curcolmode = "2";
				} else {
					curcolmode = "1";
				}
				$('body').removeClass('colormode_1');
				$('body').removeClass('colormode_2');
				$('body').addClass('colormode_' + curcolmode);
				$('#colormode').text(curcolmode == "1" ? "Alternate Colors" : "Original Colors");
			}

			$(function() {
				$('#mapdots .dot_sz_1').fadeIn(4000);
				$('#mapdots .dot_sz_2').fadeIn(3000);
				$('#mapdots .dot_sz_3').fadeIn(2000);
				$('#mapdots .dot_sz_4').fadeIn(1000);
				$('#mapdots .dot_sz_5').fadeIn(0500);
			});
			
			/* totals: {{totals}} */
		</script>
	</head>
	<body class="colormode_1 width_{{width}}">
		<div id="mapdots">
		{% for district, count in data %}
			<a href="{{bill.url}}/report#{{count.href}}" target="_top"
				pv_district="{{district}}" pv_label="{{count.label}}"
				{% if bill or request.GET.point == "allcount" %}pv_support="{{count.sentiment}}" pv_count="{{count.count}}"{% endif %}
				pv_left="{{count.coord.left}}" pv_top="{{count.coord.top}}">
				<div style="position: absolute; left: {{count.coord.left}}px; top: {{count.coord.top}}px;" class="dots {{count.class}}"></div>
			</a>
		{% endfor %}
		<div id="infobox" style="display: none;">
			<div id="district"> </div>
			{% if bill or request.GET.point == "allcount" %}<p><span id="support"></span> <span id="oppose"> </span> <span id="activity"> </span></p>{% endif %}
		</div>
		</div>
		
		<script>
		{% if request.GET.hover != "0" %}
			$('#mapdots a').hover(show, hide);
			{% if request.GET.sac %}$('#mapdots a').click(function(event) { event.preventDefault(); });{% endif %}
		{% else %}
			$('#mapdots a').click(show);
			$('#mapdots a').click(function(event) { event.preventDefault(); event.stopPropagation(); });
			$('#mapdots').click(hide);
		{% endif %}
		</script>
		
		<div id="colormode" title="Switch Colors" onclick="togglecolors()">Alternate Colors</div>
	
		{% if bill or request.GET.point == "allcount" %}
		<div id="legend_clr">
			<div class="label first">{% if bill %}Support{% else %}D{% endif %}</div>
			<div class="dotholder">
			<div class="dots dot_sz_3 dot_clr_5"> </div>
			<div class="dots dot_sz_3 dot_clr_4"> </div>
			<div class="dots dot_sz_3 dot_clr_3"> </div>
			<div class="dots dot_sz_3 dot_clr_2"> </div>
			<div class="dots dot_sz_3 dot_clr_1"> </div>
			</div>
			<div class="label last">{% if bill %}Oppose{% else %}R{% endif %}</div>
		</div>
		{% if max_sz_num != min_sz_num %}
		<div id="legend_sz">
			<div class="label first">{{max_sz_num}} {% if bill %}User{% else %}Pos'n{% endif %}{{max_sz_num|pluralize}}</div>
			<div class="dotholder">
			<div class="dots dot_sz_5 dot_clr_3"> </div>
			<div class="dots dot_sz_4 dot_clr_3"> </div>
			<div class="dots dot_sz_3 dot_clr_3"> </div>
			<div class="dots dot_sz_2 dot_clr_3"> </div>
			<div class="dots dot_sz_1 dot_clr_3"> </div>
			</div>
			<div class="label last">{{min_sz_num}} {% if bill %}User{% else %}Pos'n{% endif %}{{min_sz_num|pluralize}}</div>
		</div>
		{% endif %}
		{% endif %}
		<div id="legend_text">
			Circles are Congressional Districts.
		</div>
		
		<div id="brought_to_you"> </div>
	</body>
</html>

