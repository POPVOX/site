{% load humanize %}
{% load popvox_utils %}
{% comment %}
Integration Information

For Drupal or other PHP:
------------------------
<?php
   global $user;
   $user_info = array(
      "email" => $user->mail,
      
      # Include only the fields which you will actually provide.
      #"first_name" => "",
      #"last_name" => "",
      #"zipcode" => "",
      #"prefix" => "",
      #"suffix" => "",
      #"address1" => "",
      #"address2" => "",
      #"city" => "",
      #"state" => "",
      #"phonenumber" => "",
      
      # Use this only if the user has been logged in with a username and password
      #"authentication_hmac" => hash_hmac("sha256", $user->mail, "SECRET KEY"),
   );
   echo "#user_info=" . urlencode(http_build_query($user_info, "", "&"));
?>

Notes:
* "SECRET KEY" is a secret API key associated with the client's account on POPVOX. It must be kept secret (i.e. NOT used client-side).
* The entire data structure is placed into the URL *fragment* at the very end of the iframe SRC attribute, as "#user_info=[url-encoded-user-data]".
* [url-encoded-user-data] is a querystring-like encoding of the data structure which is then URL-encoded (fields are basically encoded a second time).
* All of the fields are optional -- don't include them at all if you don't have the data. Fields that are restricted to values from a list (e.g. prefix) will be ignored if they aren't in our list, and the user will be asked to choose.
* The authentication_hmac parameter should only be used if the user accessing the page is logged in (with the email address given) --- if the value is made available to someone else, they will be able to impersonate the user.

{% endcomment %}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head profile="http://gmpg.org/xfn/11">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8" /><!--[if lte IE 7]><meta http-equiv="X-UA-Compatible" content="chrome=1"><![endif]--> 

    <title>write congress widget // POPVOX</title>
    
    <!-- {{permissions}} -->
    <!-- test -->
    
    <link rel="stylesheet" href="/media/master/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="/media/widgets/css/writecongress.css" type="text/css" media="screen" />

    <script type="text/javascript" src="/media/js/jquery.js"></script>
    <script type="text/javascript" src="/media/js/ajaxforms.js"></script>
    <script type="text/javascript" src="/media/js/jquery.ba-bbq.min.js"></script>
    
    <script type="text/javascript" src="/media/js/highcharts.js"></script>
    <script type="text/javascript" src="/media/js/charts.js"></script>
    
    <link type="text/css" href="/media/js/jquery.jscrollpane.css" rel="stylesheet" media="all" />
    <script type="text/javascript" src="/media/js/jquery.mousewheel.js"></script>
    <script type="text/javascript" src="/media/js/mwheelIntent.js"></script>
    <script type="text/javascript" src="/media/js/jquery.jscrollpane.min.js"></script>  
    
    <script type="text/javascript">var bill_display_number = "{%if bill%}{{bill.shortname|escapejs}}{%else%}{{regulation.regnumber|escapejs}}{%endif%}";</script>
    <script src="/media/js/lettertips.js"> </script>

<script type="text/javascript">
    (function(c,a){window.mixpanel=a;var b,d,h,e;b=c.createElement("script");
    b.type="text/javascript";b.async=!0;b.src=("https:"===c.location.protocol?"https:":"http:")+
    '//cdn.mxpnl.com/libs/mixpanel-2.2.min.js';d=c.getElementsByTagName("script")[0];
    d.parentNode.insertBefore(b,d);a._i=[];a.init=function(b,c,f){function d(a,b){
    var c=b.split(".");2==c.length&&(a=a[c[0]],b=c[1]);a[b]=function(){a.push([b].concat(
    Array.prototype.slice.call(arguments,0)))}}var g=a;"undefined"!==typeof f?g=a[f]=[]:
    f="mixpanel";g.people=g.people||[];h=['disable','track','track_pageview','track_links',
    'track_forms','register','register_once','unregister','identify','alias','name_tag','set_config',
    'people.set','people.set_once','people.increment','people.track_charge','people.append'];
    for(e=0;e<h.length;e++)d(g,h[e]);a._i.push([b,c,f])};a.__SV=1.2;})(document,window.mixpanel||[]);
    mixpanel.init('{{MIXPANEL_TOKEN}}');
</script>

    <style>
    {% if request.GET.iframe %}
    body {
        padding: 0;
        margin: 0;
        overflow: hidden;
    }
    #widget_body {
        overflow: hidden;
    }
    {% endif %}

    {% if request.ua.ua_family == "Firefox" and request.ua.os_family != "Mac OSX" %}
    {% endif %}
    
    #widget_body .btn.next_oppose, #widget_body .btn.next_support { margin: 20px 0;}
    #widget_body p.or { display: block; width: 40px; height: 47px; float: left; font-weight: bold; margin: 20px 0 0; padding: 15px 0 0; text-align: center; }

    {% if "widget_theme" in permissions and request.GET.bg %}
    body, input, textarea, select, h4.congrats { background-color: #{{request.GET.bg}}; color: #{{request.GET.fg}}; }
    .optional, input[disabled] { color: #{{request.GET.fg2}}; }
    a { color: #{{request.GET.lnk}}; }
    p.error {
        color: red;
        font-size: 16px;
        font-weight: bold;
    }
    /*
    #widget_top ul { background: url(/services/widgets/img/writecongress/2?sub=C76825,{{request.GET.sbg}}&sub=FFFFFF,{{request.GET.bg}}&sub=75747C,{{request.GET.fg}}&sub=E7E4DD,{{request.GET.sbg2}}&sub=00AEEF,{{request.GET.sfg}}&sub=EC0082,{{request.GET.sbg2}},darken) right -7px no-repeat; height: 32px; }
    #widget_top ul li.tab_2 { background: url(/services/widgets/img/writecongress/2?sub=C76825,{{request.GET.sbg}}&sub=FFFFFF,{{request.GET.bg}}&sub=75747C,{{request.GET.fg}}&sub=E7E4DD,{{request.GET.sbg2}}&sub=00AEEF,{{request.GET.sfg}}&sub=EC0082,{{request.GET.sbg2}},darken) -10px -7px no-repeat; }
    #widget_top ul li.tab_3 { background: url(/services/widgets/img/writecongress/3?sub=C76825,{{request.GET.sbg}}&sub=FFFFFF,{{request.GET.bg}}&sub=75747C,{{request.GET.fg}}&sub=E7E4DD,{{request.GET.sbg2}}&sub=00AEEF,{{request.GET.sfg}}&sub=EC0082,{{request.GET.sbg2}},darken) -10px -7px no-repeat; }
    #widget_top ul li.tab_4 { background: url(/services/widgets/img/writecongress/4?sub=C76825,{{request.GET.sbg}}&sub=FFFFFF,{{request.GET.bg}}&sub=75747C,{{request.GET.fg}}&sub=E7E4DD,{{request.GET.sbg2}}&sub=00AEEF,{{request.GET.sfg}}&sub=EC0082,{{request.GET.sbg2}},darken) -10px -7px no-repeat; }
    #widget_top ul li.tab_1.active { background: url(/services/widgets/img/writecongress/1?sub=C76825,{{request.GET.sbg}}&sub=FFFFFF,{{request.GET.bg}}&sub=75747C,{{request.GET.fg}}&sub=E7E4DD,{{request.GET.sbg2}}&sub=00AEEF,{{request.GET.sfg}}&sub=EC0082,{{request.GET.sbg}},darken) left -7px no-repeat; }
    #widget_top ul li.tab_2.active { background: url(/services/widgets/img/writecongress/2?sub=C76825,{{request.GET.sbg}}&sub=FFFFFF,{{request.GET.bg}}&sub=75747C,{{request.GET.fg}}&sub=E7E4DD,{{request.GET.sbg2}}&sub=00AEEF,{{request.GET.sfg}}&sub=EC0082,{{request.GET.sbg}},darken) -10px -38px no-repeat; }
    #widget_top ul li.tab_3.active { background: url(/services/widgets/img/writecongress/3?sub=C76825,{{request.GET.sbg}}&sub=FFFFFF,{{request.GET.bg}}&sub=75747C,{{request.GET.fg}}&sub=E7E4DD,{{request.GET.sbg2}}&sub=00AEEF,{{request.GET.sfg}}&sub=EC0082,{{request.GET.sbg}},darken) -10px -38px no-repeat; }
    #widget_top ul li.tab_4.active { background: url(/services/widgets/img/writecongress/4?sub=C76825,{{request.GET.sbg}}&sub=FFFFFF,{{request.GET.bg}}&sub=75747C,{{request.GET.fg}}&sub=E7E4DD,{{request.GET.sbg2}}&sub=00AEEF,{{request.GET.sfg}}&sub=EC0082,{{request.GET.sbg}},darken) -10px -38px no-repeat; }
    #widget_top ul li.tab_1.complete { background: url(/services/widgets/img/writecongress/1?sub=C76825,{{request.GET.sbg}}&sub=FFFFFF,{{request.GET.bg}}&sub=75747C,{{request.GET.fg}}&sub=E7E4DD,{{request.GET.sbg2}}&sub=00AEEF,{{request.GET.sfg}}&sub=EC0082,{{request.GET.sbg}},darken) left -38px no-repeat; }
    #widget_top ul li.tab_2.complete { background: url(/services/widgets/img/writecongress/2?sub=C76825,{{request.GET.sbg}}&sub=FFFFFF,{{request.GET.bg}}&sub=75747C,{{request.GET.fg}}&sub=E7E4DD,{{request.GET.sbg2}}&sub=00AEEF,{{request.GET.sfg}}&sub=EC0082,{{request.GET.sbg}},darken) -10px -69px no-repeat; }
    #widget_top ul li.tab_3.complete { background: url(/services/widgets/img/writecongress/3?sub=C76825,{{request.GET.sbg}}&sub=FFFFFF,{{request.GET.bg}}&sub=75747C,{{request.GET.fg}}&sub=E7E4DD,{{request.GET.sbg2}}&sub=00AEEF,{{request.GET.sfg}}&sub=EC0082,{{request.GET.sbg}},darken) -10px -69px no-repeat; }
    */

    
    .btn.next { background: url(/services/widgets/img/writecongress/next?sub=C66825,{{request.GET.sbg}}&sub=00AEEF,{{request.GET.sfg}}&sub=864817,{{request.GET.fg2}}&sub=EC0082,{{request.GET.sbg}},darken) no-repeat; }
    .btn.next_support { background: url(/services/widgets/img/writecongress/support-btn?sub=C66825,{{request.GET.sbg}}&sub=00AEEF,{{request.GET.sfg}}&sub=844817,{{request.GET.fg2}}&sub=EC0082,{{request.GET.sbg}},darken) no-repeat; }
    .btn.next_oppose { background: url(/services/widgets/img/writecongress/oppose-btn?sub=C66825,{{request.GET.sbg}}&sub=00AEEF,{{request.GET.sfg}}&sub=844817,{{request.GET.fg2}}&sub=EC0082,{{request.GET.sbg}},darken) no-repeat; }
    .btn.next_neutral { background: url(/services/widgets/img/writecongress/support-btn?sub=C66825,{{request.GET.sbg}}&sub=00AEEF,{{request.GET.sfg}}&sub=844817,{{request.GET.fg2}}&sub=EC0082,{{request.GET.sbg}},darken) no-repeat; }

    .why a.expand { background-image: url(/services/widgets/img/writecongress/expand?sub=C56825,{{request.GET.sbg}}&sub=00AEEF,{{request.GET.sfg}}&sub=EC0082,{{request.GET.sbg}},darken); }

    #panel_write_why_reason { border-bottom: 1px solid #D1D1CF; clear: both; display: block; padding-top: 10px;}
    #b_send_no_msg { background-image: url(b_send_no_msg.png); }
    #b_preview { background: url(/services/widgets/img/writecongress/preview?sub=C66825,{{request.GET.sbg}}&sub=00AEEF,{{request.GET.sfg}}&sub=EC0082,{{request.GET.sbg}},darken) no-repeat; }
    #b_send_to_congress a { background-image: url(/services/widgets/img/writecongress/send?sub=C66825,{{request.GET.sbg}}&sub=00AEEF,{{request.GET.sfg}}&sub=EC0082,{{request.GET.sbg}},darken);
    {% if 'whitehouse' in permissions %}
    background-image: url(/media/master/b_send_to_congress_wh_blue.png){% endif %}
    {% if regulation %}background-image: url(/media/master/b_send_message.png); height: 56px;{% endif %}
    }
    {% endif %}


    #widget_top li span{
        background: #{{request.GET.bgc1}} !important;
    }

    {%if request.GET.sbg %}
    #widget_top li.active span{
        background: #{{request.GET.sbg}} !important;
        color: #fff;
    }
    {% endif %}

    @media screen and (min-width: 420px){
        #widget_top li:nth-of-type(1).active span:after{
            content:" Start";
        }
        #widget_top li:nth-of-type(4).active span:after{
            content:" Finish";
        }
    }


    
    </style>
    
    <script type="text/javascript">
        // Initialization //
        
        {% if not request.GET.demo %}
        var mixpanel_properties = {
            {% if campaign %}bucket: "{{campaign.mixpanel_bucket|escapejs}}",{% endif %}
            bill: "{%if bill%}{{bill.shortname|escapejs}}{%else%}{{regulation.regnumber|escapejs}}{%endif%}"
        };
        mixpanel.track('widget_writecongress_hit', mixpanel_properties);
        {% endif %}
        
        // General //

        var technical_difficulties = "We're having some technical difficulty. Please try again. If the problem persists, please reload the page."; // might be csrf if they logged in at pv while doing this
    
        var working = false;
        $('html').ajaxStart(function() { working = true; });
        $('html').ajaxStop(function() { working = false; });
    
        var panel_width = 420;
        var current_panel = 1;
        var sliding = false;
        function show_panel(idx) {
            if (sliding) return;
            sliding = true;
            
            $("#progress li").removeClass("active");
            $("#progress li").removeClass("complete");
            var tab_index = (idx == 1 ? idx : idx-1);
            for (var i = 1; i < tab_index; i++)
                $("#progress li.tab_" + i).addClass("complete");
            $("#progress li.tab_" + tab_index).addClass("active");
            
            var cur = $($("#panel_holder .widget_panel")[current_panel-1]);
            var next = $($("#panel_holder .widget_panel")[idx-1]);
            
            var left = cur.css("left");
            
            cur.animate(
                {left: idx>current_panel ? -panel_width : panel_width},
                function() {
                    cur.hide(); // if we don't hide it, then the user can tab through to its controls which causes scrolling
                    current_panel = idx;
                    sliding = false;
                }
            );
            
            next.show();
            next.css({ left: idx>current_panel ? panel_width : -panel_width });
            next.animate({left: left});
            
            return false;
        }
        
        var position = null;
        var email_status = null;
        var csrf_token = null;
        var identity = null;
        
        var hash_args = $.deparam.fragment();
        var hash_user_info = null;
        if (hash_args.user_info) {
            hash_user_info = $.deparam(decodeURI(hash_args.user_info));
            $(function() {
                if (hash_user_info.email) $('#email').set_text(hash_user_info.email);
                if (hash_user_info.first_name) $('#firstname').set_text(hash_user_info.first_name);
                if (hash_user_info.last_name) $('#lastname').set_text(hash_user_info.last_name);
                if (hash_user_info.zipcode) $('#zipcode').set_text(hash_user_info.zipcode);
            });
        }
        if (document.cookie.indexOf("sessionid") >= 0 || (hash_user_info && hash_user_info.authentication_hmac)) {
            // If the user appears to be logged in, or we have a hash argument that authenticates
            // the user's email address from the calling website, then pre-fill the form fields
            // with the user's information once the page has loaded.
            $(function() {
                $.ajax({
                        url: window.location.pathname,
                        data: {
                            action: "get-user-info",
                            email: (hash_user_info ? hash_user_info.email : null),
                            email_auth_hmac: (hash_user_info ? hash_user_info.authentication_hmac : null)
                        },
                        type: "POST",
                        dataType: "json",
                        success: function(data, textStatus, jqXHR) {
                            if (data.identity) {
                                identity = data.identity;
                                $('#email').set_text(data.identity.email);
                                // guard against the user being registered but not having
                                // any address information.
                                if (data.identity.firstname) $('#firstname').set_text(data.identity.firstname);
                                if (data.identity.lastname) $('#lastname').set_text(data.identity.lastname);
                                if (data.identity.zipcode) $('#zipcode').set_text(data.identity.zipcode);
                            }
                        }
                    });
            });
        }
        
        function check_email() {
            if (working || $('#email').prop('disabled')) return;
            
            $("#panel_login .error").text("");
            
            var email = $('#email').val();
            if (email.indexOf("@") == -1) return false;
            
            $.ajax({
                    url: window.location.pathname,
                    data: {
                        {% if request.GET.demo %}demo: true,{% endif %}
                        {% if campaign %}campaign: {{campaign.id}},{% endif %}
                        {%if bill%}bill: {{bill.id}}{%else%}bill: ""{%endif%},
                        {%if regulation%}regulation: {{regulation.id}}{%else%}regulation: ""{%endif%},
                        action: "check-email",
                        email: email
                    },
                    type: "POST",
                    dataType: "json",
                    success: function(data, textStatus, jqXHR) {
                        if (data.status == "fail") {
                            $("#panel_login .error").text(data.msg);
                            return;
                        }
                        
                        email_status = data.status;

                        $('#unregistered input, #registered_password input').prop("disabled", true);
                        //$('#panel_login .check').hide();
                        $('#panel_login .next').addClass("disabled");
                        
                        if (data.status == "invalid-email") {
                            $("#panel_login .error").text("That's not a valid email address.");
                        } else if (data.status == "staff-cant-do-this") {
                            $("#panel_login .error").text("That's a staff account. Use a different email address for personal comments to Congress.");
                        } else if (data.status == "already-commented") {
                            $("#panel_login .error").text("You've already left a comment. Thanks!");
                        } else {
                            csrf_token = data.csrf_token;
                            //$('#panel_login .check').show();
                            $('#unregistered input, #registered_password input').prop("disabled", false);
                            $('#panel_login .next').removeClass("disabled");
                            
                            if (identity && identity.email == email) {
                                email_status = "logged-in";
                            } else if (email_status == "not-registered") {
                                $('#unregistered').show();
                                $('#registered_password, #registered_sso').hide();

                                $('#password').attr("tabindex",84);
                                $('#firstname').attr("tabindex",2);
                                $('#lastname').attr("tabindex",3);
                                $('#zipcode').attr("tabindex",4);
                                {%if 'email_optin' in permissions %}$('#email_optin').attr("tabindex",5);{%endif%}
                                $('#panel_login .next').show();
                            } else {
                                $('#unregistered').hide();
                                
                                $('#registered_password, #panel_login .next, #registered_sso').hide();
                                
                                if (data.has_password) {
                                    $('#registered_password, #panel_login .next').show();
                                    $('#email').attr("tabindex",2);
                                    $('#firstname').attr("tabindex",84);
                                    $('#lastname').attr("tabindex",85);
                                    $('#zipcode').attr("tabindex",86);
                                    {%if 'email_optin' in permissions %}$('#email_optin').attr("tabindex",3);{%endif%}
                                } else if (data.sso_methods.length > 0) {
                                    $('#registered_sso').show();
                                } // had better be one or the other, but give preference to password
                                  
                                $('#registered_sso .singlesignon li a').hide();
                                for (var i = 0; i < data.sso_methods.length; i++)
                                    $('#registered_sso .singlesignon li a.social_' + data.sso_methods[i]).show();
                            }
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        $("#panel_login .error").text(technical_difficulties);
                    }
                });
            
            return false;
        }
        
        function forgot_password() {
            // rather than sending the user off to get his password, which would result
            // in him getting logged in and then causing CSRF problems here, we just
            // let him go through by entering his information from scratch and confirming
            // his email at the end like normal
            if (working) return;
            email_status = "not-registered";
            $('#email').prop('disabled', true);
            $('#unregistered').show();
            $('#registered_password, #registered_sso').hide();
            $('#panel_login .next').show();
            return false;
        }
        
        function warn_missing_data(items) {
            // collapse the non-null items
            var r = Array();
            for (var i = 0; i < items.length; i++)
                if (items[i] != null)
                    r[r.length] = items[i];
            if (r.length == 0) return false;
            
            if (r.length > 1)
                r[r.length-1] = "and " + r[r.length-1];
            if (r.length > 2)
                for (var i = 0; i < r.length - 1; i++)
                    r[i] += ",";
            
            alert("Enter " + r.join(" ") + " to continue.");
            return true;
        }
        
        function do_login(chosen_position) {
            if (working) return false;

            if (email_status != "not-registered" && email_status != "registered" && email_status != "logged-in") {
                $("#panel_login .error").text();
                return false;
            }

            {% if not request.GET.demo %}
            mixpanel_properties.position = chosen_position;
            mixpanel.track('widget_writecongress_start', mixpanel_properties);
            {% endif %}

            position = chosen_position;
            var position_verb_text;
            if(position == '+') { position_verb_text = "support"; }
            else if(position == '-') { position_verb_text = "oppose"; }
            else { position_verb_text = "neutral" }
            $('.position_verb').text(position_verb_text);
            $('#panel_write h4, #msg_preview .firstpara').addClass(position_verb_text);
            {% if 'franking' in permissions or regulation %}
            {% else %}
            $('#message').text("I " + (position == "+" ? "support" : "oppose") + " {{bill.title_parens_if_too_long|escapejs}} because...");
            {% endif %}
            if ($("#panel_login .next").hasClass("disabled")) return false;
            var data;
            
            if (email_status != "registered") {
                // creating an account later on, but collectinig this information now
                if (warn_missing_data([
                    $("#firstname").hasClass("default") || $("#firstname").val()=="" ? "your first name" : null,
                    $("#lastname").hasClass("default") || $("#lastname").val()=="" ? "your last name" : null,
                    $("#zipcode").hasClass("default") || $("#zipcode").val()=="" ? "your zip code" : null
                    ])) return;
                
                data = {
                    {% if request.GET.demo %}demo: true,{% endif %}
                    {% if campaign %}campaign: {{campaign.id}},{% endif %}
                    action: email_status == "registered" ? "newuser" : "logged-in",
                    email: $("#email").val(),
                    firstname: $("#firstname").val(),
                    lastname: $("#lastname").val(),
                    zipcode: $("#zipcode").val(),
                    {%if 'email_optin' in permissions %}email_optin: $("#email_optin").prop('checked') ? "1" : "0",{%endif%}
                    };
                
            } else {
                // only used if logging in with password
                if ($("#password").hasClass("default") || $('#password').val() == "") { alert("Enter your password to log in."); return false; }
            
                data = {
                    {% if request.GET.demo %}demo: true,{% endif %}
                    {% if campaign %}campaign: {{campaign.id}},{% endif %}
                    action: "login",
                    email: $("#email").val(),
                    password: $("#password").val(),
                    {%if 'email_optin' in permissions %}email_optin: $("#email_optin").prop('checked') ? "1" : "0",{%endif%}
                    };
            }

            $.ajax({
                    url: window.location.pathname,
                    data: data,
                    type: "POST",
                    dataType: "json",
                    success: function(data, textStatus, jqXHR) {
                        if (data.status == "fail") {
                            $("#panel_login .error").text(data.msg);
                        } else {
                            $("#panel_login .error").text("");
                            // the original log in may have given us address info- don't overwrite it.
                            if (!identity) identity = Object();
                            for (var key in data.identity)
                                identity[key] = data.identity[key];
                            show_address();
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        $("#panel_login .error").text(technical_difficulties);
                    }
                });
            
            return false;
        }
        
        function logout() {
            if (working) return;
            identity = null;
            $('#login').show();
            $('#loggedinalready').hide();
            $('#panel_login .next').addClass("disabled");
            return false;
        }
        
        /*function start_single_sign_on(elem) {
            window.location = elem.getAttribute("href").replace("__NEXT__",
                "{{request.get_full_path|escapejs}}&api_nonce=" + encodeURIComponent(api_nonce));
            return false;
        }*/
        
        function show_address() {
            show_panel(2);
            
            $('#useraddress_firstname').text(identity.firstname);
            $('#useraddress_lastname').text(identity.lastname);
            $('#useraddress_state').text(identity.state);
            $('#useraddress_zipcode').text(identity.zipcode);
            $('#useraddress_prefix').val(identity.nameprefix);
            $('#useraddress_suffix').val(identity.namesuffix);
            $('#useraddress_address1').val(identity.address1);
            $('#useraddress_address2').val(identity.address2);
            $('#useraddress_city').val(identity.city);
            $('#useraddress_phonenumber').val(identity.phonenumber);
            
            if (hash_user_info) {
                function normalize_if_valid(value, values) {
                    for (var i = 0; i < values.length; i++) {
                        if (value.toLowerCase().replace(".", "") == values[i].toLowerCase().replace(".", ""))
                            return values[i];
                        if (value.toLowerCase().replace(".", "") == "rev" && values[i] == "Reverend")
                            return values[i];
                    }
                    return "";
                }
                
                if (hash_user_info.prefix) $('#useraddress_prefix').val(normalize_if_valid(hash_user_info.prefix, {{useraddress_prefixes|json}}));
                if (hash_user_info.suffix) $('#useraddress_suffix').val(normalize_if_valid(hash_user_info.suffix, {{useraddress_suffixes|json}}));
                if (hash_user_info.address1) $('#useraddress_address1').val(hash_user_info.address1);
                if (hash_user_info.address2) $('#useraddress_address2').val(hash_user_info.address2);
                if (hash_user_info.city) $('#useraddress_city').val(hash_user_info.city);
                if (hash_user_info.phonenumber) $('#useraddress_phonenumber').val(hash_user_info.phonenumber);
            }
            
            {% if request.GET.debug %}
            if (!identity.nameprefix) {
                $('#useraddress_prefix').set_text("Mr.");
                $('#useraddress_address1').set_text("100 Debug Noname Street");
                $('#useraddress_city').set_text("Nowherevill Debug");
                $('#useraddress_phonenumber').set_text("(123) 456-7890 x12");
            }
            {% endif %}
            
        }
        
        var recipients;
        var cdyne_response;
        
        function do_address() {
            if (working) return;
            
            $.ajax({
                    url: window.location.pathname,
                    data: {
                        {% if request.GET.demo %}demo: true,{% endif %}
                        {% if campaign %}campaign: {{campaign.id}},{% endif %}
                        {%if bill%}bill: {{bill.id}}{%else%}bill: ""{%endif%},
                        {%if regulation%}regulation: {{regulation.id}}{%else%}regulation: ""{%endif%},
                        action: "address",
                        email: identity.email,
                        {%if 'email_optin' in permissions %}
                        email_optin: $('#email_optin').prop('checked') ? "1" : "0",{%endif%}
                        useraddress_prefix: $("#useraddress_prefix").val(),
                        useraddress_firstname: identity.firstname,
                        useraddress_lastname: identity.lastname,
                        useraddress_suffix: $("#useraddress_suffix").val(),
                        useraddress_address1: $("#useraddress_address1").val(),
                        useraddress_address2: $("#useraddress_address2").val(),
                        useraddress_city: $("#useraddress_city").val(),
                        useraddress_state: identity.state,
                        useraddress_zipcode: identity.zipcode,
                        {% if tagvals %}
                        useraddress_tag: $("#useraddress_tag").val(),
                        {% endif %}
                        useraddress_phonenumber: $("#useraddress_phonenumber").val()
                    },
                    type: "POST",
                    dataType: "json",
                    success: function(data, textStatus, jqXHR) {
                        if (data.status == "fail") {
                            $("#panel_addressform .error").text(data.msg);
                        } else {
                            $("#panel_addressform .error").text("");
                            identity = data.identity;
                            recipients = data.recipients;
                            cdyne_response = data.cdyne_response;
                            {%if regulation%}$('#msg_preview .greeting').text("Dear {{regulation.agency}}:");
                            {%else%}
                            if (recipients.length > 0)
                                $('#msg_preview .greeting').text("Dear " + recipients.join(", ") + ":"); // escape?
                            else
                                $('#msg_preview .greeting').text("Dear Member of Congress,");
                            {%endif%}
                            show_panel(3);
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        $("#panel_addressform .error").text(technical_difficulties);
                    }
                });
            
                return false;
        }
        
        function do_preview() {
            if (working) return;
            
            {% if not request.GET.demo %}
            mixpanel_properties.personalized = !$('#message').hasClass("default");
            mixpanel.track('widget_writecongress_write', mixpanel_properties);
            {% endif %}
            
            // convert message text into a nicely paragraphed html preview
            var msghtml = "";
            if (!$('#message').hasClass("default")) {
                var lines = $('#message').val().replace("\r", "\n").replace("\n\n", "\n").split("\n");
                for (var i = 0; i < lines.length; i++)
                    msghtml += "<p>" + $('<div/>').text(lines[i]).html() + "</p>";
                $('#msg_preview .write_a_personal_message').hide();
            } else {
                if (position == "+") verb = "support"; else verb = "oppose";
                msghtml = {% if bill %}"<p><i>I " + verb + " {{bill.shortname}}.</i></p>";{% else %}"<p></p>"{% endif %}
                $('#msg_preview .write_a_personal_message').show();
            }
            
            $('#msg_preview .message').html(msghtml);
            $('#msg_preview .name').text(identity.firstname + " " + identity.lastname);
            $('#msg_preview .address1').text(identity.address1);
            $('#msg_preview .citystatezip').text(identity.city + ", " + identity.state + " " + identity.zipcode);
            show_panel(4);
            
            $('#msg_preview .scrolled').jScrollPane();
            
            return false;
        }
        
        function do_send() {
            if (working) return;
            
            {% if not request.GET.demo %}
            mixpanel.track('widget_writecongress_send', mixpanel_properties);
            {% endif %}
            
            $.ajax({
                    url: window.location.pathname,
                    data: {
                        {% if request.GET.demo %}demo: true,{% endif %}
                        {% if campaign %}campaign: {{campaign.id}},{% endif %}
                        {%if bill%}bill: {{bill.id}}{%else%}bill: ""{%endif%},
                        {%if regulation%}regulation: {{regulation.id}}{%else%}regulation: ""{%endif%},
                        position: position,
                        action: "submit",
                        csrf_token: csrf_token,
                        email: identity.email,
                        password: $("#password").val(), // resend
                        {% if "widget_optin" in permissions and request.GET.optin == "1" %}
                        optin: $('#optin').prop('checked') ? "1" : "0",
                        {% endif %}
                        useraddress_prefix: $("#useraddress_prefix").val(),
                        useraddress_firstname: identity.firstname,
                        useraddress_lastname: identity.lastname,
                        useraddress_suffix: $("#useraddress_suffix").val(),
                        useraddress_address1: $("#useraddress_address1").val(),
                        useraddress_address2: $("#useraddress_address2").val(),
                        useraddress_city: $("#useraddress_city").val(),
                        useraddress_state: identity.state,
                        useraddress_zipcode: identity.zipcode,
                        {% if "email_optin" in permissions %}
                        email_optin: $('#email_optin').prop('checked') ? "1" : "0",
                        {% endif %}
                        useraddress_phonenumber: $("#useraddress_phonenumber").val(),
                        {% if tagvals %}
                        useraddress_tag: $("#useraddress_tag").val(),
                        {% endif %}
                        message: !$('#message').hasClass("default") ? $('#message').val() : "",
                        cdyne_response: cdyne_response
                    },
                    type: "POST",
                    dataType: "json",
                    success: function(data, textStatus, jqXHR) {
                        if (data.status == "fail") {
                            $("#panel_preview .error").text(data.msg);
                        } else {
                            var referrer = document.referrer;
                            var refpatt=new RegExp("popvox.com/widgets/legagenda","i");
                            if (refpatt.test(referrer) == true)
                            {
                                if (typeof parent.POP.makeInactive === 'function')
                                {
                                    parent.POP.makeInactive({{bill.id}});
                                }
                            }
                            $("#panel_preview .error").text("");
                            
                            if (data.status == "submitted") {
                                $('h3.congrats').text('Your message will be sent!')
                                $('h4.congrats').text('Thank you for taking the time to share your opinion.');
                            } else if (data.status == "confirm-address") {
                               $('h3.congrats').text({% if 'whitehouse' in permissions %}'One More Step!'{% else %}'Check your email!'{% endif %});
                               $('h4.congrats').text({% if 'whitehouse' in permissions %}' Please check your email for a confirmation message and click on the link inside it. We cannot deliver your message until you take this action.'{% else %}'We need to confirm your address before delivering your message.'{% endif %});
                            } else if (data.status == "confirm-email") {
                               $('h3.congrats').text({% if 'whitehouse' in permissions %}'One More Step!'{% else %}'Check your email to verify your address!'{% endif %});
                               $('h4.congrats').text({% if 'whitehouse' in permissions %}' Please check your email for a confirmation message and click on the link inside it. We cannot deliver your message until you take this action.'{% else %}'We need to confirm your address before delivering your message.'{% endif %});
                                
                            } else if (data.status == "demo-submitted") {
                                $('h3.congrats').text('Your message will (NOT) be sent!')
                                $('h4.congrats').text('This widget is in demo mode. No information was saved.');
                            } else if (data.status == "demo-confirm-address") {
                                $('h3.congrats').text('[DEMO] You need to verify your email to complete the process [DEMO]');
                                $('h4.congrats').text({% if 'whitehouse' in permissions %}' Please check your email for a confirmation message and click on the link inside it. We cannot deliver your message until you take this action.'{% else %}'We need to confirm your address before delivering your message.'{% endif %});
                            } else if (data.status == "demo-confirm-email") {
                                $('h3.congrats').text('[DEMO] You need to verify your email to complete the process. [DEMO]');
                                $('h4.congrats').text({% if 'whitehouse' in permissions %}'One More Step! Please check your email for a confirmation message and click on the link inside it. We cannot deliver your message until you take this action.'{% else %}'We need to confirm your address before delivering your message.'{% endif %});
                            }
                            
                            show_panel(5);
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        $("#panel_preview .error").text(technical_difficulties);
                    }
                });

            return false;
        }
        
        function share_simple_open(url1, url2) {
            a = function() {
                if (!window.open(url1,"sharer","toolbar=0,status=0,resizable=1,width=626,height=436"))
                    document.location.href=url2;
            }
            if (/Firefox/.test(navigator.userAgent))
                setTimeout(a,0);
            else
                a();
            return false;
        }
        function facebook_share_simple(targeturl, text) {
            // based on share bookmarklet: http://www.facebook.com/share_options.php
            var f="http://www.facebook.com/share";
            var p=".php?src=bm&v=4&i=1299162093&u=" + encodeURIComponent(targeturl) + "&t=" + encodeURIComponent(text);
            share_simple_open(f+"r"+p, f+p);
        }
        function twitter_share_simple(targeturl, text, hashtag) {
            if (text.indexOf(hashtag) == -1)
                text += " " + hashtag;
            text += " " + targeturl;
            var p1 = "http://twitter.com/intent/tweet?text=" + encodeURIComponent(text);
            var p2 = "http://twitter.com/home?status=" + encodeURIComponent(text);
            share_simple_open(p1, p2);
        }
        function link_share(targeturl, text, hashtag) {
            $('#social_share .link').html("<p>Copy and paste the following address to share this page with others:</p> <p><tt>" + $('<div/>').text(targeturl).html() + "</tt></p>");
            $('#social_share .link').slideDown();
            return false;
        }
        function do_share(method) {
            {% if not request.GET.demo %}
            mixpanel_properties.share_method = method;
            mixpanel.track('widget_writecongress_share', mixpanel_properties);
            {% endif %}
            
            var f;
            if (method == "facebook") f = facebook_share_simple;
            if (method == "twitter") f = twitter_share_simple;
            if (method == "email") f = email_share;
            if (method == "link") f = link_share;
            
            {% if 'franking' in permissions %}
                if (position == "+") verb = "I just supported"; else if (position == "-") verb = "I just opposed"; else verb = "I just commented on";
                    f("{{url|escapejs}}", verb + " {{bill.nicename|truncatewords:7|escapejs}}"+"Find out why", "{{bill.hashtag|escapejs}}");
            {% else %}
                if (position == "+") verb = "Support"; else if (position == "-") verb = "Oppose"; else verb = "Comment on"
                    f("{{url|escapejs}}", {%if bill%}verb + " {{bill.nicename|truncatewords:7|escapejs}}", "{{bill.hashtag|escapejs}}"{%else%}" Comment on {{regulation.title|truncatewords:7|escapejs}}", "{{regulation.hashtag|escapejs}}"{%endif%});
            {% endif %}
            return false;
        }

        // new, less broken stuff
        //var viewportWidth  = document.documentElement.clientWidth;
        //var viewportHeight = document.documentElement.clientHeight;
        //console.log(viewportWidth);
        //console.log(viewportHeight);

        //if(viewportWidth >= 300){
            //things here
        //} else if(viewportWidth > 500) {
            //things here
        //} else if(viewportWidth > 700) {
            // things here
        //}
        // nevermind, probably need to replace the entire set of widgets.

        
    </script>
</head>
<body {% if regulation %}class="reg_widget"{% endif %}>
    <div id="wrap" class="w420">
        <div class="float_left">
            <div id="widget_top">
                <ul id="progress">
                    <li class="tab_1 active"><span>1</span></li>
                    <li class="tab_2"><span>2</span></li>
                    <li class="tab_3"><span>3</span></li>
                    <li class="tab_4"><span>4</span></li>
                </ul>
            </div>
            
            <div id="widget_body">
                
                <div id="panel_holder">
            
                    <div id="panel_login" class="widget_panel">
                        {% if position %}
                            {% if 'jointext' in permissions %}
                            <h1>Join {{campaign.account}} in {% if position == "+" %}Supporting{% else %}Opposing{% endif %} {{bill.shortname}}</h1>
                            {% else %}
                            <h1>Tell Congress {% if 'whitehouse' in permissions %}and the Administration {%endif%}that you {% if position == "+" %}Support{% else %}Oppose{% endif %} {{bill.shortname}}</h1>
                            {% endif %}
                        {% else %}
                            {% if 'franking' in permissions %}
                                <h1>Share your views on {%if bill%}{{bill.shortname}}{%else%}{{regulation.regnumber}}{%endif%}</h1>
                            {% else %}
                                <h1>Tell {%if bill%}Congress What You Think About {{bill.shortname}}{%else%}The {{regulation.agency}} What You Think About {{regulation.regnumber}}{%endif%}</h1>
                            {% endif %}
                        {% endif %}

                        {% if bill %}
                            {% if bill.is_bill %}
                            <p class="bill_name" title="{{bill.nicename}}"><span>Title:</span> {{bill.nicename|truncatewords:15}}</p>
                            {% else %}
                            <p class="bill_name" title="{{bill.description}}">{{bill.description|truncatewords:34}}</p>
                            {% endif %}
                        {% else %}
                            <p class="bill_name" title="{{regulation.title}}">{{regulation.title|truncatewords:34}}</p>
                        {% endif %}
                        <form class="form" action="#" onsubmit="return false;" autocomplete="off">
                            <h3>{% if bill %}Tell Congress who you are{%else%}Please provide your address{%endif%}</h3>
                            
                            <div id="login">
                                <input id="email" name="email" value="" size="25" maxlength="40" type="text" tabindex="1"><span class="check" style="display: none">check</span><br />
    
                                {% comment %} -- this is not used currently, and commenting it out saves us loading some image resources --
                                <div id="registered_sso" style="display: none" class="clear">
                                    <p>You&rsquo;ve created a POPVOX account already. We&rsquo;ll need you to log in.</p>
                                    {% with request.get_full_path as singlesignon_next %}
                                    {% with "&mode=compact" as singlesignon_params %}
                                    {% with "onclick='return start_single_sign_on(this);'" as singlesignon_a_attrs_x %}
                                        {% include "registration/login_singlesignon.html" %}
                                    {% endwith %}
                                    {% endwith %}
                                    {% endwith %}
                                </div>
                                {% endcomment %}
                                <div id="registered_password" style="display: none" class="clear">
                                    <p>Enter your POPVOX.com password:</p>
                                    <input id="password" value="" size="25" maxlength="40" type="password"><br />
                                    <p><a href="#" onclick="return forgot_password()">forgot your password?</a></p>
                                </div>
            
                                <div id="unregistered" class="clear">
                                    <input id="firstname" value="" size="25" maxlength="40" type="text"><br />
                                    <input id="lastname" value="" size="25" maxlength="40" type="text"><br />
                                    <input id="zipcode" value="" size="25" maxlength="40" type="text"><br />
                                </div>
                            </div>
                            
                            <div id="loggedinalready" style="display: none; margin-top: 1em;">
                                <!-- can't say "welcome back" because on a login we reload the page and start over -->
                                <p>Welcome <strong>{{displayname}}</strong>.
                                <a href="#" onclick="return logout();">Not you?</a>
                            </div>
                            {% if 'email_optin' in permissions %} <div class="optin">
                                <input id="email_optin" type="checkbox" />
                                <label for="email_optin" style="width:60%">Send me updates about this {%if bill%}bill{%else%}regulation{%endif%}, and related issues from {{campaign.account}}.</label>
                            </div>
                                    {% endif %}
                            
                            {%if bill%}
                                {% if position %}
                                <input value="next" {% if 'next_btn_move' in permissions  %}style="position:absolute; margin-top: 175px"{% endif %} class="btn next disabled" onclick="return do_login('{{position}}');" type="button"/>
                                {% else %}
                                <input style="margin: 20px 0; /*put me in head */" value="support" class="btn or next_support disabled" onclick="return do_login('+');" type="button"/>
                                <p class="or" style="display: block; width: 60px; height: 47px; float: left; font-weight: bold; margin: 20px 0 0; padding: 15px 0 0; text-align: center ">OR</p>
                                <input style="margin: 20px 0; /*put me in head */" value="oppose" class="btn or next_oppose disabled" onclick="return do_login('-');" type="button"/>
                                {% endif %}
                            {% else %}
                                <input value="next" {% if 'next_btn_move' in permissions  %}style="position:absolute; margin-top: 175px"{% endif %} class="btn next disabled" onclick="return do_login('0');" type="button"/>
                            {% endif %}
                            <script type="text/javascript">$('#panel_login .next, #panel_login .next_support, #panel_login  .next_oppose').hover(
                                function() { if ($('#email').hasClass("default")) { $('#email').css({'font-weight': 'bold', 'color': 'red'}); } },
                                function() { $('#email').css({'font-weight': '', 'color': ''}); }
                            );</script>
                            
                            <p class="clear error"> </p>
                            
                            {% if request.GET.demo %}
                            <p class="clear alert" style="margin-top: 2em; font-style: italic">(This widget preview is in demo mode. No information will be recorded.)</p>
                            {% endif %}
                            
                        </form>
                        
                        <script type="text/javascript">
                            $('#email').input_default("enter your email address");
                            $('#firstname').input_default("first name");
                            $('#lastname').input_default("last name");
                            $('#zipcode').input_default("zip code");
                            $('#firstname, #lastname, #zipcode').prop("disabled", true);
                            $("#email").keyup_delayed(check_email);
                        </script>
                        
                        {% comment %}keep in mind: large buttons for neutral widgets and at least one line for the service account owner{% endcomment %}
                        {% if bill %}
                        <p style="margin-top: 20px; padding-right: 1em;">Your letter will be sent to {% if 'whitehouse' in permissions %}the Administration and {% endif %}your representative and/or senators in Congress and posted anonymously on <a href="http://www.popvox.com" target="_blank">POPVOX.com</a>.</p>
                        {%else%}
                        <p style="margin-top: 20px; padding-right: 1em;">Your comment will be sent to the {{regulation.agency}} via <a href="http://regulations.gov" target="_blank">Regulations.gov</a> and will become part of the public record. Your full name will be displayed publicly on <a href="http://regulations.gov" target="_blank">Regulations.gov</a>.</p> 
                        <p style="margin-top: 20px; padding-right: 1em;">Your comment and Congressional district will be displayed anonymously on <a href="http://www.popvox.com" target="_blank">POPVOX.com</a>. (You may also choose a screen name.)</p>
                        {%endif%}
                        {% if 'collect_analytics' in permissions %}
                            {% if bill %}<p style="margin-top: 1em; padding-right: 1em;">Your comment and information (except your phone number) will also be shared with {% if campaign %}{{campaign.account}}{%else%}the widget owner{% endif %}.</p>
                            {% else %}
                            <p style="margin-top: 1em; padding-right: 1em;">Your comment, name, email, and zip code will also be shared with {% if campaign %}{{campaign.account}}{%else%}the widget owner{% endif %}.</p>
                            {% endif %}
                        {% endif %}
                        <p style="margin-top: 1em; padding-right: 1em;">View <a href="https://www.popvox.com/legal#privacypolicy" target="_blank">POPVOX&#39;s Privacy Policy</a></p>
                    </div> <!-- e: panel_login -->

                    <div id="panel_addressform" class="widget_panel" style="display: none;" >
                        <form class="form" action="#" onsubmit="return false;">
                            <h3>{% if bill %}Tell Congress who you are{%else%}Please provide your address{%endif%}</h3>
                            
                                <p>Provide the address of your residence where you intend to vote.{% if bill %}<br />
                                Congressional offices only accept mail with complete contact information.{%endif%}</p>
                            
                                <label for="useraddress_prefix">Prefix*</label>
                                <select class="c2" id="useraddress_prefix">
                                    {% for prefix in useraddress_prefixes %}
                                    <option value="{{prefix}}" {% if useraddress.nameprefix == prefix %}selected{% endif %}>{{prefix}}{% if not prefix %}(select){% endif %}</option>
                                    {% endfor %}
                                </select><br />
                                
                                <label for="useraddress_firstname">First Name*</label>
                                <span id="useraddress_firstname">...</span><br />
                                
                                <label for="useraddress_lastname">Last Name*</label>
                                <span id="useraddress_lastname">...</span><br />
                                
                                <label for="useraddress_suffix">Suffix</label>
                                <select class="c2" id="useraddress_suffix">
                                    {% for suffix in useraddress_suffixes %}
                                    <option value="{{suffix}}" {% if useraddress.namesuffix == suffix %}selected{% endif %}>{{suffix}}{% if not suffix %}(none){% endif %}</option>
                                    {% endfor %}
                                </select>
                                <span class="optional">optional</span><br />
                                
                                <label for="useraddress_address1">Address<!-- Line 1-->*</label>
                                <input class="c3" id="useraddress_address1" type="text" value=""/><br />
                                
                                <label for="useraddress_address2">Address Line 2</label>
                                <input class="c3" id="useraddress_address2" type="text" value=""/>
                                <span class="optional">optional</span><br />
                                
                                <label for="useraddress_city">City*</label>
                                <input class="c2" id="useraddress_city" type="text" value=""/><br />
                                
                                <label for="useraddress_state">State*</label>
                                <span id="useraddress_state">...</span><br />
                                
                                <label for="useraddress_zipcode">ZIP Code*</label>
                                <span id="useraddress_zipcode">...</span><br />
                                                                
                                
                                <label for="useraddress_phonenumber">Phone#*</label><input class="c2" id="useraddress_phonenumber" type="text" value="" maxlength="18"/><br />
                                <small class="mrg_top_0">{% if bill %}Some Members of Congress require a phone number with your message. Don&#39;t worry, POPVOX only shares your number when your Members of Congress ask for it.{%else%}POPVOX asks for a phone number as a part of signup because it is required by some lawmakers to receive correspondence and POPVOX facilitates that communication. It will not be shared except when required by your lawmaker.{%endif%}</small>
                                {% if tagvals %}
                                <label for="useraddress_tag">{{ taglabel }}</label>
                                <select class="c2" id="useraddress_tag" type="text" value="" maxlength="18">
                                    {% for tagval in tagvals %}
                                    <option value="{{tagval}}">{{tagval}}</option>
                                    {% endfor %}
                                    {% endif %}
                                </select>
                                
                                <p class="clear error"> </p>
                        </form>
                        
                        <input value="next" class="btn next" onclick="return do_address();" type="button">
                        
                        {% if not tagvals %}
                        <p class="clear optional">We ask for only as much information as your lawmakers have told us they require.</p>
                        {% endif %}
                    </div>
                            
                    <div id="panel_write" class="widget_panel" style="display: none;">
                        {% if reason %}
                            {% if 'franking' in permissions %}
                            {% else %}
                                {% if bill %}
                                <div id="panel_write_why_reason">
                                <div class="why">
                                    <h3>Why should I <span class="position_verb"> </span> {{bill.shortname}}?</h3>
                                    <a href="#" class="expand btn" onclick="return false;">expand</a>
                                </div><div class="clear"> </div>
                                <div class="reason" style="display: none">
                                    <p>{{reason}}</p>
                                </div>
                                </div>
                                <script type="text/javascript">
                                    $('#panel_write_why_reason').hover(
                                        function() { $('#panel_write .reason').slideDown(); },
                                        function() { $('#panel_write .reason').slideUp(); } );
                                </script>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                                        
                        <h3>Write a Personal Message</h3>
                        {% if 'franking' in permissions %}
                            <h4>Here are my views on {%if bill%}{{bill.shortname}}{%else%}{{regulation.regnumber}}{%endif%}.</h4>
                        {% else %}
                            {%if bill%}<h4>I <span class="position_verb"> </span> {{bill.shortname}} because...</h4>{%else%}<h4>Here are my views on {{regulation.regnumber}}</h4>{%endif%}
                        {% endif %}

        
                        <form id="msg" class="form" action="#" onsubmit="return false;">
        
                                <!-- 1200 is hard-coded in lettertips.js -->
                            <textarea class="half" id="message" maxlength="1200" type="text"></textarea><br /> 
                            
                            <a href="#" class="back" onclick="return working ? false : show_panel(2);">back</a>
                            
        <!--                    <input value="Send My Support Without a Message" id="b_send_no_msg" type="button">-->
                            <input value="Preview" id="b_preview" type="button" onclick="return do_preview();">
                            <div class="clear"> </div>
                        </form>
                        <div id="tips">
                            {% if 'franking' in permissions %}
                            {% else %}
                            {%if bill%}<h3>A message is optional</h3>
                            <p class="is-optional">When Members of Congress are undecided on a bill, they are most influenced by personal communications from constituents. <em>To skip this step, just click Preview.</em></p>
                            {%else%}
                            <h3>Public Comment Tips</h3>
                            <p class="is-optional">Federal agencies are required to consider your input.<br /><br />
                            Detailed comments that clearly communicate and support your claims are more likely to be effective.<br /><br />
                            Be concise!<br /><br />
                            One well-supported comment is often more influential than a thousand form letters or petitions.</em></p>
                            {%endif%}
                            {% endif %}
                            <!--
                            <h3>Tips</h3>
                            <p id="messagetip"></p>
                            <p>There is no need to sign your name. We&rsquo;ll add that for you.</p>
                            -->
                        </div>
                        <script type="text/javascript">
                            $('#message').input_default();
                            $('#message').textchange(function() { validate('message'); });
                        </script>
                        
                        <div class="clear"> </div>
                        
                        {%if bill%}<p>Your letter will be sent to Congress and {% if 'whitehouse' in permissions %}the Administration and {% endif %}posted anonymously on <a href="http://www.popvox.com" target="_blank">POPVOX.com</a>. {% if campaign %}{% if 'collect_analytics' in permissions %}A copy will also go to {{campaign.account}}.{% endif %}{% endif %}</p>
                        {%else%}
                        <p>Your comment will be sent to the {{regulation.agency}} via <a href="http://regulations.gov" target="_blank">Regulations.gov</a> and will become part of the public record. Your full name will be displayed publicly on <a href="http://regulations.gov" target="_blank">Regulations.gov</a></p> 
                        <p style="margin-top: 20px; padding-right: 1em;">Your comment, and Congressional district will be displayed anonymously on <a href="http://www.popvox.com" target="_blank">POPVOX.com</a>.</p>
                        {%endif%}
                        
                    </div><!-- e: panel_write -->
                    
                    <div id="panel_preview" class="widget_panel" style="display: none;" >
                                        
                        <h3>Preview your {%if bill%}message{%else%}comment{%endif%}</h3>
        
                        <div id="msg_preview">
							{%if bill %}<p class="greeting">Dear Congressperson:</p>{%else%}<p class="greeting">Dear {{regulation.agency}}</p>{%endif%}
                            <div class="scrolled">
                                <p class="firstpara"><span></span> <div class="message"> </div></p>
                                <p class="write_a_personal_message">
                                {%if bill %}Members of Congress only respond to personal messages.
                                Consider <a href="#" onclick="return working ? false : show_panel(3);">going back</a> and writing a personal message.{%else%}The {{regulation.agency}} cannot consider blank comments. Please <a href="#" onclick="return working ? false : show_panel(3);">go back</a> and write a comment.{%endif%}<p>
                            </div>
                            <p class="signature">
                                <span class="name"><strong>Bob Smith</strong> | edit <a href="#" onclick="return working ? false : show_panel(2);"> address</a> or <a href="#" onclick="return working ? false : show_panel(3);">message</a></span><br />
                                <span class="address1">35 Morningside Dr.</span><br />
                                <span class="citystatezip">Jackson, TN 38301</span><br />
                            </p>
                            
                        </div>  
						
                        <p id="b_send_to_congress"><a class="btn" href="#" onclick="return do_send();">Send your message to Congress</a></p>
						<a href="#" class="back back3" onclick="return working ? false : show_panel(3);">back</a>
                        
                        {% if "widget_optin" in permissions and request.GET.optin == "1" %}
                        <div class="optin">
                            <input id="optin" type="checkbox"/>
                            <label for="optin">Send me updates about this {%if bill%}bill{%else%}regulation{%endif%} and related issues from <a href="http://www.popvox.com" target="_blank">POPVOX.com</a>.</label>
                        </div>
                        {% endif %}
                        
                        <p class="clear error"> </p>
                    </div><!-- e: panel_preview -->
                    
                    
                    <div id="panel_share" class="widget_panel" style="display: none">
                                        
                        {%if bill%}<h3 class="congrats">Congratulations, we sent your message to Congress!</h3>
                        <h4 class="congrats">More information on what happened!</h4>
                        {%else%}
                        <h3 class="congrats">Your comment will be sent.</h3>
                        {%endif%}
        
                        <div id="social_share">
                            {% if 'franking' in permissions %}
                            <h3>Share on social media</h3>
                            {% else %}
                            <h3>Tell your friends to {%if bill %} <span class="position_verb"> </span> this bill{%else%}comment on this regulation {%endif%}</h3>
                            {% endif %}
                            <ul class="social_share_btns">
                                <li><a class="btn social_facebook" href="#" onclick="return do_share('facebook')" title="Facebook">facebook</a></li>
                                <li><a class="btn social_twitter" href="#" target="_blank" onclick="return do_share('twitter')" title="Twitter">twitter</a></li>
                                <!--<li><a class="btn social_email" href="#" onclick="return do_share('email')" title="Email">email</a></li>-->
                                <li><a class="btn social_link" href="#" onclick="return do_share('link')" title="Get a Short URL">get a link</a></li>
                            </ul>   
                            <div class="clear"> </div>
                            <p class="link" style="display: none"></p>
                        </div>  
                        
                                {% if 'franking' in permissions %}
                                    <h3 class="{{class}} no_rule suggest">You may also be interested in these bills</h3>
                                {% else %}
                                    {% for class, text, list in suggestions %}
                                        {% if list|length > 0 %}
                                            <h3 class="{{class}} no_rule suggest">{{text}}</h3>
                                            
                                            {% for bill in list %}
                                                {% bill_statistics bill as stats %}
                                                {% with "1" as chart_no_links %}
                                                {% with "1" as chart_no_clear %}
                                                {% with "{bg: 'white'}" as chart_opts %}
                                                {% with "50" as chart_size %}
                                                    {% include "popvox/bill_statistics_pie_simple.html" %}
                                                {% endwith %}
                                                {% endwith %}
                                                {% endwith %}
                                                {% endwith %}
                                                
                                                <p><a href="{{bill.url}}" target="_blank">{{bill.nicename|truncatewords:12}}</a></p>
                                                
                                                <div class="clear"> </div>
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                        
                        {% if not campaign %}
                        <div class="search">
                            <h3>Search bills on POPVOX</h3>
                            <p>search by bill number or issue area</p>
                            <form id="search" class="form" action="https://www.popvox.com/bills/search" method="get" target="_blank">
                                <input name="q" value="" size="25" maxlength="40" type="text"><br />
                            </form><div class="clear"> </div>
                        </div>
                        {% endif %}
                        
                    </div><!-- e: panel_share -->
                    
                    <div class="clear"> </div>
                
                </div> <!-- e: panel_holder -->
                
            </div><!-- e: body -->
            
            <div id="widget_foot">
                <p><a href="http://www.popvox.com" target="_blank">powered by <span>popvox.com</span></a></p>
            </div>
            
        </div><!-- e: widget -->
    </div><!-- e: wrap -->
</body>
</html>
