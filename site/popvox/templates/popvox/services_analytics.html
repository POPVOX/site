{% extends "master.html" %}
{% load popvox_utils %}
{% block title %}Campaign Analytics{% endblock%}
{% block description %}Campaign Analytics - detailed analytics for your POPVOX widgets and action pages.{% endblock%}
{%block nav_orgadmin_class_reports%}active{%endblock%}
{%block nav_user_class_reports%}active{%endblock%}
{% block head %}
<script src="/media/js/jquery.dataTables.js" type="text/javascript"></script>

<script type="text/javascript" src="/media/js/highcharts.js"></script>
<script type="text/javascript" src="/media/js/charts.js"></script>

<style>
h2 { font: normal 26px/36px 'BebasNeueRegular', helvetica, arial, sans-serif  }
h4 { font: bold 14px/16px helvetica,arial,sans-serif; margin-bottom: 15px;  }
#analytics_numbers { margin: 1em 1em 2em 1em; }
#analytics_numbers th, #analytics_numbers td { font-size: 13px;  padding: 6px 6px 0 0; }
#analytics_numbers p { margin-top: 6px; font-style: italic; font-size: 11px; }
.chart_title { text-align: center; }

.ul_tags li a {
	font-size: 14px;
	font-weight: bold;
	padding: 7px;
}

#analyticsFunnel {
background: #e8e5df;
width: 715px;
padding-top: 22px;
}

.boxes {
background: url(/media/widget/box.png) no-repeat;
height: 128px;
width: 132px;
padding-left: 8px;
background-position: bottom right;
float:left;
}

.first {
/***padding-left: 22px;***/
padding-left: 0px;
}

.last {
/***padding-right: 22px;
background-position: 12px 22px;***/
}

.stat {
font-family: 'BebasNeueRegular';
color: white;
width: 132px;
margin: 0 auto;
text-align: center;
}

.top {
padding-top: 22px;
font-size: 48px;

}

.bottom {
padding-top: 0;
font-size: 26px;
}

#headLeft {
/***padding-left: 22px;****/
padding-top: 21px;
width: 400px;
}

.wTitle {
font-family: 'BebasNeueRegular';
font-size: 26px;
color: #75757d;
}

.wSubTitle {
padding-top: 5px;
font-family: Helvetica, Tahoma;
font-size: 18px;
color: #75757d;
font-weight: normal;
}

#headRight {
width: 200px;
float: right;
margin-top: -44px;
text-align: right;
}

.wDate {
font-family: Helvetica, Tahoma;
font-size: 18px;
color: #75757d;
font-weight: normal;
}

.dCustom {
font-size: 14px;
font-style: italic;
}

#boxContain {
height: 150px;
}
#iconContain {
width: 100%;
height: 115px;
clear: both;
margin-bottom: 5px;
}

.icons {
float: left;
width: 141px;
padding-top: 10px;
height: 115px;
}

.iconFirst {
/***margin-left: 22px;***/
background: url(/media/widget/pointer.png) no-repeat 40% 20%;
}


/***Support** 
.iconSecond {
background: url(/media/widget/support.png) no-repeat 40% 30%;
}
**/

/**Support and Oppose**/
.iconSecond {
background: url(/media/widget/oppose.png) no-repeat 20% 30%;
}




.iconThird {
background: url(/media/widget/house.png) no-repeat 40% 20%;
}

.iconFourth {
background: url(/media/widget/letter.png) no-repeat 40% 30%;
}

.iconFifth {
background: url(/media/widget/confirmed.png) no-repeat 40% 15%;
}

.iconText {
background: url(/media/widget/arrow.png) no-repeat 100% 40%;
font-size: 13px;
font-family: Helvetica, Tahoma;
font-weight: bold;
color: #75757d;
padding-top: 80px;
text-align: center;
padding-right: 17px;
padding-left: 5px;
}

.textLast {
background: none;
}

#iconHelp {
	height: 10px;
	padding-top: 15px;
}

p.help {
	font: italic bold 16px/18px georgia, serif;
	color: #CC6A11;
	text-align: center;
	}

#latest_activity_container1 {
	overflow: hidden;
	width: 685px;
	height: 145px;
	margin-top: -10px;
}
#latest_activity_container2 {
	width: 1200px;
}
.recent_activity_item {
	float: left;
	background: #D4D1C8;
	width: 205px;
	height: 125px;
	margin: 0 5px 5px 0;
	padding: 10px;
	overflow: hidden;
}
.recent_activity_item div {
	font-size: 11px;
	font-weight: bold;
	color: #CC6A11;
}

.recent_activity_item div .header {
	display: inline-block;
	width: 35px;
	color: #404045;
}

.recent_activity_item span.date {
	color: #404045;
	}
		
.recent_activity_item p {
	font: italic normal 12px/16px georgia, serif;
	line-height: normal;
	margin-top: 5px;
	padding: 5px 0 0 0;
	text-indent: 20px;
}

.recent_activity_item p.support {
	background: url(/media/widget/bg_heart_sm.png) no-repeat;
	}

.recent_activity_item p.oppose {
	background: url(/media/widget/bg_anti_sm.png) no-repeat;
	}
		
	.recent_activity_item p a {
		text-transform: uppercase;
		font: bold 10px helvetica, arial, sans-serif;
		}

.dataTables_scroll {
width: 780px;
font-size: 12px;
}

.dataTables_wrapper {
background: #414046;
width: 779px;
font-size: 12px;
}

.dataTables_scrollHead {
background: #75757D;
color: white;
}

.even td {
border: 1px #e8e5e0 solid;
border-left: none;

}

.odd td {
border: 1px #e8e5e0 solid;
border-top: none;
border-bottom: none;
border-left: none;
}

td {
padding: 8px;
}

th {
padding: 8px;
text-transform: uppercase;
}

.odd {
background: #d4d1ca;
}

.even {
background: #ded8d4;
}

thead th {
text-transform: uppercase;
font-weight: bold;
font-size: 12px;
border: 1px #e8e5e0 solid;
border-left: none;
border-top: none;
padding-right: 1px;
}

.dataTables_info {
background: #414046;
padding: 8px;
width: 763px;
color: white;
font-size: 12px;
}

.dataTables_length {
float: right;
color: white;
padding: 8px;
}

.supporters_download {
margin: 8px;
}

.dataTables_paginate {
width: 100px;
float:right;
margin-top: -30px;
padding: 8px;
}

#supporters_grid_previous {
float: left;
width: 44px;
height:11px;
background: url(/media/widget/previous.png) no-repeat;
cursor: pointer;
}

#supporters_grid_next {
float:right;
width:44px;
height: 11px;
background: url(/media/widget/next.png) no-repeat;
cursor: pointer;
}

#supporters_grid_processing {
height:30px;
}


#supporters_grid_previous.paginate_disabled_previous {
background: none;
cursor: default;
}

#supporters_grid_next.paginate_disabled_next {
background: none;
cursor: default;
}


#supporters_download {
background: url(/media/widget/b_download_csv.png) no-repeat;
text-indent: -9999px;
display: block;
width: 119px;
height: 22px;
margin-top: 5px;
border: none;
}

#supporters_download:hover {
background: url(/media/widget/b_download_csv.png) no-repeat left bottom;
width: 119px;
height: 22px;
border:none;
}

</style>
<script type="text/javascript">
function draw_timeseries(container, data, small) {
  var series = [];
  for (var sname in data.values) {
   var values = [];
   for (var d in data.series) values.push(data.values[sname][data.series[d]]);
   var s = { name: sname, data: values };
   series.push(s);
  }

  var ti = 1;
  if (data.series.length > 20) ti = 2;
  if (data.series.length > 30) ti = 7;
  if (data.series.length > 100) ti = 14;

  new Highcharts.Chart({
     chart: {
            backgroundColor: "#e8e5df",
	    renderTo: container,
	    defaultSeriesType: 'line',
            margin: [15, 0, !small ? 70 : 20, 50]
	 },
    tooltip: {
	    formatter: function() {
		    return this.x + ": " + this.y + " " + this.series.name
		}
    },
    credits: { enabled: false },
    xAxis: { labels: { enabled: !small }, categories: data.series, tickInterval: ti },
    yAxis: { min: 0, title: { text: "Uniques", style: { fontSize: "10px", fontWeight: "normal" } } },
    colors: ["#4a9410", "#ed5923", "#414046", "#f8ac3c", "#999999", "#c66725"],
    title: { text: null },
    legend: { enabled: !small },
    series: series
     });

}
</script>
{% endblock %}
{% block subnav %}
    {% include "popvox/services_subnav.html" %}
{% endblock %}
{% block content %}
<div class="content">
<div class="col_9 col_plus col_top">

<h1>Campaign Analytics</h1>

{% if has_campaigns %}
	<ul class="tabs">
		<li><a href="#overview"><span>Overview</span></a></il>
		<li><a href="#details"><span>Details</span></a></il>
	</ul>
	<div class="tabs_panel">
{% endif %}
	
<div class="tab_overview">
	{% if user.orgroles.all|length == 0 %}
		<p>Use our <a href="/services/widgets#writecongress">Write Congress Widget</a> to create a letter-writing campaign.</p>
	{% else %}
		<p>Create letter-writing campaigns for bills in your legislative agenda using our <a href="/services/widgets#writecongress">Write Congress Widget</a> or customized action pages.</p>
	{% endif %}
	
	
	{% for acct in accts %}

		{% if acct.campaigns.all|length > 0 %}
		{% if accts|length > 1 %}
		<h2>{{acct}}</h2>
		{% endif %}
	
		<div class="block campaigns {% if not forloop.first %}rule{% endif %}">
		{% for cam in acct.campaigns.all %}
			<div class="support_oppose">
				{% bill_statistics cam.bill as stats %}
				
				{% with cam.actionrecords.all.count as count %}
				<div class="col_50">
					<h4 style="margin-bottom: 1em">
						{{cam.bill.nicename|truncatewords:10}}
						<span style="color: #777"> ({% if cam.position == '+' %}Endorsing{% endif %}{% if cam.position == '-' %}Opposing{% endif %}{% if cam.position == '0' %}Neutral{% endif %})</span>
					</h4>
					
					{% if count %}
						<p>{{count}} supporter{% if count > 1 %}s{% endif %} took action. View <a href="#details={{cam.id}}" style="font-weight: bold">detailed analytics</a> for your widget or action page.</p>
					{% else %}
						<p>Create a <a href="/services/widgets#writecongress">widget</a> to drive your supporters to take action.</p>
					{% endif %}
				</div>
				<div class="col_50">
					{% if count %}
						<div id="analytics_{{cam.id}}" style="width: 320px; height: 120px;"> </div>
					{% else %}
						{% with cam.bill as bill %}
						{% with cam.id as chart_id %}
						{% with 75 as chart_size %}
							{% include "popvox/bill_statistics_pie_simple.html" %}
						{% endwith %}
						{% endwith %}
						{% endwith %}
					{% endif %}
				</div>
				{% endwith %}
				{% if not forloop.last %}<div class="hr"> </div>{% endif %}
				</div> <!-- e: support_oppose -->
		{% endfor %}
		</div> <!-- e: block campaigns -->
		{% endif %}
		<div class="clear"> </div>
		
		{% for cam in acct.org.all_campaigns %}
			{% for pos in cam.positions.all %}
				{% if not pos.has_service_account_campaign %}
					{% ifchanged %}<h2>{{cam.name}}</h2>{% endifchanged %}
				
					{% bill_statistics pos.bill as stats %}
					<div class="clear hr"> </div>
					<div class="col_50">
						<h4{% if not cam.default %} style="margin: 0"{% endif %}>
							{{pos.bill.title|truncatewords:10}}
							<span style="color: #777"> ({% if pos.position == '+' %}Endorsing{% endif %}{% if pos.position == '-' %}Opposing{% endif %}{% if pos.position == '0' %}Neutral{% endif %})</span>
						</h4>
						
						{% if not cam.default %}
						<p style="font-style: italic">{{cam.name}}</p>
						{% endif %}

						<p>Create a <a href="/services/widgets#writecongress">widget</a> or <a href="{{role.org.url}}/_action/{{pos.id}}">customized action page</a> to drive your supporters to take action.</p>
					</div>
					<div class="col_50">
						{% with pos.bill as bill %}
						{% with pos.id as chart_id %}
						{% with 75 as chart_size %}
							{% include "popvox/bill_statistics_pie_simple.html" %}
						{% endwith %}
						{% endwith %}
						{% endwith %}
					</div>
				{% endif %}
			{% endfor %}
		{% endfor %}	
		
	{% endfor %} {% comment %} service account {% endcomment %}
	
	{% for role in user.orgroles.all %}
		{% if not role.org.serviceaccount %}
		<h2>{{role.org.name}}</h2>
		{% for cam in acct.org.all_campaigns %}
			{% for pos in cam.positions.all %}
				{% if not pos.has_service_account_campaign %}
					{% ifchanged %}<h2>{{cam.name}}</h2>{% endifchanged %}
				
					{% bill_statistics pos.bill as stats %}
					<div class="clear hr"> </div>
					<div class="col_50">
						<h4{% if not cam.default %} style="margin: 0"{% endif %}>
							{{pos.bill.title|truncatewords:10}}
							<span style="color: #777"> ({% if pos.position == '+' %}Endorsing{% endif %}{% if pos.position == '-' %}Opposing{% endif %}{% if pos.position == '0' %}Neutral{% endif %})</span>
						</h4>
						
						{% if not cam.default %}
						<p style="font-style: italic">{{cam.name}}</p>
						{% endif %}

						<p>Create a <a href="/services/widgets#writecongress">widget</a> or <a href="{{role.org.url}}/_action/{{pos.id}}">customized action page</a> to drive your supporters to take action.</p>
					</div>
					<div class="col_50">
						{% with pos.bill as bill %}
						{% with pos.id as chart_id %}
						{% with 75 as chart_size %}
							{% include "popvox/bill_statistics_pie_simple.html" %}
						{% endwith %}
						{% endwith %}
						{% endwith %}
					</div>
				{% endif %}
			{% endfor %}
		{% endfor %}
		{% endif %}
	{% endfor %}
</div> <!-- e:tab_overview -->

{% if has_campaigns %}
<div class="tab_details">

	<h2>Campaigns</h2>
	
	<p class="help">Select a campaign to view its stats:</p>
	
	<script type="text/javascript">
	var campaigns_info = { };
	</script>

	<ul class="ul_tags">
		{% for acct in accts %}
            {% if 'analytics' in acct.permissions_list %}
                {% for cam in acct.campaigns.all %}
                    <li id="analytics_campaign_{{cam.id}}"><a href="#details={{cam.id}}" title="{{acct}}">{{cam.bill.shortname}}</a></li>
                    <script type="text/javascript">
                    {% regroup cam.actionrecords.all|dictsort:"completed_stage" by completed_stage as pos_record_stage %}
                    {% with cam.mixpanel_stats as mpstats %}
                    campaigns_info["{{cam.id}}"] = {
                        account_name: "{{acct|escapejs}}",
                        billnumber: "{{cam.bill.shortname|escapejs}}",
                        title: "{{cam.bill.nicename|truncatewords:10|escapejs}}",
                        descr: "{% if cam.bill.description %}{{cam.bill.description|truncatewords:25|escapejs}}{% endif %}",
                        position: "{{cam.position|escapejs}}",
                        date_start: "{{cam.first_action_date|date:'n-j-y'|escapejs}}",
                        date_end: "{{cam.last_action_date|date:'n-j-y'|escapejs}}",
                        download_url: "/services/api/campaign/{{cam.id}}/supporters/",
                        counts: { {% for stage in pos_record_stage %}"{{stage.grouper|escapejs}}": {{stage.list|length}}, {% endfor %} total: {{cam.total_widget_records}}, hits: {{mpstats.hit}}},
                        mpstats: {{mpstats.events|safe}},
                        mapurl: '/widgets/bill-comment-map?sac={{cam.id}}',
                        latest_data: [{% for item in cam.recent_comments %}{
                            link: "{{item.completed_comment.url|escapejs}}",
                            date: "{{item.completed_comment.created|date:"DATE_FORMAT"|escapejs}} at {{item.completed_comment.created|date:"TIME_FORMAT"|escapejs}}",
                            name: "{{item.completed_comment.address.firstname|escapejs}} {{item.completed_comment.address.lastname|escapejs}}",
                            district: "{{item.completed_comment.state|escapejs}}{{item.completed_comment.congressionaldistrict|escapejs}}",
                            {% if item.completed_comment.message %}message: "{{item.completed_comment.message|truncatewords:25|escapejs}}",{% endif %}
                            recipients: "{{item.completed_comment.get_recipients_display|escapejs}}",
                            position1: "{{item.completed_comment.position|escapejs}}",
                            position: "{{item.completed_comment.verb_imp|escapejs}}"
                        }{% if not forloop.last %},{% endif %}{% endfor %}]
                    };
                    draw_timeseries('analytics_{{cam.id}}', {{mpstats.events|safe}}, true);
                    {% endwith %}
                    </script>
                {% endfor %}
            {% else %} {% comment %} zero out the stats for free service accts {% endcomment %}
                {% for cam in acct.campaigns.all %}
                    <li id="analytics_campaign_{{cam.id}}"><a href="#details={{cam.id}}" title="{{acct}}">{{cam.bill.shortname}}</a></li>
                    <script type="text/javascript">
                    {% regroup cam.actionrecords.all|dictsort:"completed_stage" by completed_stage as pos_record_stage %}
                    {% with cam.mixpanel_stats as mpstats %}
                    campaigns_info["{{cam.id}}"] = {
                        account_name: "{{acct|escapejs}}",
                        billnumber: "{{cam.bill.shortname|escapejs}}",
                        title: "{{cam.bill.nicename|truncatewords:10|escapejs}}",
                        descr: "{% if cam.bill.description %}{{cam.bill.description|truncatewords:25|escapejs}}{% endif %}",
                        position: "{{cam.position|escapejs}}",
                        date_start: "{{cam.first_action_date|date:'n-j-y'|escapejs}}",
                        date_end: "{{cam.last_action_date|date:'n-j-y'|escapejs}}",
                        download_url: "",
                        counts: { {% for stage in pos_record_stage %}"{{stage.grouper|escapejs}}": 00, {% endfor %} total: 000, hits: 00},
                        mpstats: 000,
                        mapurl: '/widgets/bill-comment-map?sac={{cam.id}}',
                        latest_data: []
                    };
                    draw_timeseries('analytics_{{cam.id}}', {{mpstats.events|safe}}, true);
                    {% endwith %}
                    </script>
            {% endif %}
		{% endfor %}
		<div class="clear"> </div>
	</ul>
	
	<div class="hr"> </div>

	<div id="headLeft">
		<span class="wTitle">Campaign Account</span><br />
		<span class="wSubTitle">Campaign Title</span>
	</div>
	<div id="headRight">
		<span class="wDate"><span class="wDateStart">...</span> <span class="dCustom">thru</span> <span class="wDateEnd">...</span></span>
	</div>
		
	<div id="analyticsFunnel">
		<div id="boxContain">
			<div class="boxes first">
				<div class="stat top">
				A
				</div>
				<div class="stat bottom">
				A%
				</div>		
			</div>
			<div class="boxes">
				<div class="stat top">
				B
				</div>
				<div class="stat bottom">
				B%
				</div>	
			</div>
			<div class="boxes">
				<div class="stat top">
				C
				</div>
				<div class="stat bottom">
				C%
				</div>	
			</div>
			<div class="boxes">
				<div class="stat top">
				D
				</div>
				<div class="stat bottom">
				D%
				</div>	
			</div>
			<div class="boxes last">
				<div class="stat top">
				E
				</div>
				<div class="stat bottom">
				E%
				</div>	
			</div>
		</div>
		
		<div id="iconContain">
			<div class="icons iconFirst" help_text="The number of times the widget was viewed.">
				<div class="iconText">
				landed on the widget page
				</div>
			</div>
			<div class="icons iconSecond" help_text="You can browse and download this supporter information below.">
				<div class="iconText">
				gave their name &amp; email address
				</div>
			</div>
			<div class="icons iconThird" help_text="You can browse and download this supporter information below.">
				<div class="iconText">
				provided their mailing address
				</div>
			</div>
			<div class="icons iconFourth" help_text="Most supporters will need to confirm their email address before their letter is sent.">
				<div class="iconText">
				wrote letter to Congress
				</div>
			</div>
			<div class="icons iconFifth" help_text="Supporter letters will be sent to Congress shortly after this step is completed..">
				<div class="iconText textLast">
				confirmed email &amp; sent letter
				</div>
			</div>
		</div>
		
		<p id="iconHelp" class="help"> </p>
		<script type="text/javascript">
			$('#iconContain .icons').hover(
				function() { $('#iconHelp').text(this.getAttribute("help_text")); },
				function() { $('#iconHelp').text(''); });
		</script>
	</div>
	
	<div id="latest_activity" style="display: none">
		<h4>Live Feed</h4>
		<div id="latest_activity_container1">
		<div id="latest_activity_container2">
		<div id="latest_activity_template" style="display: none" class="recent_activity_item">
			<div><span class="header">From:</span> <span class="name">Winnie The Pooh</span> (<span class="district">WY0</span>)</div>
			<div><span class="header">To:</span> <span class="recipients">Sen. Ron Johnson [R, WI] and Sen. Herbert Kohl [D, WI]</span></div>
			<div><span class="header">Date:</span> <span class="date">July 19, 2011 at 7:25 p.m.</span></div>
			<p class="messagep"><span class="message">I support the bill because the bill does things but doesn't do other things but does do the right things...</span> <a href="">View More</a></p>
		</div>
		</div>
		</div>
		<div class="clear"> </div>
	</div>
	
	<h3>Widget Activity</h3>
	<p id="analytics_alt">There are no analytics to display for this campaign.</p>
	<div id="analytics_frame" style="width: 680px; margin-bottom: 15px;">
		<div style="float: left;">
			<!--<div class="chart_title">Widget Usage</div>-->
			<div id="analytics_activity" style="width: 680px;"> </div>
		</div>
		<!--
		<div style="float: left;">
			<div class="chart_title">Wrote a Personal Message?</div>
			<div id="analytics_personalized" style="width: 300px; height: 250px;"> </div>
		</div>
		-->
		<div class='clear'> </div>
	</div>

	<h3>Supporters</h3>
	<p id="supporters_alt">There are no supporters for this campaign yet. Why don&rsquo;t you create a <a href="/services/widgets#writecongress">widget</a> to drive your supporters to take action!</p>

	<p id="supporter_map_help" class="help">The map below shows each congressional district from which a letter to Congress was completed using your widget. The size of the circle indicates the number of individuals in that district.</p>
	<iframe id="supporters_map" width="940" height="590" border="0" marginheight="0" marginwidth="0" frameborder="0"></iframe>

	<table id="supporters_grid">
		<thead>
			<th>ID</th>
			<th>Date</th>
			<th>Email</th>
			<th>First Name</th>
			<th>Last Name</th>
			<th>ZIP Code</th>
            <th>Optional</th>
		</thead>
		<tbody>
		</tbody>
	</table>
	<a id="supporters_download" href="#overview">Download</a>
</div> <!-- tab_details -->

</div> <!-- e:tabs_panel -->	
{% endif %}

</div>	<!-- e:col_9 -->
</div> <!-- e:content -->

<script type="text/javascript">
	function myround(num) {
		if (!num) return 0;
		return Math.round(num);
	}
	function show_analytics(id) {
		var campaign_info;
		
		$('.ul_tags li').removeClass('active');
		
		if (id == null) {
			$('.tab_details .wTitle').text("No Campaign Selected");
			$('.tab_details .wSubTitle').text("Select a campaign from the list above.");
		} else {
			campaign_info = campaigns_info[id];
			$('.tab_details .wTitle').text(campaign_info.account_name);
			$('.tab_details .wSubTitle').text(campaign_info.title);
			$('#analytics_campaign_' + id).addClass("active");
		}
		
		if (id == null || !campaign_info.counts.total) {
			$("#analytics_alt, #supporters_alt").show();
			
			$('.tab_details .headRight').hide();
			$('#analytics_frame, #analyticsFunnel, #latest_activity').hide();
			$("#supporters_grid, #supporters_download, #supporters_map, #supporter_map_help").hide();
			return;
		}
		
		$('#analytics_alt, #supporters_alt').hide();
		
		$('.tab_details .headRight').show();
		$('#analytics_frame, #analyticsFunnel').show();
		$("#supporters_grid, #supporters_download, #supporters_map, #supporter_map_help").show();
		
		$('.tab_details .wDateStart').text(campaign_info.date_start);
		$('.tab_details .wDateEnd').text(campaign_info.date_end);
		
		if (!campaign_info.counts.start) campaign_info.counts.start = 0;
		if (!campaign_info.counts.address) campaign_info.counts.address = 0;
		if (!campaign_info.counts.finished) campaign_info.counts.finished = 0;
		var counts = [campaign_info.counts.hits, campaign_info.counts.total, campaign_info.counts.total-campaign_info.counts.start, campaign_info.counts.total-campaign_info.counts.start-campaign_info.counts.address, campaign_info.counts.finished];
		for (var i in counts) {
			//$('#analyticsFunnel #boxContain div.boxes:eq(' + i + ')').css({"height": 96+32*Math.log(counts[i]/counts[0]+1)/Math.log(2)});
			if (!counts[i]) counts[i] = 0;
			$('#analyticsFunnel #boxContain div.boxes:eq(' + i + ') .top').text(counts[i]);
			$('#analyticsFunnel #boxContain div.boxes:eq(' + i + ') .bottom').text(Math.round(100*counts[i]/counts[0]) + "%");
			if (i > 0 && counts[i] > counts[0]) {
				$('#analyticsFunnel #boxContain div.boxes:eq(0) .bottom').text("?");
				$('#analyticsFunnel #boxContain div.boxes:eq(' + i + ') .bottom').text("?");
			}
		}
		
		draw_timeseries('analytics_activity', campaign_info.mpstats);

		$('#supporters_grid').dataTable( {
			"bProcessing": true,
			"bServerSide": true,
			"sAjaxSource": campaign_info.download_url + "json",
			"bDestroy": true,
			//"bJQueryUI": true,
			"bFilter": false,
			"aaSorting": [[1,'desc']],
			"aLengthMenu": [15, 30, 50],
			"iDisplayLength": 15,
			"sScrollX": "100%",
			"aoColumns": [
				{ "sWidth": "50px" },
				{ "sWidth": "100px", "fnRender": function (cell) { return cell.aData[1].substr(0, 16); } },
				{ "sWidth": "120px" },
				{ "sWidth": "110px" },
				{ "sWidth": "130px" },
				{ "sWidth": "100px" },
                { "sWidth": "100px" }
				]
		} );
		
		$('#supporters_download').attr('href', campaign_info.download_url + "csv")
		
		$('#supporters_map').attr('src', campaign_info.mapurl);
		
		if (campaign_info.latest_data.length == 0) {
			$('#latest_activity').hide();
		} else {
			$('#latest_activity').show();
			$('#latest_activity .dynamic').detach();
			var templ = $('#latest_activity_template');
			var w = templ.width();
			$('#latest_activity_container2').width(campaign_info.latest_data.length * w);
			for (var i in campaign_info.latest_data) {
				var node = templ.clone();
				node.show();
				node.addClass("dynamic");
				node.find(".name").text(campaign_info.latest_data[i].name);
				node.find(".district").text(campaign_info.latest_data[i].district);
				node.find(".recipients").text(campaign_info.latest_data[i].recipients);
				node.find(".date").text(campaign_info.latest_data[i].date);
				node.find(".messagep").addClass(campaign_info.latest_data[i].position == "support" ? "support" : "oppose");
				node.find(".message").text(campaign_info.latest_data[i].message ? campaign_info.latest_data[i].message : "I " + campaign_info.latest_data[i].position + " " + campaign_info.billnumber + ".");
				node.find("a").toggle(campaign_info.latest_data[i].message ? true : false).attr("href", campaign_info.latest_data[i].link);
				node.insertBefore(templ);
			}
			
			function anim() {
				$('#latest_activity_container2').delay(4000).animate({'margin-left': -(w+10) + 'px'}, "slow", function() {
					var c = $('#latest_activity_container2');
					var n = c.find('.dynamic:eq(0)');
					n.detach();
					c.append(n);
					c.css({"margin-left": 0});
					anim();
				});
			}
			if (campaign_info.latest_data.length > 5)
				anim();
		}
	}

	$('.tabs').pvtabs(function(active_tab, is_initial, hash_argument) { if (active_tab == "details") show_analytics(hash_argument); });
</script>
{% endblock %}

