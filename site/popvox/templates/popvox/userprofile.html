{% extends "master.html" %}
{% load humanize %}
{% load popvox_utils %}
{% block title %}Profile{% endblock%}
{% block description %}Lorem Ipsum{% endblock %}
{%block nav_citzen_class_home%}active{%endblock%}
{%block extracss %}<link rel="stylesheet" href="/media/master/_style.css" type="text/css" media="screen" />{% endblock %}
{% block head %}
<script type="text/javascript" src="/media/js/highcharts.js"></script>
<script type="text/javascript" src="/media/js/charts.js"></script>

<style>
sup { font-size: 85%; font-style: italic; vertical-align:super; }
p.feedback { border-top: 1px solid #BBB; padding: 2px 10px 2px 10px; font-size: 10px; color: #666; }
p.feedback a { color: #CC7722; }
</style>
<script type="text/javascript">
function showdata(is_first_load, is_more) {
		update(true);
		
		isloading = true;
		
		$('#loadingstatus').text("Loading...");
		
		var pro_loading;
		var con_loading;
		if (is_more) {
			pro_loading = $("<p>Loading...</p>");
			$('#comments_pro').append(pro_loading);
			
			con_loading = $("<p>Loading...</p>");
			$('#comments_con').append(con_loading);
		}
		
		$.ajax({
			type:"GET",
			url: "/usercomments/{{profile.id}}"
			data: {
				start: (!is_more ? 0 : start),
				count: count
			},
			complete: function(res, status) {
				isloading = false;
				
				$('#loadingstatus').text("");
				
				if (status != "success") {
					$('#shortmessages').text("Error loading report.");
					return;
				}
				
				res = eval('(' + res.responseText + ')');
				
				if (res.debug_info)
					$('#debug_info').text(res.debug_info);
				
				c_pro = $('#comments_pro');
				c_con = $('#comments_con');
				
				if (!res.pro_more) $('#comments_pro_more').hide(); else $('#comments_pro_more').show();
				if (!res.con_more) $('#comments_con_more').hide(); else $('#comments_con_more').show();
				
				if (!is_more) {
					c_pro.html("");
					c_con.html("");
				} else {
					pro_loading.remove();
					con_loading.remove();
				}
				
				var n_pro = 0, n_con = 0;
				for (var i = 0; i < res.comments.length; i++) {
					c = res.comments[i];
					
					var elem = $('#comment_template div.comment').clone();
					
					elem.find("h4 span.date nobr").text(c.date);
					elem.find(".share a").attr("href", c.share);

					elem.find("p").text('');
					var msgpars = c.msg.split("\n");
					for (var j = 0; j < msgpars.length; j++) {
						var par = $('<div style="margin-bottom: 5px"/>');
						par.text(msgpars[j]);
						elem.find("p").append(par);
					}
					//elem.find("p").html(elem.find("p").html().replace("\n", "<br/><br/>"))

					if (c.verb != "supported" && c.verb != "opposed")
						elem.find(".verb").text(c.verb + " this bill");
					elem.find(".endorse_oppose_image").addClass((c.pos == "+") ? "endorse" : "oppose")
					if (res.can_appreciate == "both" || res.can_appreciate == c.pos) {
						elem.find(".appreciate a").attr("commentid", c.id);
						elem.find(".appreciate a").text((!c.appreciated ? "appreciate" : "appreciated"));
						if (c.appreciated) elem.find(".appreciate").addClass("active");
						elem.find(".appreciate span.text").hide();
					} else if (res.can_appreciate == "none") {
						elem.find(".appreciate a").hide();
						elem.find(".appreciate span.text").text("appreciation");
						elem.find(".appreciate span.text").attr("title", "you must weigh in on the bill first");
					} else if (res.can_appreciate == "+") {
						elem.find(".appreciate a").hide();
						elem.find(".appreciate span.text").text("appreciation");
						elem.find(".appreciate span.text").attr("title", "only opposing users can appreciate this comment");
					} else if (res.can_appreciate == "-") {
						elem.find(".appreciate a").hide();
						elem.find(".appreciate span.text").text("appreciation");
						elem.find(".appreciate span.text").attr("title", "only supporting users can appreciate this comment");
					}
					elem.find(".appreciate span.num").text(c.appreciates);
					elem.appendTo((c.pos == "+") ? c_pro : c_con);
					
					if (c.pos == "+") n_pro++; else n_con++;
				}
				if (n_pro == 0)
					c_pro.append($("<p>No supporting comments have been left" + (report_district != "" ? " in this district" : (report_state != "" ? " in this state" : "")) + ".</p>"));
				if (n_con == 0)
					c_con.append($("<p>No opposing comments have been left" + (report_district != "" ? " in this district" : (report_state != "" ? " in this state" : "")) + ".</p>"));
				
				if (is_more) return;
				
				function escapeHTML(text) {
					var div = document.createElement('div');
					var text = document.createTextNode(text);
					div.appendChild(text);
					return div.innerHTML;
				}
			}
		});

	}
	
	function more_comments() {
		if (isloading) return false;
		start = count;
		count *= 2;
		showdata(false, true);
		return false;
	}
	
</script>
{% endblock %}
{% block subnav %}{% include "popvox/home_user_subnav.html" %}{% endblock %}
{% block content %}
<div class="content profile">

    <div class="col_9 col_top">
        <h1 class="rule_btm">User Profile - {{user.get_name}}</h1>
<h2>{{profile.tagline}}</h2>
        {% if district %}district: {{district}}{% endif %}<br/>
        bills supported: {{commentssup|length}}<br/>
        bills opposed: {{commentsopp|length}}<br/>
        letters written: {{letters}}<br/>
        description:<div>{{profile.bio}}

<div style="display: none" id="comment_template">
		<div class="comment clear">
			<h4>
				<span class="date"><nobr>Tuesday</nobr></span>
				<span class="verb"> </span>
			</h4>
			<p class="usercomment endorse_oppose_image">Lorem ipsum etc etc</p>
			<div class="clear"> </div>
			<div class="appreciate"><a href="#" onclick="return digg(this);">appreciate</a><span class="text">...</span><span class="num">96</span></div>
			<div class="share"><a href="">share</a></div>
			<div class="clear"> </div>
		</div>
	</div>
		<div class="comments">
			<h3>Supporting comments</h3>
			<div id="comments_pro">
			</div>

			<h3>Opposing comments</h3>
			<div id="comments_con">
			</div>
		</div>
			
	</div>
    
    
</div>

{% if request.META.HTTP_DNT != 1 %}
{% comment %}Our master share bar is disabled on this page, otherwise we'd be loading this script twice.{% endcomment %}
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
{% endif %}

{% endblock %}

