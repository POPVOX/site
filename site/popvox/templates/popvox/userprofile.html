{% load humanize %}
{% load popvox_utils %}
{% xextends "master.html" with newstyle=True %}
{% block title %}Profile{% endblock%}
{% block description %}Lorem Ipsum{% endblock %}
{%block nav_citizen_class_home%}active{%endblock%}
{% block head %}
<script type="text/javascript" src="/media/js/highcharts.js"></script>
<script type="text/javascript" src="/media/js/charts.js"></script>

<style>
sup { font-size: 85%; font-style: italic; vertical-align:super; }
p.feedback { border-top: 1px solid #BBB; padding: 2px 10px 2px 10px; font-size: 10px; color: #666; }
p.feedback a { color: #CC7722; }
</style>
        <script type="text/javascript">
        function updateprofile(validate) {
            ajaxform("/ajax/userprofile/updatefields",
                {   
                    "showcomments": "#showcomments",
                },
                {
                    statusfield: "errorlabel",
                    savebutton: "submitbutton",
                    success: function(res) {
                    }
                }
                );
        }
</script>
<script type="text/javascript">
function showdata(is_first_load, is_more) {
		update(true);
		
		isloading = true;
		
		$('#loadingstatus').text("Loading...");
		
		var pro_loading;
		var con_loading;
		if (is_more) {
			pro_loading = $("<p>Loading...</p>");
			$('#comments_pro').append(pro_loading);
			
			con_loading = $("<p>Loading...</p>");
			$('#comments_con').append(con_loading);
		}
		
		$.ajax({
			type:"GET",
			url: "/usercomments/{{profile.id}}"
			data: {
				start: (!is_more ? 0 : start),
				count: count
			},
			complete: function(res, status) {
				isloading = false;
				
				$('#loadingstatus').text("");
				
				if (status != "success") {
					$('#shortmessages').text("Error loading report.");
					return;
				}
				
				res = eval('(' + res.responseText + ')');
				
				if (res.debug_info)
					$('#debug_info').text(res.debug_info);
				
				c_pro = $('#comments_pro');
				c_con = $('#comments_con');
				
				if (!res.pro_more) $('#comments_pro_more').hide(); else $('#comments_pro_more').show();
				if (!res.con_more) $('#comments_con_more').hide(); else $('#comments_con_more').show();
				
				if (!is_more) {
					c_pro.html("");
					c_con.html("");
				} else {
					pro_loading.remove();
					con_loading.remove();
				}
				
				var n_pro = 0, n_con = 0;
				for (var i = 0; i < res.comments.length; i++) {
					c = res.comments[i];
					
					var elem = $('#comment_template div.comment').clone();
					
					elem.find("h4 span.date nobr").text(c.date);
					elem.find(".share a").attr("href", c.share);

					elem.find("p").text('');
					var msgpars = c.msg.split("\n");
					for (var j = 0; j < msgpars.length; j++) {
						var par = $('<div style="margin-bottom: 5px"/>');
						par.text(msgpars[j]);
						elem.find("p").append(par);
					}
					//elem.find("p").html(elem.find("p").html().replace("\n", "<br/><br/>"))

					if (c.verb != "supported" && c.verb != "opposed")
						elem.find(".verb").text(c.verb + " this bill");
					elem.find(".endorse_oppose_image").addClass((c.pos == "+") ? "endorse" : "oppose")
					if (res.can_appreciate == "both" || res.can_appreciate == c.pos) {
						elem.find(".appreciate a").attr("commentid", c.id);
						elem.find(".appreciate a").text((!c.appreciated ? "appreciate" : "appreciated"));
						if (c.appreciated) elem.find(".appreciate").addClass("active");
						elem.find(".appreciate span.text").hide();
					} else if (res.can_appreciate == "none") {
						elem.find(".appreciate a").hide();
						elem.find(".appreciate span.text").text("appreciation");
						elem.find(".appreciate span.text").attr("title", "you must weigh in on the bill first");
					} else if (res.can_appreciate == "+") {
						elem.find(".appreciate a").hide();
						elem.find(".appreciate span.text").text("appreciation");
						elem.find(".appreciate span.text").attr("title", "only opposing users can appreciate this comment");
					} else if (res.can_appreciate == "-") {
						elem.find(".appreciate a").hide();
						elem.find(".appreciate span.text").text("appreciation");
						elem.find(".appreciate span.text").attr("title", "only supporting users can appreciate this comment");
					}
					elem.find(".appreciate span.num").text(c.appreciates);
					elem.appendTo((c.pos == "+") ? c_pro : c_con);
					
					if (c.pos == "+") n_pro++; else n_con++;
				}
				if (n_pro == 0)
					c_pro.append($("<p>No supporting comments have been left" + (report_district != "" ? " in this district" : (report_state != "" ? " in this state" : "")) + ".</p>"));
				if (n_con == 0)
					c_con.append($("<p>No opposing comments have been left" + (report_district != "" ? " in this district" : (report_state != "" ? " in this state" : "")) + ".</p>"));
				
				if (is_more) return;
				
				function escapeHTML(text) {
					var div = document.createElement('div');
					var text = document.createTextNode(text);
					div.appendChild(text);
					return div.innerHTML;
				}
			}
		});

	}
	
	function more_comments() {
		if (isloading) return false;
		start = count;
		count *= 2;
		showdata(false, true);
		return false;
	}
	
</script>
{% endblock %}
{% block extracss %}<link rel="stylesheet" href="/media/master/_style.css" type="text/css" media="screen" />{% endblock %}
{% block subnav %}{% include "popvox/home_user_subnav.html" %}{% endblock %}
{% block content %}
<div class="new_pv">
<header id="header">
	<div class="inner">
		<h1 class="crumb-title">PROFILE / {{user.get_name}}
	</div>
</header><!-- e: header -->

<section id="page">
	<div class="inner">
		{% if pageowner %}
			<form>
				<input id="showcomments" type="checkbox" checked="{{showcomments}}"/>
				<label for="showcomments">Display my comments on my profile</label>
				<br/>
				<input type="button" class="submit" id="submitbutton" value="Save" onclick="updateprofile(false)" style="margin-top: 25px ; margin-bottom: 25px;"/>
				<p id="errorlabel" class="error clear"/>
			</form>
		{% endif %}

		<section class="my-profile">
			<div class="my-details">

				<h2>Details</h2>
				<h3>{% if profile.tagline %}{{profile.tagline}}{% endif %}</h3>
				<div class="avatarlg">{{prettydistrict}}</div>
			</div>
			<div class="my-stats">
				<h2>Stats</h2>
				<ul>
					<li class="stat1"><strong>{{numcommentssup}}</strong> bills<br/>supported</li>
					<li class="stat2"><strong>{{numcommentsopp}}</strong> bills<br/>opposed</li>
					<li class="stat3"><strong>{{letters}}</strong> letters<br/>written</li>
					<li class="stat4"><strong>{{appreciates}}</strong> total<br/>appreciates</li>
				</ul>
			</div>

			{% comment %}<div class="my-district">
				<h2>District</h2>
				<h3><a href="#">Tennessee's 8th</a></h3>
				<img src="img/district.jpg" alt="" />
			</div> {% endcomment %}

			<div class="my-members">
				<h2>Members</h2>
				<ul>
					{% for member in members %}
					<li><img src="/static/member_photos/{{member.id}}-100px.jpeg" alt="{{member.name}}"/><a href="/member/{{member.pvurl}}">{{member.name}}</a></li>
					{% endfor %}
				</ul>
			</div>
		</section>

		{% comment %}<article class="my-bio">
			<h2>Bio</h2>
				{% if profile.bio %}{{profile.bio}}</div>{% endif %}
		</article>{% endcomment %}
			
		

		<div style="display: none" id="comment_template">
			<div class="comment clear">
				<h4>
					<span class="date"><nobr>Tuesday</nobr></span>
					<span class="verb"> </span>
				</h4>
				<p class="usercomment endorse_oppose_image">Lorem ipsum etc etc</p>
				<div class="clear"> </div>
				<div class="appreciate"><a href="#" onclick="return digg(this);">appreciate</a><span class="text">...</span><span class="num">96</span></div>
				<div class="share"><a href="">share</a></div>
				<div class="clear"> </div>
			</div>
		</div>

		{% if commentssup and commentsopp %}
		<div class="split-col clean">
			<h3 class="support-header">Supporting comments</h3>
			{% for c in commentssup %}
				<div class="support-quote">
					<p><strong>{{c.bill.nicename}}</strong></p>
					<blockquote>{{c.message}}</blockquote>
					<!-- <a href="#" class="btn">View More</a> -->
				</div>
				<div class="support-quote-details">
					<span class="supporting-avatar"><img src="/media/master/img/avatar.png" alt="" /><strong>{{user.get_name}}<br />{{district}}</strong></span>
					<em class="date">{{c.created}}</em>
					<a href="#" class="appreciate">{{c.diggs.count}} <span>Appreciate</span></a>
				</div>
			 {% endfor %}
		</div>
		<div class="split-col clean">
			<h3 class="oppose-header">Opposing comments</h3>
			 {% for c in commentsopp %}
				<div class="oppose-quote">
					<p><strong>{{c.bill.nicename}}</strong></p>
					<blockquote>{{c.message}}</blockquote>
					<!-- <a href="#" class="btn">View More</a> -->
				</div>
				<div class="oppose-quote-details">
					<span class="supporting-avatar"><img src="/media/master/img/avatar.png" alt="" /><strong>{{user.get_name}}<br />{{district}}</strong></span>
					<em class="date">{{c.created}}</em>
					<a href="#" class="appreciate">{{c.diggs.count}} <span>Appreciate</span></a>
				</div>
			 {% endfor %}
		</div>
		{% endif %}
			
	</div><!-- e: inner -->
</section><!-- e: page -->

</div><!-- new_pv wrapper -->

{% if request.META.HTTP_DNT != 1 %}
{% comment %}Our master share bar is disabled on this page, otherwise we'd be loading this script twice.{% endcomment %}
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
{% endif %}

{% endblock %}

