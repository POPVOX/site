{% extends "master.html" %}
{% load popvox_utils %}
{% block title %}POPVOX Services: Widgets{% endblock%}
{% block head %}

<link rel="stylesheet" media="screen" type="text/css" href="/media/css/jquery.miniColors.css" />
<script type="text/javascript" src="/media/js/jquery.miniColors.js"></script>

<style>

</style>

<link rel="stylesheet" href="/media/widget/widget.css" type="text/css" media="screen" />

<script>
var accounts = [
	{% for account in accounts %}
	{
		name: "{{account|escapejs}}",
		key: "{{account.api_key|escapejs}}",
		permissions: {% templatetag openbrace %}{% for p in account.permissions.all %}"{{p.name|escapejs}}": true{% if not forloop.last %},{% endif %}{% endfor %}}
	}{% if not forloop.last %},{% endif %}
	{% endfor %}
];

function account_changed() {
	var permissions = [];
	
	{% if accounts|length > 0 %}
	if ($('#serviceaccount').val() != "")
		permissions = accounts[$('#serviceaccount').val()].permissions;
	{% endif %}
		
	plus_enabled = permissions["commentstream_theme"];
	
	if (plus_enabled) $('.plus .panel').removeClass("disabled"); else $('.plus .panel').addClass("disabled");
	$('.plus input').attr("disabled", plus_enabled ? '' : '1')
	$(".miniColors").miniColors('disabled', !plus_enabled);
	
	update_preview();
}

function update_preview() {
	var widgettype = "commentstream";
	var opts = "";
	
	var bills = [];
	if (!$('#commentstream_bills').hasClass("default")) bills = $('#commentstream_bills').val().split(/,\s*/);
	if (bills[0] == "") bills = [];
	$('#commentstream_bills_error').hide();
	for (var i = 0; i < bills.length; i++) {
		var bill_re = /^(supporting|opposing)?(HR|S|HRES|SRES|HJRES|SJRES|HCONRES|SCONRES)(\d+)(\/(\d+))?$/i;
		var match = bill_re.exec(bills[i].replace(/\s/g, "").replace(/\./g, ""));
		if (!match) {
			$('#commentstream_bills_error').text("I didn't understand <" + bills[i] + ">. Example bill numbers are H.R. 1, S. 2, H.Res. 3, etc. Precede a bill number with \"supporting\" or \"opposing\" to show only show supporting or opposing comments. Separate multiple bills with commas.");
			$('#commentstream_bills_error').show();
			return;
		}
		
		var support_oppose = match[1];
		var billtype = match[2].replace(/\s/g, "").replace(/\./g, "").toLowerCase();
		var billnumber = match[3];
		var congressnumber = match[5]; // possibly undefined, GovTrack style prev congress search
		if (!congressnumber) congressnumber = {{current_congress}};
		
		bills[i] = "us/" + congressnumber + "/" + billtype + billnumber + (support_oppose ? ":" + support_oppose : "");
	}
	if (bills.length > 0) opts += "&bills=" + bills;
	
	var ix = $('#commentstream_issuearea').val();
	if (ix) opts += "&issue=" + ix;
	
	var state = $('#commentstream_state').val();
	if (state) opts += "&state=" + state;
	
	var width = $('#size_width').val() || 240;
	var height = $('#size_height').val() || 350;
	
	var account = "";
	
	{% if accounts|length > 0 %}
	if ($('#serviceaccount').val() != "") {
		// Only apply these configuration options if they are permitted.
		var clrs = ["sbg", "sfg", "lnk", "bg", "fg"];
		for (var e in clrs)
			opts += "&" + clrs[e] + "=" + $('#color_' + clrs[e]).val().replace("#", "");
		
		/*if ($('#commentstream_scrollmode_scroll')[0].checked)
			opts += "&scroll=bar";
		else
			opts += "&scroll=animate";*/
		
		account = accounts[$('#serviceaccount').val()].key
	}
	{% endif %}
		
	function make_code(host, width, height) {
		return '<iframe src="' + host + '/services/widgets/w/' + widgettype + '?iframe=1' + (account ? "&api_key=" + account : "") + opts + '" width="' + width + '" height="' + height + '" border="0" frameBorder="0"> </iframe>';
	}

	var prv = make_code("", 240, 350);
	if ($('#preview').html() != prv) $('#preview').html(prv);

	$('#code').val(make_code("https://www.popvox.com", width, height));
}

$(function() {
	$('.form input[type=text]').keyup_delayed(function() { update_preview(); });
	$('.form select').change(function() { update_preview(); });
	$('.form input[type=radio]').click(function() { update_preview(); });
	account_changed();
});

var minicolors_opts = {
	change: function(hex, rgb) {
		$('#color_sbg').keyup(); // trigger delayed update of preview
	}
};
</script>
{% endblock %}
{% block content %}
<div class="content widgetizer">

	<h1>POPVOX Widgets</h1>
	
	<div class="config_pane">
		<p>The Comment Stream Widget displays the most recent constituent comments left on POPVOX for a given bill or issue area.</p>
		
		{% if accounts|length > 0 %}
		{% comment %}This goes outside of the form so that the select doesn't trigger a preview update.{% endcomment %}

		<div class="block1" style="text-align: center">
			<label for="serviceaccount">Service Account:</label>
			<select id="serviceaccount" onchange="account_changed()">
				<option value="">- Free Services Only -</option>
				{% for account in accounts %}
					<option value="{{forloop.counter0}}" {% if forloop.first %}selected="1"{% endif %}>{{account}}</option>
				{% endfor %}
			</select>
		</div>
		{% endif %}
	
		<form class="form">
		
			<div class="block2">
				<div class="vert">
					<label for="commentstream_bills">Related to these bills</label>
					<input id="commentstream_bills" type="text" value="supporting S. 724" class="c2"/>
					<!--<script>$('#commentstream_bills').input_default("supporting H.R. 1234");</script>-->
				</div>
				<div class="vert">
					<p class="or">or</p>
				</div>
				<div class="vert">
					<label for="commentstream_issuearea">Related to this subject</label>
					<select id="commentstream_issuearea" class="c3">
						<option value="">(All)</option>
						{% for ix in issueareas %}
							<option value="{{ix.id}}">{{ix.name}}</option>
						{% endfor %}
					</select>
				</div>
	
				<div class="clear"> </div>
		
				<div id="commentstream_bills_error" class="error"> </div>
				
				<div class="vert">
					<label for="commentstream_state">Show users in</label>
					<select id="commentstream_state" class="c2">
						<option value="">(All)</option>
						{% for abbr, name in states %}
							<option value="{{abbr}}">{{name}}</option>
						{% endfor %}
					</select>
				</div>
		
				<div class="clear "> </div>
			</div><!-- e: block -->	
			
			<div class="block3">
				<!--<h4>Basic </h4><p class="free">(free)</p>-->
				<h5 class="clear">Widget Dimensions</h5>
				<div class="vert">
					<label for="commentstream_width">Width (px)</label>
					<input id="commentstream_width" type="text" value="" class="c2"/>
				</div>
				<div class="vert">
					<label for="commentstream_height">Height (px)</label>
					<input id="commentstream_height" type="text" value="" class="c2"/>
				</div>
				<!--
				<div class="vert">
					<p class="or">or</p>
				</div>
				<div class="radio vert">
					<input class="auto" type="radio" name="" value="auto"/>
					<label class="auto" for="auto">Auto</label>
				</div>
				-->
				<div class="vert last">
					<p><small>Widget size does not update in preview.</small></p>
				</div>
				<div class="clear"> </div>
			</div><!-- e: block2 -->
			
			<div class="plus">
				<h4>PLUS <span class="small">contact us for details</span></h4> <!--<p class="b_upgrade btn"><a href="#">upgrade</a>--></p>
				<div class="clear"> </div>
				
				<div class="panel">
					<h5>Widget Colors</h5>
					
					<div class="vert">
						<input id="color_sbg" type="text" value="#b36015" class="colorpicker"/>
						<label for="color_sbg">shell background</label>
						<script>$('#color_sbg').miniColors(minicolors_opts);</script>
					</div>
					
					<div class="vert">
						<input id="color_sfg" type="text" value="#ffffff" class="colorpicker"/>
						<label for="color_sfg">shell text</label>
						<script>$('#color_sfg').miniColors(minicolors_opts);</script>
					</div>
			
					<div class="vert">
						<input id="color_lnk" type="text" value="#cc6A11" class="colorpicker"/>
						<label for="color_lnk">link</label>
						<script>$('#color_lnk').miniColors(minicolors_opts);</script>
					</div>
					
					<div class="clear"> </div>
			
					<div class="vert">
						<input id="color_bg" type="text" value="#eeeeee" class="colorpicker"/>
						<label for="color_bg">comment background</label>
						<script>$('#color_bg').miniColors(minicolors_opts);</script>
					</div>
					
					<div class="vert">
						<input id="color_fg" type="text" value="#404045" class="colorpicker"/>
						<label for="color_fg">comment text</label>
						<script>$('#color_fg').miniColors(minicolors_opts);</script>
					</div>
				
				</div><!-- e: panel -->
				<div class="clear"> </div>
				
<!--			<h4>Animation</h4>
		
				<div class="radio">
					<input id="commentstream_scrollmode_scroll" type="radio" name="commentstream_scrollmode" value="scrollbar" checked="1"/>
					<label for="commentstream_scrollmode_scroll">Scrollbar</label>
				</div>
				<div class="radio">
					<input id="commentstream_scrollmode_animate" type="radio" name="commentstream_scrollmode" value="animate"/>
					<label for="commentstream_scrollmode_animate">Animate</label>
				</div>
-->			</div>
		</form><!-- e: form -->
	</div>
	
	<div class="preview_pane">
		<h3 class="no_rule">Preview</h3>

		<div id="preview">
		</div>
	
		<p style="margin-top: 15px">Copy and paste the following HTML code into your website:</p>
		
		<textarea id="code" style="width: 100%; height: 15em"> </textarea>
	</div>
</div><!-- e: content -->

{% endblock %}

