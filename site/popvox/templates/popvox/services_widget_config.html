{% extends "master.html" %}
{% load popvox_utils %}
{% block title %}POPVOX Services: Widgets{% endblock%}
{% block head %}
<link rel="stylesheet" media="screen" type="text/css" href="/media/css/jquery.miniColors.css" />
<script type="text/javascript" src="/media/js/jquery.miniColors.js"></script>
<script type="text/javascript" src="/media/js/jquery.ba-bbq.min.js"></script>

<style>
/* splash tab */

#wTop .left {
	width: 150px;
	float: left;
	padding: 20px;
	}

#wTop .right {
	border: none;
	padding: 20px 20px 20px 0;
	}
	#wTop .right p {
		font-size: 18px;
		line-height: 150%;
		font-weight: bold;
		}

.wBottom {
	background: #D4D1CA;
	clear: both;
	padding: 20px;
	}

#splash h3 {
	margin-top: 0;
	padding-top: 0;
	background-image: none;
	line-height: 150%;
	}

.left {
	width: 150px;
	float: left;
	}

.right {
	width: 729px;
	float: right;
	border-left: #404040 1px solid;
	padding-left: 20px;
	}

	.right h3 {
		margin-top: 0;
		padding-top: 0;
		}

ul#wSelect {
	list-style-type: none;
	padding: 0;
	margin: 0;
	}

.blob {
	clear: both;
	margin: 30px 0 20px 0;
	background: #D4D1CA; 
	padding: 20px 0;
	}

	.blob h3 {
		padding: 20px;
		margin: 0;
		}

	.blob p {
		padding: 0 20px;
		margin: 0 0 10px 0px;
		}
	
	.blob .left {
		width: 400px;
		float: left;
		}
		
	.blob .right {
		width: 400px;
		float: right;
		border: none;
		}

/* configuration forms */

.form .plus h4 a {
    background: none repeat scroll 0 0 #ACACB0;
    color: #FFFFFF;
    font-family: georgia;
    font-size: 11px;
    font-style: italic;
    margin-top: -3px; 
    margin-left: 10px;
    padding: 2px 5px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    -khtml-border-radius: 3px;
    border-radius: 3px;
}
.form .plus h4 a:hover {
	border-bottom: none;
	background: #b36015;
	}
</style>

<link rel="stylesheet" href="/media/widget/widget.css" type="text/css" media="screen" />

<script>
function splash_tab(tab) {
	$('#wSelect>li').removeClass("active");
	$(tab.parentNode).addClass("active");
	$('#splash .wBottom .right>div').each(function() {
		$(this).toggle(this.getAttribute("tab") == tab.getAttribute("tab"));
	});
	return false;
}

var accounts = [
	{% for account in accounts %}
	{
		id: {{account.id}},
		name: "{{account|escapejs}}",
		api_key: "{{account.api_key|escapejs}}",
		secret_key: "{{account.secret_key|escapejs}}",
		permissions: {% templatetag openbrace %}{% for p in account.permissions.all %}"{{p.name|escapejs}}": true{% if not forloop.last %}, {% endif %}{% endfor %}},
		bill_positions: [{% for p in account.org.positions_can_comment %}
				{% templatetag openbrace %} id: {{p.id}},
				campaign: {% if p.campaign.default %}null{% else %}"{{p.campaign.name|truncatewords:3|escapejs}}"{% endif %},
					position: "{{p.position}}",
					bill: "{{p.bill.title|truncatewords:6|escapejs}}" {% templatetag closebrace %}{% if not forloop.last %},{% endif %}{% endfor %} ],
		has_fb_page: {% if account.fb_page_id %}true{% else %}false{% endif %}
	}{% if not forloop.last %},{% endif %}
	{% endfor %}
];

var current_account;
var widgettype;

function change_widget(tab) {
	widgettype = tab.getAttribute("href").substr(1);
	$('ul.tabs li').removeClass("active");
	$(tab.parentNode).addClass("active");
	
	if (widgettype == "splash") {
		$('.config_pane, .preview_pane').hide();
		$('#splash').show();
		return;
	} else {
		$('.config_pane, .preview_pane').show();
		$('#splash').hide();
	}
	
	$('.widget_opts').hide();
	$('.' + widgettype + '_opts').show();

	$('.preview_pane').show();
	$('.preview_pane iframe').hide();
	
	if (widgettype == "commentstream") {
		$('#widget_description').html("The Comment Stream Widget displays the most recent constituent comments left on POPVOX for a given bill or issue area.");
		$('#code').css({width: "230px"});
		$('.config_pane').animate({width: '640px'});
		$('.preview_pane').animate({width: '240px'});
	}

	if (widgettype == "writecongress") {
		$('#widget_description').html("The Write Congress Widget can be placed on your website to power letter-writing calls to action.");
		$('#code').css({width: "450px"});
		$('.config_pane').animate({width: '400px'});
		$('.preview_pane').animate({width: '460px'});
	}
	
	if (widgettype == "integration") {
		$('#widget_description').html("POPVOX widgets can be integrated into several other services. Please contact Rachna at <a href=\"mailto:rachna@popvox.com\">rachna@popvox.com</a> for details.");
		$('.preview_pane').hide();
		$('.config_pane').animate({width: '640px'});
	}

	//update_preview();
	window.setTimeout("update_preview()", 600);
	
	return false;
}

function account_changed() {
	var permissions = [];
	var fb_enabled = false;
	
	$('.secret_key').text("<not available with a free account>");
	
	current_account = null;
	{% if accounts|length > 0 %}
	var acct_idx = $('#serviceaccount').val();
	if (acct_idx != "") {
		current_account = accounts[acct_idx].id;
		permissions = accounts[acct_idx].permissions;
		fb_enabled = accounts[acct_idx].has_fb_page;
		$('.secret_key').text(accounts[acct_idx].secret_key);
	}
	{% endif %}
		
	plus_enabled = permissions["commentstream_theme"];
	fb_enabled &= permissions["fb_page"];
	
	if (plus_enabled) $('.plus .panel').removeClass("disabled"); else $('.plus .panel').addClass("disabled");
	$('.plus input').attr("disabled", plus_enabled ? '' : '1')
	$(".miniColors").miniColors('disabled', !plus_enabled);
	
	$('#writecongress_bill_1').hide();
	$('#writecongress_bill_2').show();
	$('#writecongress_bill_position').text('');
	{% if accounts|length > 0 %}
	if (acct_idx != "") {
		$('#writecongress_bill_1').show();
		$('#writecongress_bill_2').hide();
		$('#writecongress_bill_position').text('');
		for (var j = 0; j < accounts[acct_idx].bill_positions.length; j++) {
			var opt = $('<option/>');
			opt.attr('value', accounts[acct_idx].bill_positions[j].id);
			opt.text(
				(accounts[acct_idx].bill_positions[j].campaign ? accounts[acct_idx].bill_positions[j].campaign + ": " : "") 
				+ (accounts[acct_idx].bill_positions[j].position == "+" ? "Support " : "Oppose ")
				+ accounts[acct_idx].bill_positions[j].bill
				);
			$('#writecongress_bill_position').append(opt);
		}
	}
	{% endif %}
	
	if (!fb_enabled)
		$('#fb_page').hide();
	else
		$('#fb_page').show();
	
	update_preview();
}

var last_preview_html = "";
var fb_code = "";

function update_preview() {
	var opts = "";
	var default_width;
	var default_height;
	var can_change_height = true;
	var supports_bg = true;
	
	if (widgettype == "commentstream") {
		if (this && this.id=="commentstream_issuearea" && $('#commentstream_issuearea').val() != "") $('#commentstream_bills').val("");
		if (this && this.id=="commentstream_bills" && $('#commentstream_bills').val() != "") $('#commentstream_issuearea').val("");
		
		var bills = [];
		if (!$('#commentstream_bills').hasClass("default")) bills = $('#commentstream_bills').val().split(/,\s*/);
		if (bills[0] == "") bills = [];
		$('#commentstream_bills_error').hide();
		for (var i = 0; i < bills.length; i++) {
			var bill_re = /^(supporting|opposing)?(HR|S|HRES|SRES|HJRES|SJRES|HCONRES|SCONRES)(\d+)(\/(\d+))?$/i;
			var match = bill_re.exec(bills[i].replace(/\s/g, "").replace(/\./g, ""));
			if (!match) {
				$('#commentstream_bills_error').text("I didn't understand <" + bills[i] + ">. Example bill numbers are H.R. 1, S. 2, H.Res. 3, etc. Precede a bill number with \"supporting\" or \"opposing\" to show only show supporting or opposing comments. Separate multiple bills with commas.");
				$('#commentstream_bills_error').show();
				return;
			}
			
			var support_oppose = match[1];
			var billtype = match[2].replace(/\s/g, "").replace(/\./g, "").toLowerCase();
			var billnumber = match[3];
			var congressnumber = match[5]; // possibly undefined, GovTrack style prev congress search
			if (!congressnumber) congressnumber = {{current_congress}};
			
			bills[i] = "us/" + congressnumber + "/" + billtype + billnumber + (support_oppose ? ":" + support_oppose : "");
		}
		if (bills.length > 0) opts += "&bills=" + bills;
		
		var ix = $('#commentstream_issuearea').val();
		if (ix) opts += "&issue=" + ix;
		
		var state = $('#commentstream_state').val();
		if (state) opts += "&state=" + state;
		
		default_width = 240;
		default_height = 350;
	}
	
	if (widgettype == "writecongress") {
		var acct_idx = "";
		{% if accounts|length > 0 %}
		acct_idx = $('#serviceaccount').val();
		{% endif %}
		
		if (acct_idx == "") {
			$('#writecongress_bill_error').hide();
			var bill_re = /^(HR|S|HRES|SRES|HJRES|SJRES|HCONRES|SCONRES)(\d+)(\/(\d+))?$/i;
			var match = bill_re.exec($('#writecongress_bill').val().replace(/\s/g, "").replace(/\./g, ""));
			if (!match) {
				$('#writecongress_bill_error').text("Example bill numbers are H.R. 1, S. 2, H.Res. 3, etc.");
				$('#writecongress_bill_error').show();
				return;
			}
			
			var support_oppose = match[0];
			var billtype = match[1].replace(/\s/g, "").replace(/\./g, "").toLowerCase();
			var billnumber = match[2];
			var congressnumber = match[4]; // possibly undefined, GovTrack style prev congress search
			if (!congressnumber) congressnumber = {{current_congress}};
			
			bill = "us/" + congressnumber + "/" + billtype + billnumber;
			
			opts += "&bill=" + bill;
			opts += "&position=" + $('#writecongress_position').val();
		} else {
			opts += "&ocp=" + $('#writecongress_bill_position').val();
		}
		
		default_width = 460;
		default_height = 773;
		can_change_height = false;
		supports_bg = false;
	}
	
	if (widgettype == "integrations" || widgettype == "splash") {
		return;
	}
	
	var width = $('#widget_width').val() || default_width;
	var height = (can_change_height && $('#widget_height').val()) || default_height;
	
	var account = "";
	
	{% if accounts|length > 0 %}
	if ($('#serviceaccount').val() != "") {
		// Only apply these configuration options if they are permitted.
		var clrs = ["sbg", "sfg", "lnk", "bg", "fg"];
		for (var e in clrs)
			if (clrs[e] != "bg" || supports_bg)
				opts += "&" + clrs[e] + "=" + $('#color_' + clrs[e]).val().replace("#", "");
		
		/*if ($('#commentstream_scrollmode_scroll')[0].checked)
			opts += "&scroll=bar";
		else
			opts += "&scroll=animate";*/
		
		account = accounts[$('#serviceaccount').val()].api_key
	}
	{% endif %}
		
	function make_code(host, width, height, demo) {
		return '<iframe src="' + host + '/services/widgets/w/' + (account ? "account/" + account + "/" : "") + widgettype + '?iframe=1' + opts + "&user_info=" + (demo ? "&demo=1{% if user.is_staff %}&debug=1{% endif %}" : "") + '" width="' + width + '" height="' + height + '" border="0" frameBorder="0"> </iframe>';
	}

	var prv = make_code("", default_width, default_height, true);
	if (last_preview_html != prv) $('#preview').html(prv);
	last_preview_html = prv;

	$('#code').val(make_code("https://www.popvox.com", width, height, false));

	fb_code = make_code("https://www.popvox.com", "520", height, false);
	
	$('.preview_pane iframe').show();

	$('#fb_page a').show();
	$('#fb_page span').hide();
}

function set_fb_page_code() {
	$('#fb_page a').hide();
	$('#fb_page span').show();
	$('#fb_page span').text("Saving...");

	$.ajax({
			url: "/ajax/services/setopt",
			data: {
				account: current_account,
				name: "fb_page_code",
				value: $('#code').val()
			},
			type: "POST",
			dataType: "json",
			success: function(data, textStatus, jqXHR) {
				if (data.status == "fail") {
					$('#fb_page a').show();
					$('#fb_page span').text(data.msg);
				} else {
					$('#fb_page span').text("Your Facebook tab has been updated.");
				}
			},
			error: function(jqXHR, textStatus, errorThrown) {
				$('#fb_page a').show();
				$('#fb_page span').text("We're having technical difficulties.");
			}
		});

	return false;
}

$(window).bind("hashchange", function() {
	open_tab();
});
function open_tab() {
	$('ul.tabs li a').each(function() {
			if (this.getAttribute("href") == window.location.hash)
				change_widget(this);
	});
}

$(function() {
	$('.form input[type=text]').keyup_delayed(update_preview);
	$('.form select').change(update_preview);
	$('.form input[type=radio]').click(update_preview);
	
	splash_tab($('#wSelect li a')[0]);
	
	change_widget($('ul.tabs li a')[0]);
	open_tab(); // open from URL fragment
	
	account_changed();
});

var minicolors_opts = {
	change: function(hex, rgb) {
		$('#color_sbg').keyup(); // trigger delayed update of preview
	}
};
</script>
{% endblock %}
{% block content %}
<div class="content widgetizer">

	<h1>POPVOX Widgets</h1>

	{% if accounts|length > 0 %}
	{% comment %}This goes outside of the form so that the select doesn't trigger a preview update.{% endcomment %}

	<div class="block1">
		<label for="serviceaccount">Service Account:</label>
		<select id="serviceaccount" onchange="account_changed()">
			<option value="">- Free Services Only -</option>
			{% for account in accounts %}
				<option value="{{forloop.counter0}}" {% if forloop.first %}selected="1"{% endif %}>{{account}}</option>
			{% endfor %}
		</select>
	</div>
	{% endif %}
	
	<ul class="tabs">
		<li><a href="#splash"><span>What Are They?</span></a></li>
	
		<li><a href="#commentstream"><span>Comment Stream</span></a></li>
		<li><a href="#writecongress"><span>Write Congress</span></a></li>
		
		<li><a href="#integration"><span>Integrations</span></a></li>
	</ul>

	<div id="splash">
		<div id="wTop">
			<div class="left">
				<img src="/media/widget/widgetpage_cogs.png" />
			</div>
			<div class="right">
				<p>The POPVOX team is very excited to share with you our newest features: widgets that enable you to embed issue-based content and advocacy tools on to your own websites! Together, these widgets will keep your site content fresh and motivate your activists to take action!
				</p>
			</div>
			<div class="clear"> </div>
		</div><!---end of wTop--->
		
		<div class="wBottom">
			<h3>Features Overview</h3>
	
			<div class="left">
				<ul id="wSelect">
				  <li><a href="#" onclick="return splash_tab(this);" tab="commentstream">comment stream</a></li>
				  <li><a href="#" onclick="return splash_tab(this);" tab="writecongress">write congress</a></li>
				</ul>
			</div><!---end of left--->
			
			<div class="right">
				<div tab="commentstream">
				  <p>As you know, messages sent to Congress through POPVOX.com are also public on our site for others to read, and for organizations to help inform their campaigns. With the POPVOX <b>Comment Stream</b>, organizations and blogs can now embed a running stream of comments filtered bill number, position (supporting or opposing), issue area or geographic location.</p>
				  <p><a href="#commentstream">Start using this widget now</a></p>
				</div>
			
				<div tab="writecongress">
					<p>POPVOX&rsquo;s <b>Write Congress</b> widget enables organizations and individuals to embed a powerful advocacy tool onto their own sites. Visitors on your own site can learn about a bill, read your call to action &mdash; and then write a message to their Members of Congress. And since it&rsquo;s powered by POPVOX:</p>
							
					<ul class="bullets">
						<li>constituent information is verified for Congressional offices</li>
						<li>messages from your activists are quantified and aggregated with other messages to show true grassroots power</li>
						<li>activists can be assured that their messages are delivered to Congress, and receive a confirmation when their message is sent.</li>
					</ul>
					
					<p>With a Plus account, the widget integrates into your existing campaign tools.</p>
					
					<p><a href="#writecongress">Start using this widget now</a></p>
				</div>
			</div><!--end of right-->
			<div class="clear"> </div>
		</div><!--end of wbottom-->
		
		<div class="blob">
		  <h3>GET STARTED AND HARNESS THE POWER OF POPVOX ON YOUR SITE</h3>
	
		  <p class="left">The POPVOX widgets are easy to load into any site that allows you to paste HTML code and embed iframes, including WordPress. Click on the tab of the widget you want, complete the information to customize a widget and copy and paste the HTML code onto your own website.</p>
	
		  <p class="right">A basic version of each widget is available at no charge. Organizations that want to fully customize the widgets to fit the look and design of their own sites, or to integrate the widget with other campaign tools, are able to do so for a monthly fee with a Plus account. Please contact Rachna at <a href="mailto:rachna@popvox.com">rachna@popvox.com</a> for details.</p><br />
		  
		  <div class="clear"> </div>
		</div>
	</div><!-- e:splash -->

	<div class="config_pane">
		<p id="widget_description"></p>
	
		<form class="form">
		
			<div class="block2 widget_opts commentstream_opts">
				<div class="vert">
					<label for="commentstream_bills">Related to these bills</label>
					<input id="commentstream_bills" type="text" value="supporting S. 724" class="c2"/>
					<!--<script>$('#commentstream_bills').input_default("supporting H.R. 1234");</script>-->
				</div>
				<div class="vert">
					<p class="or">or</p>
				</div>
				<div class="vert">
					<label for="commentstream_issuearea">Related to this subject</label>
					<select id="commentstream_issuearea" class="c3">
						<option value="">(Select)</option>
						{% for ix in issueareas %}
							<option value="{{ix.id}}">{{ix.name}}</option>
						{% endfor %}
					</select>
				</div>
	
				<div class="clear"> </div>
		
				<div id="commentstream_bills_error" class="error"> </div>
				
				<div class="vert">
					<label for="commentstream_state">Show users in</label>
					<select id="commentstream_state" class="c2">
						<option value="">(All)</option>
						{% for abbr, name in states %}
							<option value="{{abbr}}">{{name}}</option>
						{% endfor %}
					</select>
				</div>
		
				<div class="clear "> </div>
			</div><!-- e: block -->	
			
			<div class="block2 widget_opts writecongress_opts">
				<p>Comments submitted through the widget will be sent to Congress and posted anonymously on POPVOX. Users will create a POPVOX account if they don&rsquo;t already have one. With a Pro account you will have access to the information submitted by users of your widget, and letters to Congress will mention your organization.</p>
				
				<div class="vert" id="writecongress_bill_1">
					<label>Letters are about this bill</label>
					<select id="writecongress_bill_position" size="1" style="width: 400px"></select>
					<div><p><small>You may choose from the bills endorsed or opposed in your legislative agenda which are pending Congressional action<!-- or await reintroduction-->.</small></p></div>
				</div>
				
				<div class="vert" id="writecongress_bill_2">
					<label for="writecongress_bill">Letters are about this bill</label>
					<select id="writecongress_position" size="1" style="width: 10em"><option value="support">supporting</option> <option value="oppose">opposing</option></select>
					<input id="writecongress_bill" type="text" value="S. 724" style="width: 8em"/>
				</div>
				<div class="clear"> </div>
										
				<div id="writecongress_bill_error" class="error"> </div>
			</div><!-- e: block -->
			
			<div class="block3 widget_opts commentstream_opts writecongress_opts">
				<!--<h4>Basic </h4><p class="free">(free)</p>-->
				<h5 class="clear">Widget Dimensions</h5>
				<div class="vert">
					<label for="widget_width">Width (px)</label>
					<input id="widget_width" type="text" value="" class="c2"/>
				</div>
				<div class="vert widget_opts commentstream_opts">
					<label for="widget_height">Height (px)</label>
					<input id="widget_height" type="text" value="" class="c2"/>
				</div>
				<!--
				<div class="vert">
					<p class="or">or</p>
				</div>
				<div class="radio vert">
					<input class="auto" type="radio" name="" value="auto"/>
					<label class="auto" for="auto">Auto</label>
				</div>
				-->
				<div class="vert last">
					<p><small>Widget size does not update in preview.</small></p>
				</div>
				<div class="clear"> </div>
			</div><!-- e: block2 -->
			
			<div class="plus widget_opts commentstream_opts writecongress_opts">
				<h4>PLUS <span class="small"><a href="mailto:info@popvox.com">contact us for details</a></span></h4> <!--<p class="b_upgrade btn"><a href="#">upgrade</a>--></p>
				<div class="clear"> </div>
				
				<div class="panel">
					<h5>Widget Colors</h5>
					
					<div class="vert">
						<input id="color_sbg" type="text" value="#b36015" class="colorpicker"/>
						<label for="color_sbg">shell background</label>
						<script>$('#color_sbg').miniColors(minicolors_opts);</script>
					</div>
					
					<div class="vert">
						<input id="color_sfg" type="text" value="#ffffff" class="colorpicker"/>
						<label for="color_sfg">shell text</label>
						<script>$('#color_sfg').miniColors(minicolors_opts);</script>
					</div>
			
					<div class="vert">
						<input id="color_lnk" type="text" value="#cc6A11" class="colorpicker"/>
						<label for="color_lnk">link</label>
						<script>$('#color_lnk').miniColors(minicolors_opts);</script>
					</div>
					
					<div class="clear"> </div>
			
					<div class="vert">
						<input id="color_bg" type="text" value="#eeeeee" class="colorpicker"/>
						<label for="color_bg">main background</label>
						<script>$('#color_bg').miniColors(minicolors_opts);</script>
					</div>
					
					<div class="vert">
						<input id="color_fg" type="text" value="#404045" class="colorpicker"/>
						<label for="color_fg">main text</label>
						<script>$('#color_fg').miniColors(minicolors_opts);</script>
					</div>
				
				</div><!-- e: panel -->
				<div class="clear"> </div>
				
<!--			<h4>Animation</h4>
		
				<div class="radio">
					<input id="commentstream_scrollmode_scroll" type="radio" name="commentstream_scrollmode" value="scrollbar" checked="1"/>
					<label for="commentstream_scrollmode_scroll">Scrollbar</label>
				</div>
				<div class="radio">
					<input id="commentstream_scrollmode_animate" type="radio" name="commentstream_scrollmode" value="animate"/>
					<label for="commentstream_scrollmode_animate">Animate</label>
				</div>
-->			</div>

				<div class="widget_opts integration_opts">
					<h3>Facebook</h3>
					<p>With a service plan, any POPVOX widget can be embedded into a &ldquo;POPVOX&rdquo; tab on a Facebook Page. Facebook allows you to include a single POPVOX tab with a single widget on your page. To add a POPVOX tab:</p>
					<ul class="bullets">
						<li>Visit the <a href="http://www.facebook.com/apps/application.php?id=150910028257528">POPVOX Facebook App</a> page.</li>
						<li>Click <em>Add to My Page</em> in the lower left list of links.</li>
						<li>Visit your page and click on the new POPVOX tab.</li>
						<li>When prompted, enter your service account secret password <b class="secret_key">xxxx</b>. Do not share this password.</li>
						<li>You&rsquo;ll then return to this page to publish a widget to your Facebook page.</li>
					</ul>
					
					<h3>Salsa and Convio</h3>
					<p>Coming soon.</p>
				</div>
		</form><!-- e: form -->
	</div>
	
	<div class="preview_pane">
		<!--<a class="b_copy_code btn" href="#">Copy Code</a>-->
		<h3 class="no_rule">Preview</h3>

		<div>
			<p>Copy and paste the following HTML code into your website:</p>
			<textarea id="code" rows="4" style="width: 230px; margin-bottom: 15px; padding: 5px;"> </textarea>
		</div>
		
		<div id="fb_page">
			<p><b>Facebook Page:</b> <a href="#" onclick="return set_fb_page_code()">Publish</a> <span style="display: none">Saving...</span></p>
		</div>
		
		<div id="preview">
		</div>
	</div>
</div><!-- e: content -->

{% endblock %}

