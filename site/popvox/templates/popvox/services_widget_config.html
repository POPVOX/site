{% extends "master.html" %}
{% load popvox_utils %}
{% block title %}POPVOX Services: Widgets{% endblock%}
{% block head %}

<link rel="stylesheet" media="screen" type="text/css" href="/media/css/jquery.miniColors.css" />
<script type="text/javascript" src="/media/js/jquery.miniColors.js"></script>

<style>
.form .plus h4 a {
    background: none repeat scroll 0 0 #ACACB0;
    color: #FFFFFF;
    font-family: georgia;
    font-size: 11px;
    font-style: italic;
    margin-top: -3px; 
    margin-left: 10px;
    padding: 2px 5px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    -khtml-border-radius: 3px;
    border-radius: 3px;
}
.form .plus h4 a:hover {
	border-bottom: none;
	background: #b36015;
	}
</style>

<link rel="stylesheet" href="/media/widget/widget.css" type="text/css" media="screen" />

<script>
var accounts = [
	{% for account in accounts %}
	{
		name: "{{account|escapejs}}",
		key: "{{account.api_key|escapejs}}",
		permissions: {% templatetag openbrace %}{% for p in account.permissions.all %}"{{p.name|escapejs}}": true{% if not forloop.last %}, {% endif %}{% endfor %}},
		bill_positions: [{% for p in account.org.positions_can_comment %}
				{% templatetag openbrace %} id: {{p.id}},
				campaign: {% if p.campaign.default %}null{% else %}"{{p.campaign.name|truncatewords:3|escapejs}}"{% endif %},
					position: "{{p.position}}",
					bill: "{{p.bill.title|truncatewords:6|escapejs}}" {% templatetag closebrace %}{% if not forloop.last %},{% endif %}{% endfor %} ]
	}{% if not forloop.last %},{% endif %}
	{% endfor %}
];

var widgettype;

function change_widget(tab) {
	widgettype = tab.getAttribute("widget");
	
	$('ul.tabs li a').removeClass("active");
	$(tab).addClass("active");
	
	$('.widget_opts').hide();
	$('.' + widgettype + '_opts').show();
	$('.config_pane').attr('style', '');
	$('.preview_pane').attr('style', '');
	
	if (widgettype == "commentstream") {
		$('#widget_description').html("The Comment Stream Widget displays the most recent constituent comments left on POPVOX for a given bill or issue area.");
	}

	if (widgettype == "writecongress") {
		$('#widget_description').html("The Write Congress Widget can be placed on your website to power letter-writing calls to action.");
		$('.config_pane').attr('style', 'width: 400px');
		$('.preview_pane').attr('style', 'width: 460px');
	}
	
	update_preview();
	
	return false;
}

function account_changed() {
	var permissions = [];
	
	{% if accounts|length > 0 %}
	var acct_idx = $('#serviceaccount').val();
	if (acct_idx != "")
		permissions = accounts[acct_idx].permissions;
	{% endif %}
		
	plus_enabled = permissions["commentstream_theme"];
	
	if (plus_enabled) $('.plus .panel').removeClass("disabled"); else $('.plus .panel').addClass("disabled");
	$('.plus input').attr("disabled", plus_enabled ? '' : '1')
	$(".miniColors").miniColors('disabled', !plus_enabled);
	
	$('#writecongress_bill_1').hide();
	$('#writecongress_bill_2').show();
	$('#writecongress_bill_position').text('');
	{% if accounts|length > 0 %}
	if (acct_idx != "") {
		$('#writecongress_bill_1').show();
		$('#writecongress_bill_2').hide();
		$('#writecongress_bill_position').text('');
		for (var j = 0; j < accounts[acct_idx].bill_positions.length; j++) {
			var opt = $('<option/>');
			opt.attr('value', accounts[acct_idx].bill_positions[j].id);
			opt.text(
				(accounts[acct_idx].bill_positions[j].campaign ? accounts[acct_idx].bill_positions[j].campaign + ": " : "") 
				+ (accounts[acct_idx].bill_positions[j].position == "+" ? "Support " : "Oppose ")
				+ accounts[acct_idx].bill_positions[j].bill
				);
			$('#writecongress_bill_position').append(opt);
		}
	}
	{% endif %}
	
	update_preview();
}

var last_preview_html = "";

function update_preview() {
	var opts = "";
	var default_width;
	var default_height;
	var can_change_height = true;
	
	if (widgettype == "commentstream") {
		var bills = [];
		if (!$('#commentstream_bills').hasClass("default")) bills = $('#commentstream_bills').val().split(/,\s*/);
		if (bills[0] == "") bills = [];
		$('#commentstream_bills_error').hide();
		for (var i = 0; i < bills.length; i++) {
			var bill_re = /^(supporting|opposing)?(HR|S|HRES|SRES|HJRES|SJRES|HCONRES|SCONRES)(\d+)(\/(\d+))?$/i;
			var match = bill_re.exec(bills[i].replace(/\s/g, "").replace(/\./g, ""));
			if (!match) {
				$('#commentstream_bills_error').text("I didn't understand <" + bills[i] + ">. Example bill numbers are H.R. 1, S. 2, H.Res. 3, etc. Precede a bill number with \"supporting\" or \"opposing\" to show only show supporting or opposing comments. Separate multiple bills with commas.");
				$('#commentstream_bills_error').show();
				return;
			}
			
			var support_oppose = match[1];
			var billtype = match[2].replace(/\s/g, "").replace(/\./g, "").toLowerCase();
			var billnumber = match[3];
			var congressnumber = match[5]; // possibly undefined, GovTrack style prev congress search
			if (!congressnumber) congressnumber = {{current_congress}};
			
			bills[i] = "us/" + congressnumber + "/" + billtype + billnumber + (support_oppose ? ":" + support_oppose : "");
		}
		if (bills.length > 0) opts += "&bills=" + bills;
		
		var ix = $('#commentstream_issuearea').val();
		if (ix) opts += "&issue=" + ix;
		
		var state = $('#commentstream_state').val();
		if (state) opts += "&state=" + state;
		
		default_width = 240;
		default_height = 350;
	}
	
	if (widgettype == "writecongress") {
		var acct_idx = "";
		{% if accounts|length > 0 %}
		acct_idx = $('#serviceaccount').val();
		{% endif %}
		
		if (acct_idx == "") {
			$('#writecongress_bill_error').hide();
			var bill_re = /^(HR|S|HRES|SRES|HJRES|SJRES|HCONRES|SCONRES)(\d+)(\/(\d+))?$/i;
			var match = bill_re.exec($('#writecongress_bill').val().replace(/\s/g, "").replace(/\./g, ""));
			if (!match) {
				$('#writecongress_bill_error').text("Example bill numbers are H.R. 1, S. 2, H.Res. 3, etc.");
				$('#writecongress_bill_error').show();
				return;
			}
			
			var support_oppose = match[0];
			var billtype = match[1].replace(/\s/g, "").replace(/\./g, "").toLowerCase();
			var billnumber = match[2];
			var congressnumber = match[4]; // possibly undefined, GovTrack style prev congress search
			if (!congressnumber) congressnumber = {{current_congress}};
			
			bill = "us/" + congressnumber + "/" + billtype + billnumber;
			
			opts += "&bill=" + bill;
			opts += "&position=" + $('#writecongress_position').val();
		} else {
			opts += "&ocp=" + $('#writecongress_bill_position').val();
		}
		
		default_width = 460;
		default_height = 773;
		can_change_height = false;
	}
	
	{% if user.is_staff %}opts += "&debug=1";{% endif %}
	
	var width = $('#widget_width').val() || default_width;
	var height = (can_change_height && $('#widget_height').val()) || default_height;
	
	var account = "";
	
	{% if accounts|length > 0 %}
	if ($('#serviceaccount').val() != "") {
		// Only apply these configuration options if they are permitted.
		var clrs = ["sbg", "sfg", "lnk", "bg", "fg"];
		for (var e in clrs)
			opts += "&" + clrs[e] + "=" + $('#color_' + clrs[e]).val().replace("#", "");
		
		/*if ($('#commentstream_scrollmode_scroll')[0].checked)
			opts += "&scroll=bar";
		else
			opts += "&scroll=animate";*/
		
		account = accounts[$('#serviceaccount').val()].key
	}
	{% endif %}
		
	function make_code(host, width, height, demo) {
		return '<iframe src="' + host + '/services/widgets/w/' + widgettype + '?iframe=1' + (account ? "&api_key=" + account : "") + opts + (demo ? "&demo=1" : "") + '" width="' + width + '" height="' + height + '" border="0" frameBorder="0"> </iframe>';
	}

	var prv = make_code("", default_width, default_height, true);
	if (last_preview_html != prv) $('#preview').html(prv);
	last_preview_html = prv;

	$('#code').val(make_code("https://www.popvox.com", width, height, false));
}

$(function() {
	$('.form input[type=text]').keyup_delayed(function() { update_preview(); });
	$('.form select').change(function() { update_preview(); });
	$('.form input[type=radio]').click(function() { update_preview(); });
	change_widget($('ul.tabs li a')[0]);
	account_changed();
});

var minicolors_opts = {
	change: function(hex, rgb) {
		$('#color_sbg').keyup(); // trigger delayed update of preview
	}
};
</script>
{% endblock %}
{% block content %}
<div class="content widgetizer">

	<h1>POPVOX Widgets</h1>

	{% if accounts|length > 0 %}
	{% comment %}This goes outside of the form so that the select doesn't trigger a preview update.{% endcomment %}

	<div class="block1">
		<label for="serviceaccount">Service Account:</label>
		<select id="serviceaccount" onchange="account_changed()">
			<option value="">- Free Services Only -</option>
			{% for account in accounts %}
				<option value="{{forloop.counter0}}" {% if forloop.first %}selected="1"{% endif %}>{{account}}</option>
			{% endfor %}
		</select>
	</div>
	{% endif %}
	
	<ul class="tabs">
		<li><a href="#" onclick="return change_widget(this);" widget="writecongress">Write Congress</a></li>
		<li><a href="#" onclick="return change_widget(this);" widget="commentstream">Comment Stream</a></li>
	</ul>
	
	<div class="config_pane">
		<p id="widget_description"></p>
	
		<form class="form">
		
			<div class="block2 widget_opts commentstream_opts">
				<div class="vert">
					<label for="commentstream_bills">Related to these bills</label>
					<input id="commentstream_bills" type="text" value="supporting S. 724" class="c2"/>
					<!--<script>$('#commentstream_bills').input_default("supporting H.R. 1234");</script>-->
				</div>
				<div class="vert">
					<p class="or">or</p>
				</div>
				<div class="vert">
					<label for="commentstream_issuearea">Related to this subject</label>
					<select id="commentstream_issuearea" class="c3">
						<option value="">(All)</option>
						{% for ix in issueareas %}
							<option value="{{ix.id}}">{{ix.name}}</option>
						{% endfor %}
					</select>
				</div>
	
				<div class="clear"> </div>
		
				<div id="commentstream_bills_error" class="error"> </div>
				
				<div class="vert">
					<label for="commentstream_state">Show users in</label>
					<select id="commentstream_state" class="c2">
						<option value="">(All)</option>
						{% for abbr, name in states %}
							<option value="{{abbr}}">{{name}}</option>
						{% endfor %}
					</select>
				</div>
		
				<div class="clear "> </div>
			</div><!-- e: block -->	
			
			<div class="block2 widget_opts writecongress_opts">
				<div class="vert" id="writecongress_bill_1">
					<label>Letters are about this bill</label>
					<select id="writecongress_bill_position" size="1" style="width: 400px"></select>
					<div><p><small>(You may choose from the bills endorsed or opposed in your legislative agenda which are pending Congressional action or await reintroduction.)</small></p></div>
				</div>
				
				<div class="vert" id="writecongress_bill_2">
					<label for="writecongress_bill">Letters are about this bill</label>
					<select id="writecongress_position" size="1" style="width: 10em"><option value="support">supporting</option> <option value="oppose">opposing</option></select>
					<input id="writecongress_bill" type="text" value="S. 724" style="width: 8em"/>
				</div>
	
				<div class="clear"> </div>
		
				<div id="writecongress_bill_error" class="error"> </div>
			</div><!-- e: block -->	

			<div class="block3">
				<!--<h4>Basic </h4><p class="free">(free)</p>-->
				<h5 class="clear">Widget Dimensions</h5>
				<div class="vert">
					<label for="widget_width">Width (px)</label>
					<input id="widget_width" type="text" value="" class="c2"/>
				</div>
				<div class="vert widget_opts commentstream_opts">
					<label for="widget_height">Height (px)</label>
					<input id="widget_height" type="text" value="" class="c2"/>
				</div>
				<!--
				<div class="vert">
					<p class="or">or</p>
				</div>
				<div class="radio vert">
					<input class="auto" type="radio" name="" value="auto"/>
					<label class="auto" for="auto">Auto</label>
				</div>
				-->
				<div class="vert last">
					<p><small>Widget size does not update in preview.</small></p>
				</div>
				<div class="clear"> </div>
			</div><!-- e: block2 -->
			
			<div class="plus">
				<h4>PLUS <span class="small"><a href="mailto:info@popvox.com">contact us for details</a></span></h4> <!--<p class="b_upgrade btn"><a href="#">upgrade</a>--></p>
				<div class="clear"> </div>
				
				<div class="panel">
					<h5>Widget Colors</h5>
					
					<div class="vert">
						<input id="color_sbg" type="text" value="#b36015" class="colorpicker"/>
						<label for="color_sbg">shell background</label>
						<script>$('#color_sbg').miniColors(minicolors_opts);</script>
					</div>
					
					<div class="vert">
						<input id="color_sfg" type="text" value="#ffffff" class="colorpicker"/>
						<label for="color_sfg">shell text</label>
						<script>$('#color_sfg').miniColors(minicolors_opts);</script>
					</div>
			
					<div class="vert">
						<input id="color_lnk" type="text" value="#cc6A11" class="colorpicker"/>
						<label for="color_lnk">link</label>
						<script>$('#color_lnk').miniColors(minicolors_opts);</script>
					</div>
					
					<div class="clear"> </div>
			
					<div class="vert">
						<input id="color_bg" type="text" value="#eeeeee" class="colorpicker"/>
						<label for="color_bg">main background</label>
						<script>$('#color_bg').miniColors(minicolors_opts);</script>
					</div>
					
					<div class="vert">
						<input id="color_fg" type="text" value="#404045" class="colorpicker"/>
						<label for="color_fg">main text</label>
						<script>$('#color_fg').miniColors(minicolors_opts);</script>
					</div>
				
				</div><!-- e: panel -->
				<div class="clear"> </div>
				
<!--			<h4>Animation</h4>
		
				<div class="radio">
					<input id="commentstream_scrollmode_scroll" type="radio" name="commentstream_scrollmode" value="scrollbar" checked="1"/>
					<label for="commentstream_scrollmode_scroll">Scrollbar</label>
				</div>
				<div class="radio">
					<input id="commentstream_scrollmode_animate" type="radio" name="commentstream_scrollmode" value="animate"/>
					<label for="commentstream_scrollmode_animate">Animate</label>
				</div>
-->			</div>
		</form><!-- e: form -->
	</div>
	
	<div class="preview_pane">
		<h3 class="no_rule">Preview</h3>

		<p>Copy and paste the following HTML code into your website:</p>
		<textarea id="code" rows="4" style="width: 100%; margin-bottom: 15px;"> </textarea>
		
		<div id="preview">
		</div>
	</div>
</div><!-- e: content -->

{% endblock %}

