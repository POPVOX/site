{% extends "master.html" %}
{% load popvox_utils %}
{% block title %}Finish Comment on {{ bill.title }}{% endblock%}
{%block nav_citzen_class_bills%}active{%endblock%}
{% block head %}
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script type="text/javascript">
		function createDistrictsOverlay(outlines_only, opacity, state, district) {
			return {
			  getTileUrl: function(coord, zoom) 
			  {
				  return "http://www.govtrack.us/perl/wms/wms.cgi?google_tile_template_values=" + coord.x + "," + coord.y + "," + zoom
				  	+ "&LAYERS=cd-110" + (outlines_only ? "-outlines" : "")
					+ (state ? ":http://www.rdfabout.com/rdf/usgov/geo/us/" + state
						+ (!district ? "%25"
							: "/cd/110/" + district)
						: "")
					+ "&FORMAT=image/png";	
			  },
			  tileSize: new google.maps.Size(256, 256),
			  minZoom: 2,
			  maxZoom: 28,
			  opacity: opacity,
			  isPng: true
			};		
		}
		
		var map;
		
		function initialize() {
			var myOptions = {
				zoom: 4,
				center: new google.maps.LatLng(38, -96),
				mapTypeId: google.maps.MapTypeId.ROADMAP,
				panControl: false,
				zoomControl: true,
				mapTypeControl: false,
				scaleControl: true,
				streetViewControl: false
				};
			
			{% if bounds %}
				myOptions.zoom = {{bounds.2}};
				myOptions.center = new google.maps.LatLng({{bounds.1}}, {{bounds.0}});
			{% endif %}
			
			map = new google.maps.Map(document.getElementById("map_canvas"),
			myOptions);
			
			overlayWMS = new google.maps.ImageMapType(createDistrictsOverlay(false, .2, "{{useraddress.state|escapejs}}", null));
			map.overlayMapTypes.insertAt(0, overlayWMS);			

			overlayWMS = new google.maps.ImageMapType(createDistrictsOverlay(true, .7, "{{useraddress.state|escapejs}}", null));
			map.overlayMapTypes.insertAt(0, overlayWMS);
			
			var marker = new google.maps.Marker({
				  position: myOptions.center, 
				  map: map, 
				  title: "Drag me to your home.",
				  draggable: true,
				  animation: google.maps.Animation.BOUNCE,
			  }); 
			
			google.maps.event.addListener(map, 'mousemove', function() { marker.setAnimation(null); } );
			
			google.maps.event.addListener(marker, 'position_changed', function() {
					$('#submitcomment, #finishedhelp').fadeIn();
					$('#form_latitude').val(marker.getPosition().lat());
					$('#form_longitude').val(marker.getPosition().lng());
			} );
		};
		
		$(initialize);
	</script>
{% endblock %}
{% block content %}
<div class="content">

	{% with "address" as billcomment_progress_step %}
	{% include "popvox/billcomment_progress.html" %}
	{% endwith %}

	<div class="tab_pane">
	
	<form method="post" id="commentform">
	
	{% csrf_token %}
	<input id="submitmode" type="hidden" name="submitmode" value="Submit Comment >"/>
	<input type="hidden" name="message" value="{% if message %}{{message}}{% endif %}"/>
	<input id="form_latitude" type="hidden" name="latitude" value=""/>
	<input id="form_longitude" type="hidden" name="longitude" value=""/>
	
	<h1>Find Your Congressional District</h1>
	
		<div class="col_3">
			<h3 style="margin-top: 0">You Entered</h3>
			<div>{{useraddress.prefix}} {{useraddress.firstname}} {{useraddress.lastname}} {% if useraddress.suffix %}, {{useraddress.suffix}}{% endif %}</div>
			<div>{{useraddress.address1}}</div>
			<div>{{useraddress.address2}}</div>
			<div>{{useraddress.city}}, {{useraddress.state}} {{useraddress.zipcode}}</div>
			<div>{{useraddress.phonenumber}}</div>
			
			<h3>Find Your Location</h3>
			<p>Drag the marker in the map as close to your home as possible. You may need to zoom in as you get closer.</p>
			
			<p class="mar_top pad_btm">
				<input class="b_back btn" type="button" value="< Go Back" onclick="submitform('< Go Back')"/>
				<input class="b_finished btn" id="submitcomment" type="submit" value="Comment >" style="display: none"/>
			</p>

			<p id="finishedhelp">When you have moved the marker to your home, click Finished.</p>
		</div>
		
		<div id="map_canvas" class="col_3_last" style="height: 400px; border: 1px solid black"> </div>
	
		<div style="display: none">
			{% include "popvox/address_form.html" %}
			{% comment %}to re-submit the address info{% endcomment %}
		</div>
	</form>
	
	<script>
	function submitform(mode) {
		$('#submitmode').val(mode);
		$('#commentform').submit();
	}
	</script>
	
	</div>
	
</div>
{% endblock %}

