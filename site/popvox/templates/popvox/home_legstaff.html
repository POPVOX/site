{% extends "master.html" %}
{% load popvox_utils %}
{% block title %}Home{% endblock%}
{%block nav_legstaff_class_dashboard%}active{%endblock%}
{% block adunits %}{% include "ads/rightbar_head.html" %}{% endblock %}
{% block head %}
<script type="text/javascript" src="/media/js/highcharts.js"></script>
<script type="text/javascript" src="/media/js/charts.js"></script>
<script>
	function showtab(tab) {
		if ($('#' + tab + '_tab').hasClass('active')) return false;

		if (tab == "tracked" && tracked_bills_changed) {
			window.location = '/home';
			return true;
		} else if (tab == "hidden" && antitracked_bills_added) {
			window.location = '/home#' + tab;
			window.location.reload();
			return true;
		} else if (tab != "tracked" && tab != "hidden" && antitracked_bills_removed) {
			window.location = '/home#' + tab;
			window.location.reload();
			return false;
		}
		
		$('.tab_panel').hide();
		$('.horz_tabs li').removeClass('active');
		$('#' + tab + "_panel").fadeIn();
		$('#' + tab + '_tab').addClass('active')
		return false; // cancel click
	}

	function addRemoveIssueArea(add_remove, id, statuslabelid, callback) {
		ajax(
			"/ajax/accounts/profile/updatefield",
			{ name: "issue-" + add_remove, value: id},
			{
				success: function() {
					callback(issuearea_list);
					$('#issuearealist').html("");
					for (var ix in issuearea_list) {
						var n = $("<li></li>");
						$(n).text(issuearea_list[ix][1]);
						$('#issuearealist').append(n);
					}
				},
			}
		);
	}
	var issuearea_list = [{% for issue in user.userprofile.issues.all %}[{{issue.id}}, "{{issue.name|escapejs}}"],{% endfor %}];						

	var last_expando = null;
	function expando(billid) {
		if (last_expando) {
			$('#bill_' + last_expando + '_details').hide();
			$('#bill_' + last_expando + '_expando').removeClass("active");
			$('#bill_' + last_expando + '_row1').removeClass("active");
			$('#bill_' + last_expando + '_row2').removeClass("active");
		}
		if (last_expando == billid) {
			last_expando = null;
			return false;
		}
		$('#bill_' + billid + '_details').fadeIn();
		$('#bill_' + billid + '_expando').addClass("active");
		$('#bill_' + billid + '_row1').addClass("active");
		$('#bill_' + billid + '_row2').addClass("active");
		last_expando = billid;
		return false; // cancel click
	}
	
	{% if districtstr %}
	function show_activity() {
		$('#activityloadingstatus').text("Loading...");
		$.ajax({
			type:"POST",
			url: "/ajax/activity",
			data: {
				default_district: 1,
			},
			complete: function(res, status) {
				$('#activityloadingstatus').text("");
				
				if (status != "success") {
					$('#activityloadingstatus').text("Error loading report.");
					return;
				}
				
				$('#activity').html(res.responseText);
			}
		});
	}
	$(show_activity);
	{% endif %}
	
	{% include "popvox/track.js" %}
</script>
{% endblock %}
{% block content %}
	<div class="float_right">
		{% include "ads/rightbar.html" %}
	</div>

<div class="content leg_staff">

	<h1>Home</h1>
	
	
	<div class="col_9">
		<ul class="horz_tabs">
			{% comment %}If the set of tracked bills has changed, then reload the page when user clicks the tracked bills tab. We're dynamically updating the other suggestions tab so no need to reload those.{% endcomment %}
			<li class="active" id="tracked_tab"><a href="/home" onclick="return showtab('tracked')">Tracked</a></li>
			
			{% if districtstr %}
			<li id="districtbills_tab"><a href="#" onclick="return showtab('districtbills')">Hot <!--In Your {{districtstr}}--></a></li>
	
			<li id="districtcomments_tab"><a href="#" onclick="return showtab('districtcomments')">Comments<!-- In Your {{districtstr}}--></a></li>
			{% endif %}
	
			<li id="suggestions_tab"><a href="#" onclick="return showtab('suggestions')">Suggest</a></li>
			
			{% for group in suggestions %}
				<li id="{{group.id}}_tab"><a href="#" onclick="return showtab('{{group.id}}')">{{group.shortname}} ({{group.count}})</a></li>
			{% endfor %}
		
			<li id="hidden_tab"><a href="#" onclick="return showtab('hidden');">Hidden</a></li>
			
			<div class="clear"> </div>
			
			<script>$(function() {
				if (window.location.hash != "") {
					showtab(window.location.hash.substring(1));
					window.location.hash = "";
				}
			});</script>
		</ul>

		<div id="tracked_panel" class="tab_panel">
			<h3>Tracked Legislation</h3>
			
			{% for bill in tracked_bills %}
				<div style="clear: both">
					<h4><a href="{{bill.url}}">{{bill.title|truncatewords:10}}</a></h4>
					
					{% bill_statistics bill as stats %}
					{% if stats %}
						<a href="{{bill.url}}/report">
							<div id="chart-container--{{bill.id}}" class="img_chart" style="width: 75px; height: 75px"></div>
						</a>
						<script>bill_chart("chart-container--{{bill.id}}", {{stats.pro_pct}}, {{stats.con_pct}}, { small: true });</script>
						
						<div class="chart_info">
							<div class="col_chart">
								<p class="chart_stats">
									<span class="chart_title">{{stats.longdescription}}:</span><br />
									<span class="bg_support">{{stats.pro_pct}}% Support</span><br />
									<span class="bg_oppose">{{stats.con_pct}}% Oppose </span><br />
									<span class="users">({{stats.total}} users)</span>
								</p>
							 </div>
							 <div class="col_2 col_last">
								 <p class="view_report">
									<span><a href="{{bill.url}}/report">View Report</a></span>
									<strong>Status:</strong><br />
									<em>{{bill.status_advanced}}</em><br />
								</p>
							</div>
						</div>
					{% else %}
						<p>Not enough users have commented on this bill to display statistics.</p>
					{% endif %}
				</div>
				<div class="hr"> </div>
			{% empty %}
				<p>You have no tracked legislation. Check your suggestions or try changing your <a href="#" onclick="return showtab('suggestions')">suggestions settings</a>.</p>
			{% endfor %}
		</div>
		
		{% for group in suggestions %}
			<div id="{{group.id}}_panel" class="tab_panel" style="display: none">
				<h2>{{group.name}}</h2>

				<table width="100%">
				{% comment %}
				<thead>
					<tr>
						<th colspan="2">Bill</th>
						<th>Sponsor</th>
						<th># Co</th>
						<th>Status</th>
						<th></th>
					</tr>
				</thead>
				{% endcomment %}
				
				{% for subgroup in group.subgroups %}
					<tr>
						<td colspan="5">
							<h4>{{subgroup.name}}</h4>
						</td>
					</tr>
					{% for bill in subgroup.bills %}
						<tr id="bill_{{subgroup.id}}_{{bill.id}}_row1" class="bill {% if not forloop.first %}border{% endif %}" billid="{{bill.id}}" valign="top">
							<td style="padding-left: 5px; padding-right: 1em">
								<nobr><a href="{{bill.url}}">
									{{bill.displaynumber}}
								</a></nobr>
							</td>
							<td style="padding-right: 1em";>
								<div style="width: 190px; overflow: hidden; " title="{{bill.title}}">
									<div style="width: 1000px; height: 1.2em;">
										<a href="{{bill.url}}">
											{{bill.title_no_number}}
										</a>
									</div>
								</div>
							</td>
							<td style="padding-right: 1em;">
								<div style="width: 75px; overflow: hidden;" title="{{bill.sponsor.name}}">
									<div style="width: 1000px; height: 1.2em;">
										{{bill.sponsor.lastname}}
									</div>
								</div>
							</td>
							<td style="padding-right: 1em" title="{{bill.num_cosponsors}} cosponsor{{bill.num_cosponsors|pluralize}}">
								{{bill.num_cosponsors}}
							</td>
							<td style="padding-right: 1em;">
								<div style="width: 140px; overflow: hidden;" title="{{bill.status_advanced}}">
									<div style="width: 1000px; height: 1.2em;">
										<a href="#" onclick="return expando('{{subgroup.id}}_{{bill.id}}')">
											{{bill.status_advanced}}
										</a>
									</div>
								</div>
							</td>
							<td>
								{% with "+" as tracktype %}
								{% include "popvox/track.html" %}
								{% endwith %}
								
								{% with "-" as tracktype %}
								{% include "popvox/track.html" %}
								{% endwith %}
								
								<div id="bill_{{subgroup.id}}_{{bill.id}}_expando" class="expand" onclick="expando('{{subgroup.id}}_{{bill.id}}')">Expand/Collapse</div>
							</td>
						</tr>
						<tr id="bill_{{subgroup.id}}_{{bill.id}}_row2" class="billdetails">
							<td id="bill_{{subgroup.id}}_{{bill.id}}_details" colspan="6" style="display: none; padding: 1em">
								<p>{{bill.status_advanced}}</p>
								{% for date, text in bill.latest_action_formatted %}
									{% if date %}
									<div>{{date}}: {{text}}</div>
									{% endif %}
								{% endfor %}
							</td>
						</tr>
					{% endfor %}
				{% endfor %}
				</table>
			</div>
			
		{% endfor %}
		
		<div id="suggestions_panel" class="tab_panel" style="display: none">
			<h2>Suggestions Settings</h2>
			<p>Your tracked legsiatlion shows the status of bills you select. We&rsquo;ll come up with a list of suggestions for you to track based on your <a href="/accounts/profile">account settings</a> and will display those suggestions in tabs on the left.</p>
			{% if suggestions|length == 0 %}<p>Right now you don&rsquo;t have any suggestions.</p>{% endif %}
			
			<h3>Interest Areas</h3>
			<p>Customize your suggestions by choosing interest areas from the list of Congressional Research Service Legislative Indexing Vocabulary:</p>
			<ul id="issuearealist" class="bullets">
				{% for ix in user.userprofile.issues.all %}
					<li>{{ ix.name }}</li>
				{% endfor %}
			</ul>
			<ul class="bullets">
				<li><a href="#" onclick="return showIssueAreaChooser(issuearea_list, function () { window.location.reload() });">Add{% if user.userprofile.issues.all %}/Remove{% endif %} Issue Areas</a></li>
			</ul>
			
			{% include "popvox/issueareachooser.html" %}	
			
			<p>We will be adding more here in the future.</p>
		</div>

		{% if districtstr %}
			<div id="districtbills_panel" class="tab_panel block your_feed" style="display: none">
				<h3>Hot In Your {{districtstr}}:</h3>
				
				{% for bill in district_bills %}
					<div>
						<h4><a href="{{bill.url}}">{{bill.title|truncatewords:10}}</a></h4>
						
						{% bill_statistics bill as stats local %}
						{% if stats %}
						<div class="col_chart">
							<a href="{{bill.url}}/report">
								<div id="chart-container-district--{{bill.id}}" class="img_chart" style="width: 60px; height: 60px"></div>
							</a>
							<script>bill_chart("chart-container-district--{{bill.id}}", {{stats.pro_pct}}, {{stats.con_pct}}, { small: true });</script>
						</div>
						<div class="chart_info">
							<p class="chart_stats">
								<span class="bg_support">{{stats.pro_pct}}% Support</span><br />
								<span class="bg_oppose">{{stats.con_pct}}% Oppose </span><br />
								<span class="users">({{stats.total}} constituents)</span>
							</p>
						 </div>
						 <p class="view_report">
							<span><a href="{{bill.url}}/report">View Report</a></span>
							<br />
							<em>{{bill.status_advanced}}</em><br />
						</p>
						{% endif %}
					</div>
					<div class="hr"> </div>
				{% empty %}
					<p>There are no bills with high comment activity in your {{districtstr|lower}}.</p>
				{% endfor %}
				
			</div>
			
			<div id="districtcomments_panel" class="tab_panel block your_feed" style="display: none">
				<h3>Recent Comments In Your {{districtstr}}:</h3>
				
				<div id="activityloadingstatus"></div>
				
				<div id="activity"></div>
			</div>
		{% endif %}
		
		<div id="hidden_panel" class="tab_panel" style="display: none">
			<h2>Bills You&rsquo;ve Hidden</h2>

			<table width="100%">
		
			<tr>
				<td colspan="5">
					<h4>{{subgroup.name}}</h4>
				</td>
			</tr>
			{% for bill in antitracked_bills %}
				<tr class="bill {% if not forloop.first %}border{% endif %}">
					<td style="padding-left: 5px; padding-right: 1em">
						<nobr><a href="{{bill.url}}">
							{{bill.displaynumber}}
						</a></nobr>
					</td>
					<td style="padding-right: 1em";>
						<div style="width: 400px; overflow: hidden; " title="{{bill.title}}">
							<div style="width: 1000px; height: 1em;">
								<a href="{{bill.url}}">
									{{bill.title_no_number}}
								</a>
							</div>
						</div>
					</td>
					<td style="padding-right: 1em;">
						<div style="width: 75px; overflow: hidden;" title="{{bill.sponsor.name}}">
							<div style="width: 1000px; height: 1em;">
								{{bill.sponsor.lastname}}
							</div>
						</div>
					</td>
					<td>
						{% with "+" as tracktype %}
						{% include "popvox/track.html" %}
						{% endwith %}
						
						{% with "-" as tracktype %}
						{% include "popvox/track.html" %}
						{% endwith %}
					</td>
				</tr>
			{% endfor %}
			</table>
		</div>
	</div>

</div>
{% endblock %}

